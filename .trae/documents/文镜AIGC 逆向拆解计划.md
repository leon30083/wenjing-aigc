## 范围与目标
- 核心对象：`文镜AIGC.exe`（桌面主程序）。
- 组件纳入：Chrome 扩展 `doubao` 与本地 ComfyUI（`127.0.0.1:8188`）。
- 目标：完整恢复系统架构、数据/控制流与协议契约，形成证据化报告与可运行的最小复现（不含敏感密钥）。

## 总体方法
- 静态 + 动态双轨：对二进制/脚本进行静态反汇编与资源抽取；在隔离环境进行进程、文件系统与网络行为的动态取证。
- 组件耦合画像：建立主程序 ⇄ 扩展 ⇄ 本地服务 ⇄ 媒体管线 ⇄ 外部 API 的端到端时序图。

## 执行阶段

### 阶段一：资产与指纹
- 资产盘点：二进制（`文镜AIGC.exe`、`ffmpeg.exe`）、脚本（`doubao/*`）、数据库（`aigc.sqlite`）、日志（`log/*`）、HTTP记录（`http/*`）、媒体（`video/*`、`audio/*`、`base/*`、`role/*`）。
- 指纹识别：判定 `文镜AIGC.exe` 的技术栈（Electron/.NET/原生）；检查壳与打包资源（如 `app.asar`）。
- 产出：目录结构图与二进制类型判定报告。

### 阶段二：`文镜AIGC.exe` 静态分析
- 壳/压缩检测：UPX/DIE/capa。
- 反编译路径：
  - 若 Electron：解包 `asar`、还原前端/后端 JS 并提取配置。
  - 若 .NET：IL 反编译，构建命名空间/类/方法调用图。
  - 若原生：Ghidra/IDA 建立函数图、交叉引用与关键字符串表。
- 资源与字符串：提取端口、URL、路由、日志标识与配置键。
- 产出：模块/调用关系图、关键字符串与资源清单。

### 阶段三：动态行为取证（隔离环境）
- 进程树：观察 `文镜AIGC.exe` 子进程（尤其 `ffmpeg.exe`）、模块加载。
- 文件系统：捕获对 `log/*`、`http/*`、`video/*`、`audio/*`、`aigc.sqlite` 的读写时序。
- 网络：
  - 本地端口：`localhost:9000`（扩展通信）、`127.0.0.1:8188`（ComfyUI）。
  - 外部：如 `api.siliconflow.cn`；对抓包进行脱敏与协议重建。
- UI驱动：执行典型操作路径，触发媒体生成与角色编排，记录所有调用。
- 产出：时序图、抓包解析与行为证据。

### 阶段四：数据库与媒体管线
- SQLite：导出 `aigc.sqlite` schema、字段语义、索引与表用途；样本数据做脱敏映射。
- 媒体：复原 `ffmpeg` 调用参数与生成流程；分析 `video/*`、`audio/*` 命名约定与依赖关系。
- 产出：数据库字典、媒体生成流程图与参数表。

### 阶段五：Chrome 扩展 `doubao` 逆向
- 结构与权限：`manifest.json:15-20` 注入到 `doubao.com`、`kimi.com`；权限 `storage`/`tabs`。
- 行为：`background.js:21-26` 消息触发关闭最近标签；`background.js:27-30` 初始化存储；`comm.js:91-139` 通过 `ServerGet/ServerSet` 与本地服务交互。
- 解混淆：还原 `script.js`（`jsjiami.com.v5`）核心控制流与选择器/事件。
- 动态验证：DevTools 观察注入、网络与存储，归纳与主程序的契约。
- 产出：扩展功能图、事件—动作映射、服务契约文档。

### 阶段六：ComfyUI 协议与工作流
- 路由与负载：基于 `http/*`（如 `127.0.0.1_8188_prompt.txt`）的 `prompt` JSON，重建节点图与参数；采集 `object_info_*` 节点说明形成词典。
- 工作流复原：识别图像加载、背景移除、采样/解码、预览等链路；若 GPU 不可用，采用 CPU/远程推理验证流程。
- 产出：ComfyUI 工作流图、节点参数表与调用契约。

### 阶段七：架构复原与最小复现（MVP）
- 架构图：主程序 ⇄ 扩展 ⇄ 本地服务 ⇄ ComfyUI ⇄ `ffmpeg` ⇄ 外部 AI 的拓扑与数据流。
- MVP：以最小服务模拟 `localhost:9000` 接口，与 ComfyUI `prompt` 交互并经 `ffmpeg` 合成一个示例媒体；全部脱敏、无需真实密钥。
- 产出：可运行的验证脚本与说明。

### 阶段八：自动化与交付
- 自动化采集：批量 strings/资源/抓包/日志聚合为统一报告。
- 交付物：
  - 架构与数据流图、功能映射表。
  - 接口规范（本地/ComfyUI/外部）。
  - 数据库字典与媒体管线参数。
  - 动态证据包（时间线/截图）。
  - 最小复现脚本（无密钥）。

## 工具清单（含 MCP）
- 二进制：Ghidra/IDA、Detect It Easy、capa、Resource Hacker。
- Electron/.NET：asar 解包、dnSpy/ILSpy。
- 动态：Process Explorer、Procmon、Wireshark/Fiddler、Frida（必要时）。
- 数据库/媒体：SQLite 工具、`ffmpeg` 参数探测。
- MCP：浏览器 DevTools 系列（快照/网络/控制台/脚本评估）用于扩展行为取证与契约验证。

## 风险与对策
- 打包与混淆：脚本/二进制强混淆时采用多工具与动态配合分层突破。
- GPU不兼容：优先 CPU/远程推理；将 GPU 路径作为可选加速，不做刚性依赖。
- 敏感信息：全面脱敏，示例使用假值或空值。

## 下一步
- 按上述计划依序执行，并在关键节点（指纹判定、协议还原、MVP完成）提交阶段报告与证据。您确认后我立即开始实施。