# 动画绘本提示词优化功能 - 实施计划

**版本**: v2.0
**创建日期**: 2026-01-05
**基于**: 用户反馈 + DeepSeek API 集成

---

## 📋 项目背景

### 用户需求
- **目标**: 将简单的绘本旁白优化成详细的 Sora 2 视频提示词
- **场景**: 动画绘本制作（旁白 → 视频）
- **输入**: 简单的绘本旁白（口语化、拟人化）
- **输出**: 符合 Sora 2 格式的详细提示词

### 核心问题
1. **画面自然度与旁白匹配**
   - 绘本旁白很简单（2-3秒内容）
   - Sora 2 视频固定时长（10s、15s）
   - 需要在保持故事核心的同时，让视频足够丰富

2. **避免模板化**
   - 之前的实现"太呆板、千篇一律"
   - 用户担心质量问题

### 技术方案
- **API 集成**: 使用 OpenAI 格式 API（DeepSeek）
- **用户配置**: 支持 base_url、api_key、model 自定义
- **智能扩展**: 三层扩展模型（核心层 + 丰富层 + 动态层）

---

## 🎯 核心设计原则

### 三层扩展模型

```
┌─────────────────────────────────────────────────┐
│              三层扩展模型                        │
├─────────────────────────────────────────────────┤
│                                                  │
│  Layer 1: 核心层 (30%)                          │
│  - 来源: 绘本旁白原文                           │
│  - 作用: 保持故事主线，不偏离核心                │
│  - 示例: "它装满了沙土"                          │
│                                                  │
│  Layer 2: 丰富层 (40%)                          │
│  - 来源: 智能规则扩展                           │
│  - 作用: 添加细节、环境、氛围                    │
│  - 示例: "铲斗微微下沉，阳光洒落"                 │
│                                                  │
│  Layer 3: 动态层 (30%)                          │
│  - 来源: AI 自然生成                             │
│  - 作用: 让 Sora 自主添加微动作                  │
│  - 示例: (不指定具体动作，让 AI 发挥)           │
│                                                  │
└─────────────────────────────────────────────────┘
```

### 避免"呆板"的关键策略

| 策略 | 说明 | 示例 |
|------|------|------|
| **分层描述** | 核心动作 + 细节丰富 + 开放空间 | 三层结构 |
| **开放式指令** | 不写死每个瞬间 | "自然的机械运动" vs "停1秒，左转90度" |
| **时间填充** | 添加光影、细节、表情变化 | 阳光变化、沙粒滑落 |
| **随机化** | 避免每次生成相同内容 | 同一输入生成不同细节 |

---

## 🏗️ 技术架构

### 前端节点

```
src/client/src/
├── nodes/
│   ├── config/
│   │   └── OpenAIConfigNode.jsx       ← API 配置节点
│   └── optimize/
│       └── PromptOptimizerNode.jsx    ← 提示词优化节点
├── components/
│   └── openai/
│       ├── APIConfigForm.jsx          ← 配置表单
│       └── OptimizerPanel.jsx         ← 优化面板
```

### 后端 API

```
src/server/
├── routes/
│   └── openai.js                       ← OpenAI 路由
├── services/
│   └── openaiClient.js                 ← OpenAI 客户端
```

### 节点设计

#### OpenAIConfigNode (API 配置节点)

```
┌──────────────────────────────────────┐
│  ⚙️ OpenAI 配置节点                  │
├──────────────────────────────────────┤
│                                       │
│  API 配置                              │
│  ┌─────────────────────────────┐    │
│  │ Base URL                      │    │
│  │ https://api.deepseek.com   │    │
│  ├─────────────────────────────┤    │
│  │ API Key                       │    │
│  │ sk-xxxxx...                  │    │
│  ├─────────────────────────────┤    │
│  │ Model                         │    │
│  │ deepseek-chat               │    │
│  └─────────────────────────────┘    │
│                                       │
│  [💾 保存配置]  [🧪 测试连接]        │
│                                       │
│  输出端口 → openai-config            │
└──────────────────────────────────────┘
```

#### PromptOptimizerNode (提示词优化节点)

```
┌──────────────────────────────────────────┐
│  📝 提示词优化节点 (AI 增强版)            │
├──────────────────────────────────────────┤
│                                          │
│  输入端口                                 │
│  ← openai-config (API配置)               │
│                                          │
│  简单描述输入:                            │
│  ┌────────────────────────────────┐     │
│  │ @装载机 在工地上干活              │     │
│  └────────────────────────────────┘     │
│                                          │
│  风格选择:                                │
│  [🎨 绘本风格] [📹 纪录片风格]           │
│  [🎭 动画风格] [🎬 电影风格]           │
│                                          │
│  [✨ AI 优化] [📊 质量评估]              │
│                                          │
│  优化结果:                                │
│  ┌────────────────────────────────┐     │
│  │ 卡通风格的绘本动画。装载机角色... │     │
│  │ (AI 生成的详细提示词)               │     │
│  └────────────────────────────────┘     │
│                                          │
│  [📋 复制] [🔄 重新生成] [💾 保存为模板]   │
│                                          │
│  输出端口 → optimized-prompt              │
└──────────────────────────────────────────┘
```

---

## 📝 API 接口设计

### POST /api/prompt/optimize

**请求**:
```javascript
{
  base_url: "https://api.deepseek.com",
  api_key: "sk-b5a6d873276441d5991bde3213cff6aa",
  model: "deepseek-chat",
  prompt: "@装载机 在工地上干活",
  style: "picture-book",
  options: {
    target_duration: 10,
    layers: {
      core: true,        // 核心层
      enrichment: true,  // 丰富层
      freedom: true      // 动态层
    }
  }
}
```

**响应**:
```javascript
{
  success: true,
  data: {
    optimized_prompt: "卡通风格的绘本动画...",
    meta: {
      model_used: "deepseek-chat",
      style: "picture-book",
      tokens_used: 1234
    }
  }
}
```

---

## 🎨 绘本专用 Prompt 设计

### 系统提示词（给 DeepSeek 的指令）

```
你是专业的动画绘本提示词专家。

任务：将简单的绘本旁白优化成 Sora 2 视频生成提示词。

三层扩展模型：
1. Layer 1 (核心层 30%)：保持旁白的核心动作，不偏离故事主线
2. Layer 2 (丰富层 40%)：添加视觉细节、环境、氛围
3. Layer 3 (动态层 30%)：留出 AI 自然发挥空间

绘本风格要求：
- ✅ 拟人化角色设计（大眼睛、表情、友好姿态）
- ✅ 鲜艳明亮的色彩（非写实、柔和）
- ✅ 简化的环境（适合儿童理解）
- ✅ 温暖友好的氛围
- ✅ 旁白感（暗示有配音）

避免：
- ❌ 改变故事核心动作
- ❌ 添加无关情节
- ❌ 过于写实（保持卡通感）
- ❌ 复杂或暴力的动作

输出格式：
卡通风格的绘本动画。

角色设计：[拟人化描述]

场景：[简化环境 + 色彩]

核心动作：[旁白中的关键动作]

细节与氛围：
- [3-5 个视觉细节]
- [光影、色彩描述]

Cinematography:
- [镜头类型]
- [视角高度]

Animation style:
- [运动风格描述]
```

### 实际示例（第5句旁白）

**输入**:
```
看，它装满了沙土，就把它们高高地举起来，送到需要的地方。
```

**输出**:
```
卡通风格的绘本动画。

角色设计：
卡通风格的装载机，拟人化设计。明黄色车身，大大的黑色眼睛，长睫毛，微笑表情。
友好的姿态，像一位温柔的工人。

场景：
建筑工地场景（简化风格，适合儿童）。蓝天白云，阳光明媚。
地面是黄色的沙土，远处有简化的城市轮廓（高楼大厦的线条）。
色彩鲜艳明亮，不灰暗。

核心动作：
装载机的铲斗装满了黄沙，缓缓地、稳稳地高高举起来。

细节与氛围：
- 阳光洒在沙子上，金色的闪光点
- 铲斗微微下沉（表现沙子的重量感）
- 液压管有轻微的动作细节
- 沙子有些许洒落（童趣化，不是散落一地）
- 装载机的表情是满足的微笑

Cinematography:
- Low angle shot（从下往上看，强调"高高举起"）
- Eye-level for children（儿童高度视角）
- Bright, warm lighting（明亮温暖的光线）

Animation style:
- Slow, smooth movements（缓慢、流畅的动作）
- Natural mechanical motion（自然的机械运动）
- 适合儿童观看的节奏感
- 轻微的弹性效果（卡通感）
```

---

## 🔄 实施步骤

### 阶段 1: 后端 API 服务

**任务**:
- [ ] 创建 `src/server/services/openaiClient.js`
- [ ] 创建 `src/server/routes/openai.js`
- [ ] 实现 `POST /api/prompt/optimize` 端点
- [ ] 添加错误处理和日志

### 阶段 2: API 配置节点

**任务**:
- [ ] 创建 `OpenAIConfigNode.jsx`
- [ ] 实现配置表单（base_url, api_key, model）
- [ ] 实现保存到 localStorage
- [ ] 实现测试连接功能

### 阶段 3: 提示词优化节点

**任务**:
- [ ] 创建 `PromptOptimizerNode.jsx`
- [ ] 实现简单描述输入框
- [ ] 实现风格选择器
- [ ] 实现 AI 优化按钮
- [ ] 实现结果展示和复制功能

### 阶段 4: 测试验证

**任务**:
- [ ] 测试 DeepSeek API 连接
- [ ] 测试绘本旁白优化（9句示例）
- [ ] 验证输出质量
- [ ] 验证视频生成效果

---

## 📊 成功标准

### 功能完整性
- [ ] 支持自定义 OpenAI 格式 API（base_url, api_key, model）
- [ ] 支持绘本风格提示词优化
- [ ] 生成的提示词符合 Sora 2 格式
- [ ] 生成的提示词保持故事核心

### 质量标准
- [ ] 避免千篇一律（相同输入生成不同细节）
- [ ] 视频时长适配（10-15秒有足够内容）
- [ ] 绘本风格一致（拟人化、鲜艳、友好）
- [ ] 旁白核心不变（不偏离故事）

### 技术质量
- [ ] API 调用稳定可靠
- [ ] 错误处理完善
- [ ] 响应时间 < 10 秒
- [ ] 支持 API 配置持久化

---

## 📚 参考资料

1. **DeepSeek API 文档**: https://api-docs.deepseek.com/zh-cn/
2. **OpenAI API 规范**: https://platform.openai.com/docs/api-reference
3. **Sora 2 Prompting Guide**: OpenAI 官方文档
4. **项目文档**: `用户输入文件夹/动画绘本/` 目录

---

**更新记录**:
- 2026-01-05: v2.0 初始版本，基于用户反馈重新设计
- 核心改进：使用 DeepSeek API + 三层扩展模型
