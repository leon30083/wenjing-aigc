# WinJin AIGC 开发交接书

**文档版本**: v4.1 ⭐ (2026-01-05 更新)
**上一版本**: v4.0 (2026-01-05)
**更新日期**: 2026-01-05
**项目**: WinJin AIGC (开源重构版)
**仓库**: https://github.com/leon30083/wenjing-aigc.git

---

## ⚡ 快速参考（开发前必读）

> 详细说明请查看 `.claude/rules/quick-reference.md`

### 1. 启动开发服务器 ⭐

**工作流画布开发（当前重点）**:
```bash
# 终端1: 启动后端 API
npm run server

# 终端2: 启动前端 Vite
cd src/client && npm run dev

# 浏览器访问
http://localhost:5173/  ← 工作流画布（React Flow）⭐
```

### 2. 测试目标区分 ⚠️

| 端口 | 技术 | 用途 | 当前重点 |
|------|------|------|----------|
| **5173** | React Flow | **工作流画布** | ⭐ **YES** |
| 9000 | 原生 HTML | 网页版（旧版） | NO |

### 3. 常见错误 ❌

```bash
# ❌ 错误1: 只启动后端，访问网页版
npm run server
# 浏览器打开 localhost:9000  ← 这是网页版，不是工作流画布！

# ❌ 错误2: 使用 npm start（需要 electron）
npm start  # 'electron' 不是内部或外部命令

# ✅ 正确: 同时启动后端和前端
npm run server          # 终端1
cd src/client && npm run dev  # 终端2
# 访问 localhost:5173  ← 这才是工作流画布！
```

---

## 📋 目录

1. [项目概述](#项目概述)
2. [环境要求](#环境要求)
3. [快速开始](#快速开始)
4. [Claude Code 配置（重要）](#claude-code-配置重要)
5. [项目结构](#项目结构)
6. [常用命令](#常用命令)
7. [API 端点](#api-端点)
8. [开发规范](#开发规范)
9. [关键模块说明](#关键模块说明)
10. [最新开发进度](#最新开发进度)
11. [注意事项](#注意事项)
12. [故障排查](#故障排查)
13. [工作流编辑器使用指南] ⭐ 新增

---

## 项目概述

WinJin AIGC 是一个基于 Electron + Express 的 AI 视频生成工具，支持：

- **Sora2 视频生成**: 文生视频、角色参考视频、故事板批量生成
- **角色创建**: 从视频中提取角色，支持角色库管理
- **双平台支持**: 聚鑫平台 (api.jxincm.cn) 和贞贞平台 (ai.t8star.cn)
- **历史记录**: 自动保存任务记录到 JSON 文件，后台轮询自动更新状态
- **角色库**: 管理创建的角色，支持搜索、别名、快速调用
- **可视化节点工作流** ⭐ v2.0 新增: ComfyUI 风格的拖拽式节点编辑器

---

## 环境要求

### 必需软件

| 软件 | 版本要求 | 下载地址 |
|------|----------|----------|
| **Node.js** | 16.x 或更高 | https://nodejs.org/ |
| **npm** | 8.x 或更高 | 随 Node.js 安装 |
| **Git** | 最新版 | https://git-scm.com/ |
| **Claude Code** | 最新版 | https://claude.com/claude-code |

### 可选软件

- **VS Code**: 推荐的代码编辑器
- **Chrome DevTools**: 调试前端（Claude Code 已集成）

### 操作系统

- Windows 10/11（主要目标平台）
- macOS/Linux（兼容）

---

## 快速开始

### 1. 克隆项目

```bash
# 克隆仓库
git clone https://github.com/leon30083/wenjing-aigc.git
cd wenjing-aigc
```

### 2. 安装依赖

```bash
# 安装项目依赖
npm install
```

### 3. 配置环境变量

```bash
# 复制环境变量模板
copy .env.example .env

# 编辑 .env 文件，填入你的 API Key
```

**`.env` 文件内容**:

```bash
# 聚鑫平台 API Key（必填）
SORA2_API_KEY=sk-your-actual-juxin-api-key

# 贞贞平台 API Key（可选）
ZHENZHEN_API_KEY=sk-your-actual-zhenzhen-api-key

# 服务器端口
PORT=9000
```

### 4. 启动开发服务器

**⚠️ 重要**：项目有两种启动方式，注意区分！

#### 方式1: 仅启动 HTTP 服务器（推荐用于 API 测试）

```bash
npm run server
```

- **用途**: 启动 Express HTTP 服务器，提供 API 接口
- **端口**: `http://localhost:9000`
- **访问**: 浏览器打开 http://localhost:9000
- **适用场景**:
  - 测试 API 接口
  - 测试网页版功能（非工作流画布）
- **注意**: **不启动 Electron 桌面应用**

#### 方式2: 启动工作流画布开发服务器 ⭐ 当前开发重点

**⚠️ 重要**：这是当前项目的主要开发目标！

```bash
# 步骤1: 启动后端 API 服务器
npm run server

# 步骤2: 启动前端 Vite 开发服务器（新终端窗口）
cd src/client
npm run dev
```

- **后端端口**: `http://localhost:9000` (API 接口)
- **前端端口**: `http://localhost:5173` (工作流画布)
- **访问**: 浏览器打开 **http://localhost:5173/**
- **适用场景**:
  - **工作流节点开发** ⭐
  - **节点连线测试** ⭐
  - **React Flow 功能调试** ⭐
- **注意**:
  - **必须同时运行两个服务器**（后端 + 前端）
  - **测试时访问 5173 端口，不是 9000 端口** ⚠️
  - 9000 端口是网页版，不是工作流画布 ⚠️

#### 方式3: 启动完整的 Electron 桌面应用

```bash
npm start
```

- **用途**: 启动 Electron 桌面应用（包含内嵌的 HTTP 服务器）
- **要求**: 需要先安装 electron (`npm install electron --save-dev`)
- **适用场景**:
  - 打包桌面应用
  - 测试桌面应用功能

#### 常见问题 ⚠️ 易犯错误

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| `electron: command not found` | electron 未安装 | 使用 `npm run server` 代替 `npm start` |
| 端口被占用 | 9000 端口已被使用 | 修改 `.env` 中的 PORT 配置 |
| **测试了网页版而非画布** | ❌ 访问 localhost:9000 | ✅ 访问 localhost:5173（工作流画布） |
| **前端无法连接 API** | 只启动了 Vite，没启动后端 | 同时运行 `npm run server` 和 `npm run dev` |

**开发流程推荐** ⭐:
1. 终端1: `npm run server` (后端 API)
2. 终端2: `cd src/client && npm run dev` (前端画布)
3. 浏览器访问: **http://localhost:5173/** ⭐

**❌ 错误操作**:
- 只运行 `npm run server` 后访问 9000 端口 → 测试的是网页版，不是工作流画布
- 只运行 Vite dev server → 前端无法连接后端 API

---

## Claude Code 配置（重要）

**⚠️ 这是开发的核心配置，必须在新的开发环境中正确设置！**

### 配置文件位置

```
.claude/
├── settings.json          # Claude Code 设置
├── settings.local.json    # 本地覆盖设置（不提交）
└── rules/                 # 开发规则
    ├── base.md            # 基础技术栈规则
    └── code.md            # 代码规范和最佳实践
```

### settings.json 配置

**位置**: `项目根目录/.claude/settings.json`

```json
{
  "mcpServers": {
    "memory": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-memory"]
    },
    "chrome-devtools": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-chrome-devtools"]
    },
    "context7": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-context7"]
    }
  }
}
```

### rules/base.md - 技术栈约束

**关键内容**:

```markdown
## 运行时环境
- Node.js: 16.x 或更高
- npm: 8.x 或更高

## 核心框架版本
| 框架/库 | 版本要求 |
|---------|----------|
| Electron | ^28.0.0 |
| Express | ^4.18.2 |
| axios | ^1.6.5 |
| dotenv | ^17.2.3 |

## Sora2 API 支持平台
### 聚鑫平台 (api.jxincm.cn)
- 创建视频: POST /v1/video/create
- 查询任务: GET /v1/video/query?id={taskId} ⚠️ 查询参数
- 创建角色: POST /sora/v1/characters

### 贞贞平台 (ai.t8star.cn)
- 创建视频: POST /v1/video/create
- 查询任务: GET /v2/videos/generations/{taskId} ⚠️ 路径参数
- 创建角色: POST /sora/v1/characters

### 重要差异
- 查询端点: 聚鑫用查询参数 ?id=，贞贞用路径参数 /{taskId}
- 响应格式: 聚鑫返回 {id}, 贞贞返回 {task_id} ⚠️ 需要兼容处理
- 角色创建: 都支持 from_task 参数（推荐）

### 角色引用语法 ⭐
所有平台统一使用 @username 格式（不带花括号）
示例: @6f2dbf2b3.zenwhisper 在工地上干活

### 角色创建规范 ⭐
- 端点: POST /sora/v1/characters
- 参数: url 或 from_task 二选一
- 必填: timestamps (格式: "1,3")
- ⚠️ 禁止: 不要传递 model 参数
- ✅ 推荐: 优先使用 from_task 参数

## 轮询策略
- 后台自动轮询: 30秒间隔
- 检查范围: 所有 queued 和 processing 状态的任务
- 手动查询: 提供"查询状态"按钮
```

### rules/code.md - 代码规范

**关键内容**:

```markdown
## 命名约定
- 文件名: kebab-case
- 变量/函数: camelCase
- 类名: PascalCase
- 常量: UPPER_SNAKE_CASE
- 私有成员: 前缀下划线 _

## Sora2 API 开发规范

### 双平台任务ID兼容处理 ⚠️ 重要
// ✅ 正确：兼容双平台的任务ID格式
const taskId = result.data.id || result.data.task_id;
if (taskId) {
  historyStorage.addRecord({ taskId, platform, prompt, model, options });
}

### 角色引用语法
// ✅ 正确：所有平台使用 @username 格式
const prompt = '@6f2dbf2b3.zenwhisper 在工地上干活';
// ❌ 错误：不要使用花括号
const prompt = '@{6f2dbf2b3.zenwhisper} 在工地上干活';
```

### 配置 Claude Code 自动加载规则

当在新的开发环境首次使用 Claude Code 时：

1. **打开项目根目录**
   ```bash
   cd D:\user\github\winjin
   ```

2. **启动 Claude Code**
   - Claude Code 会自动读取 `.claude/settings.json`
   - 会自动加载 `rules/` 目录下的规则文件

3. **验证配置**
   - 在 Claude Code 中询问：请列出当前项目的技术栈
   - 应该返回 base.md 中定义的技术栈信息

---

## 项目结构

```
wenjing-aigc/
├── .claude/                    # Claude Code 配置 ⭐
│   ├── settings.json           # MCP 服务器配置
│   └── rules/                  # 开发规则
│       ├── base.md             # 技术栈约束
│       └── code.md             # 代码规范
├── data/                       # 数据持久化目录（自动创建）
│   ├── history.json            # 历史记录
│   └── characters.json         # 角色库
├── downloads/                  # 视频下载目录（自动创建）
├── reference/                  # 参考文档
│   └── 用户输入文件夹/
│       ├── 开发经验/           # 开发文档 ⭐
│       ├── 聚鑫sora2/          # 聚鑫 API 文档
│       └── 贞贞工坊/           # 贞贞 API 文档
├── src/
│   ├── main/                   # Electron 主进程（暂未使用）
│   ├── renderer/               # Electron 渲染进程
│   │   └── public/
│   │       └── index.html      # Web 前端界面（v1.x）
│   ├── server/                 # HTTP 服务器 ⭐
│   │   ├── index.js            # Express 服务器主文件
│   │   ├── sora2-client.js     # Sora2 API 客户端
│   │   ├── history-storage.js  # 历史记录存储
│   │   ├── character-storage.js # 角色库存储
│   │   └── batch-queue.js      # 批量任务队列
│   └── client/                 # ⭐ v2.0 新增：工作流编辑器
│       ├── src/
│       │   ├── nodes/          # 自定义节点
│       │   │   ├── input/      # 输入节点 (4个)
│       │   │   ├── process/    # 处理节点 (3个)
│       │   │   └── output/     # 输出节点 (2个)
│       │   ├── hooks/          # React Hooks
│       │   │   └── useWorkflowExecution.js
│       │   ├── App.jsx         # 主应用
│       │   └── App.css
│       ├── package.json
│       └── vite.config.js
├── .env                        # 环境变量（不提交）
├── .env.example                # 环境变量模板
├── .gitignore                  # Git 忽略规则
├── package.json                # 项目依赖
└── README.md                   # 项目说明
```

---

## 常用命令

### 开发命令

```bash
# 启动 HTTP 服务器（最常用）
npm run server

# 启动 Electron 应用
npm start

# 开发模式（热重载）
npm run dev

# ⭐ v2.0 新增：启动工作流编辑器
cd src/client && npm run dev
# 访问 http://localhost:5173
```

### Git 命令

```bash
# 查看状态
git status

# 提交更改
git add .
git commit -m "feat: your message"
git push origin master

# 拉取最新代码
git pull origin master

# 设置代理（如需要）
git config --global http.proxy http://127.0.0.1:7890
git config --global https.proxy http://127.0.0.1:7890

# 取消代理
git config --global --unset http.proxy
git config --global --unset https.proxy
```

### 测试命令

```bash
# 测试服务器健康
curl http://localhost:9000/health

# 测试创建视频
curl -X POST http://localhost:9000/api/video/create \
  -H "Content-Type: application/json" \
  -d '{"platform":"juxin","prompt":"A cat","model":"sora-2"}'
```

---

## API 端点

### 健康检查
```
GET /health
```

### 视频生成
```
POST /api/video/create              # 文生视频
POST /api/video/create-with-character  # 带角色参考
POST /api/video/storyboard          # 故事板批量
POST /api/video/download            # 下载视频
```

### 角色管理
```
POST   /api/character/create           # 创建角色
GET    /api/character/list             # 获取角色列表
GET    /api/character/stats            # 获取统计信息
GET    /api/character/:characterId     # 获取单个角色
GET    /api/character/search/:query    # 搜索角色
PUT    /api/character/:characterId/alias  # 设置别名 ⭐
DELETE /api/character/:characterId     # 删除角色
DELETE /api/character/all             # 清空所有角色
```

### 任务查询
```
GET /api/task/:taskId               # 查询任务状态
GET /api/task/:taskId/wait          # 等待任务完成
```

### 批量任务
```
POST /api/batch/create              # 创建批量任务
POST /api/batch/:id/submit          # 提交批量任务
GET  /api/batch/:id/poll            # 轮询批量任务
GET  /api/batch/:id/status          # 获取批量任务状态
GET  /api/batch/list                # 获取所有批量任务
DELETE /api/batch/:id               # 删除批量任务
```

### 备份管理 ⭐ 新增
```
GET  /api/backup/export             # 导出备份（JSON格式）
POST /api/backup/import             # 导入备份
GET  /api/backup/info               # 获取数据统计信息
```

---

## 开发规范

### 代码风格

```javascript
// ✅ 正确的命名
const getUserData = () => {};  // camelCase
class UserService {};          // PascalCase
const MAX_RETRIES = 3;         // UPPER_SNAKE_CASE
const _privateVar = 'secret';  // 私有成员前缀

// ❌ 错误的命名
const GetUserData = () => {};  // 不使用 PascalCase
const user_data = () => {};    // 不使用 snake_case
```

### API 调用规范

```javascript
// ✅ 正确：使用 async/await + try-catch
async function createVideo(options) {
  try {
    const response = await axios.post('/api/video/create', options);
    return { success: true, data: response.data };
  } catch (error) {
    return { success: false, error: error.message };
  }
}

// ❌ 错误：不使用 try-catch
async function createVideo(options) {
  const response = await axios.post('/api/video/create', options);
  return response.data;  // 可能抛出未捕获的异常
}
```

### 统一响应格式

```javascript
// 成功响应
{ success: true, data: {...} }

// 失败响应
{ success: false, error: "错误信息" }
```

---

## 关键模块说明

### 1. Sora2Client (src/server/sora2-client.js)

**职责**: 封装 Sora2 API 调用，支持双平台

**关键方法**:
```javascript
// 创建视频（兼容双平台响应格式）
await client.createVideo({
  prompt: 'A cat sleeping',
  model: 'sora-2',
  orientation: 'landscape',
  duration: 10,
  size: 'small'
});

// 查询任务（自动处理平台差异）
await client.getTaskStatus(taskId);

// 创建角色（支持 from_task）
await client.createCharacter({
  from_task: taskId,  // 推荐方式
  timestamps: '1,3'
});
```

### 2. HistoryStorage (src/server/history-storage.js)

**职责**: 历史记录持久化存储

**存储位置**: `data/history.json`

**关键方法**:
```javascript
// 添加记录
historyStorage.addRecord({
  taskId: 'video_xxx',
  platform: 'juxin',
  prompt: 'A cat',
  model: 'sora-2'
});

// 标记完成
historyStorage.markCompleted(taskId, { output: 'url' });

// 获取所有记录
const records = historyStorage.getAllRecords({
  status: 'queued',
  platform: 'zhenzhen'
});
```

### 3. CharacterStorage (src/server/character-storage.js)

**职责**: 角色库持久化存储

**存储位置**: `data/characters.json`

**关键方法**:
```javascript
// 添加角色（自动去重）
characterStorage.addCharacter({
  id: 'ch_xxx',
  username: 'user.name',
  alias: '别名',  // ⭐ 新增
  profilePictureUrl: 'url',
  platform: 'zhenzhen'
});

// 更新角色（设置别名）
characterStorage.updateCharacter(characterId, { alias: '新别名' });

// 搜索角色
const results = characterStorage.searchCharacters('user');

// 获取统计
const stats = characterStorage.getStats();
// { total: 10, byPlatform: { juxin: 5, zhenzhen: 5 } }
```

### 4. 后台轮询服务 (src/server/index.js)

**职责**: 自动检查并更新任务状态

**配置**:
```javascript
const POLL_INTERVAL = 30000;  // 30秒

// 检查所有 queued 和 processing 状态的任务
setInterval(async () => {
  const queuedTasks = historyStorage.getAllRecords({ status: 'queued' });
  const processingTasks = historyStorage.getAllRecords({ status: 'processing' });
  const allPendingTasks = [...queuedTasks, ...processingTasks];

  for (const record of allPendingTasks) {
    await checkAndUpdateTask(record.taskId, record.platform);
  }
}, POLL_INTERVAL);
```

---

## 最新开发进度

### 已完成功能 ✅

#### 0. 二阶段开发文档整合 (2026-01-05) ⭐ v4.1
- **核心目标**: 整合 PromptOptimizerNode 集成后的新增功能和修复内容到现有文档
- **功能点1: API 端点修正**
  - 修正贞贞平台故事板端点：`POST /v2/videos/generations` (常规端点 + 特殊格式)
  - 修正聚鑫平台故事板端点：`POST /v1/videos` (专用端点, multipart/form-data)
  - 更新 base.md "Sora2 API 支持平台" 章节
- **功能点2: PromptOptimizerNode 功能文档**
  - 新增 `POST /api/openai/optimize` API 文档
  - 准确反映当前实现：仅 `picture-book` 风格完整实现，其他风格使用通用提示词
  - 包含角色引用保留机制的完整后端实现代码
- **功能点3: 错误代码示例补充**
  - 错误41: 贞贞故事板端点配置错误
  - 错误45: TaskResultNode 不识别新节点类型
- **修改文件**:
  - `.claude/rules/base.md` - API端点修正、PromptOptimizerNode文档
  - `.claude/rules/code.md` - 错误代码示例
  - `用户输入文件夹/开发对话/开发交接书.md` - 版本号更新到 v4.1
- **文档状态**: ✅ 技术规范准确率提升，核心文档已同步

#### 1. Sora2 提示词自动优化功能 (2026-01-05) ⭐ v4.0
- **核心功能**: 基于 OpenAI 官方 Sora 2 Prompting Guide 实现提示词优化
- **功能点1: 自动生成提示词**
  - 4 种官方风格模板：纪录片风格、70年代电影、手绘动画、IMAX史诗
  - 基于场景描述自动生成完整的提示词结构
  - 支持角色引用和参考图自动插入
- **功能点2: 提示词质量评估**
  - 5 维度评估系统：清晰度(25%)、摄影指导(20%)、动作描述(25%)、灯光色彩(15%)、图生视频(30%)
  - 0-100 分评分，等级 A/B/C/D
  - 提供具体的改进建议
- **功能点3: 智能补全提示词**
  - 部分提示词自动补全为完整结构
  - 智能识别场景、动作、摄影元素
  - 保持用户已输入内容不变
- **应用范围**:
  - VideoGenerateNode（视频生成节点）- 整体优化
  - JuxinStoryboardNode（聚鑫故事板）- 单镜头优化
  - ZhenzhenStoryboardNode（贞贞故事板）- 单镜头优化
- **UI 组件**:
  - PromptOptimizer - 主优化器面板
  - EvaluationCard - 评估结果卡片
  - TemplateSelector - 模板选择器
- **架构设计**: 3 层分离（Utils → Hooks → UI）
  - Utils: constants.js, promptTemplates.js, promptEvaluator.js, promptBuilder.js
  - Hooks: usePromptOptimizer.js, usePromptTemplates.js
  - UI: PromptOptimizer.jsx, EvaluationCard.jsx, TemplateSelector.jsx
- **修改文件**:
  - `src/client/src/utils/prompt/constants.js` - 官方模板库和评估维度定义（新增）
  - `src/client/src/utils/prompt/promptTemplates.js` - 官方模板数据和选择逻辑（新增）
  - `src/client/src/utils/prompt/promptEvaluator.js` - 评估规则引擎（新增）
  - `src/client/src/utils/prompt/promptBuilder.js` - 提示词生成和评估逻辑（新增）
  - `src/client/src/hooks/usePromptOptimizer.js` - 提示词优化核心 Hook（新增）
  - `src/client/src/hooks/usePromptTemplates.js` - 模板管理 Hook（新增）
  - `src/client/src/components/prompt/PromptOptimizer.jsx` - 优化结果展示（新增）
  - `src/client/src/components/prompt/EvaluationCard.jsx` - 评估卡片（新增）
  - `src/client/src/components/prompt/TemplateSelector.jsx` - 模板选择器（新增）
  - `src/client/src/nodes/process/VideoGenerateNode.jsx` - 集成优化功能（修改）
  - `src/client/src/nodes/process/JuxinStoryboardNode.jsx` - 集成单镜头优化（修改）
  - `src/client/src/nodes/process/ZhenzhenStoryboardNode.jsx` - 集成单镜头优化（修改）
- **参考资料**:
  - OpenAI Sora 2 Prompting Guide | OpenAI Cookbook
  - Sora 2 Prompt Authoring Best Practices 2025

#### 2. 角色库节点布局抖动修复 (2026-01-04) ⭐ v3.9
- **问题现象**: 角色库节点中的角色列表不停抖动，滚动条上下滑动（约1-3秒）
- **用户反馈**:
  - "我看到画布中所有角色库节点都在抖动"
  - "角色库节点内部的角色显示列表在抖动，那个滑块一直在上下滑动"
  - "这次比之前好多了，但是角色库中，每个角色对应的图片没有显示出来，一直在闪动加载"
- **调试过程**（重要经验）:
  1. ❌ 怀疑是轮询导致的抖动 → 检查轮询正常，排除
  2. ❌ 怀疑是 useEffect 无限循环 → 修复所有 useEffect，问题仍存在
  3. ❌ 怀疑是实际滚动 → 添加红色标记线，证明滚动条静止
  4. ✅ **关键突破**: 使用浏览器性能录制功能，发现 51 次布局偏移
  5. ✅ 创建 `default-avatar.svg` 文件，解决图片闪动问题
- **根本原因**: 图片加载时没有预留空间，导致布局频繁调整
  - CLS (累积布局偏移) 分数达到 0.0176
  - 51 次布局偏移，持续约 5 秒
  - `default-avatar.svg` 文件不存在导致图片加载失败持续重试
- **解决方案**:
  1. 为图片添加 `display: 'block'` 防止内联布局计算
  2. 添加 `flexShrink: 0` 防止 flex 收缩
  3. 创建 `src/client/public/default-avatar.svg` 默认头像文件
- **性能对比**:
  | 指标 | 修复前 | 修复后 | 改善 |
  |------|--------|--------|------|
  | CLS 分数 | 0.0176 | 0.0010 | 减少 94% |
  | 布局偏移次数 | 51 次 | 3 次 | 减少 94% |
  | 偏移持续时间 | ~5 秒 | 1.8 秒 | 减少 64% |
- **调试方法**: ⭐ 浏览器性能录制功能（DevTools Performance）
  1. 打开 Chrome DevTools（F12）
  2. 切换到 Performance 选项卡
  3. 点击录制按钮（圆点图标）
  4. 刷新页面（Ctrl+Shift+R 强制刷新）
  5. 等待 5-10 秒后停止录制
  6. 查看 CLS 分数和偏移次数
- **修改文件**:
  - `src/client/src/nodes/input/CharacterLibraryNode.jsx` - Lines 715-716
  - `src/client/public/default-avatar.svg` - 新建文件
- **验证结果**: ✅ CLS 从 0.0176 降到 0.0010，节点内容不再抖动
- **经验教训**:
  - 🔥 **性能录制是调试性能问题的黄金方法** - 比控制台日志更直观
  - 🔥 **优先使用浏览器工具** - DevTools Performance 能直接定位问题
  - 🔥 **用户描述的症状可能不准确** - "滚动条滑动"实际是布局偏移
- **相关文档**:
  - ✅ SKILL.md: 添加错误47和调试流程优化章节（lines 1315-1397, 1510-1563）
  - ✅ troubleshooting.md: 添加"性能与布局问题"章节（lines 225-318）

#### 2. 后台轮询服务优化 (2026-01-04) ⭐ v3.9
- **功能点1: 24小时时间限制**
  - 添加 `MAX_POLLING_AGE` 常量（24小时）
  - 超过时间的任务不再轮询，避免浪费API配额
  - 轮询时检查任务年龄，自动标记为 `stale` 状态
- **功能点2: Stale 状态管理**
  - 新增 `stale` 状态：超过24小时未完成的任务
  - `stale` 任务不再自动轮询，节省服务器资源
  - 状态定义：queued → processing → completed/failed/stale
- **功能点3: 启动时清理旧任务**
  - 服务器启动时自动检查并标记旧任务为 stale
  - 日志输出标记数量：`[轮询] 已标记 3 个旧任务为 stale（超过24小时）`
  - 防止旧任务无限轮询占用资源
- **关键问题**: 用户反馈后台一直轮询3个任务，担心浪费API配额
- **用户确认**: 方案B（优化后台轮询）✅，24小时时间限制 ✅，立即标记3个任务为 stale ✅
- **修改文件**:
  - `src/server/index.js` - Lines 687-785
    - 添加 `MAX_POLLING_AGE` 常量
    - `checkAndUpdateTask()` 添加时间检查
    - `startPollingService()` 添加启动清理逻辑
  - `src/server/history-storage.js` - Lines 1-11
    - 添加 `stale` 状态定义
- **验证结果**:
  - ✅ 服务器启动时自动标记3个旧任务为 stale
  - ✅ 轮询日志显示：`[轮询] 服务已启动，间隔 30 秒（最大轮询时间: 24小时）`
  - ✅ 旧任务不再轮询，新任务正常轮询
- **二阶段规划**: 方案A（事件驱动轮询）已记录到 SKILL.md 供未来开发参考
- **相关文档**:
  - ✅ code.md: 更新"后台轮询服务实现"章节（lines 135-228）
  - ✅ SKILL.md: 添加错误46和二阶段优化方案（lines 1244-1369）

#### 2. 文档彻底纠错 (2026-01-03) ⭐ v3.8
- **API端点数量修正**: 删除不存在的 `/api/history/*` 端点（29 → 28个）
- **新增文档**: 平台专用故事板节点说明（base.md）
  - 聚鑫故事板使用普通视频API + 特殊格式提示词
  - 贞贞故事板使用专用API端点
- **新增文档**: 节点连接验证机制说明（base.md）
  - 输入端口到源节点类型的映射
  - 防止错误26（节点连接验证缺失）
- **更新文档**: Windows后端重启问题（quick-reference.md）
  - 完整重启流程
  - 常见错误和解决方案
- **修改文件**:
  - `用户输入文件夹/开发对话/开发交接书.md` - 删除废弃端点，版本号更新到 v3.8
  - `.claude/rules/base.md` - 新增平台专用故事板节点和节点连接验证章节
  - `.claude/rules/quick-reference.md` - 扩展后端重启问题说明

#### 2. 聚鑫平台模型和时长修复 (2026-01-02) ⭐ v3.7
- **CRITICAL 修复**: 聚鑫平台模型名称 sora-2 → sora-2-all
- **问题**: 用户反馈"你已经害我损失很多钱了" - 使用错误模型导致扣费错误
- **解决**:
  - 后端添加平台自动切换逻辑: `this.platformType === 'JUXIN' ? 'sora-2-all' : 'sora-2'`
  - 前端硬编码聚鑫故事板节点使用 `sora-2-all`
  - 添加调试日志验证模型选择
- **功能修复**: 故事板默认时长 5秒 → 15秒
- **Bug 修复**: 时长自动调整逻辑 [4,8,12] → [10,15,25]
- **文档更新**: 添加后端重启说明到自动化规范
- **修改文件**:
  - `src/server/sora2-client.js` - Lines 339-346, 369-383
  - `src/client/src/nodes/process/JuxinStoryboardNode.jsx` - Lines 51-53, 167-170
  - `src/client/src/nodes/process/ZhenzhenStoryboardNode.jsx` - Lines 51-53, 167-170
  - `.claude/rules/quick-reference.md` - 添加后端重启说明
- **验证结果**: 任务 video_f8137c17 - 模型 sora_video2 ✅, 时长 15秒 ✅

#### 2. 参考图节点数据类型修复 (2026-01-02) ⭐ v3.6
- **问题**: 点击连接线时，取消选中的图片又重新出现在目标节点
- **原因**:
  - ReferenceImageNode 保存 `selectedImages` 到 `node.data` 时是**数组**
  - App.jsx 中间件错误地使用 Set 的 `.size` 和 `.has()` 方法处理
  - 导致逻辑判断失败，传递了错误的图片数据
- **解决**:
  - 修复 App.jsx 使用 `Array.isArray()` 检查数据类型
  - ReferenceImageNode 添加工作流恢复支持
  - 直接使用已过滤的数组，无需再次过滤
- **修改文件**:
  - `src/client/src/nodes/input/ReferenceImageNode.jsx` - 工作流恢复支持
  - `src/client/src/App.jsx` - 修复数组处理逻辑

#### 2. 模型名称修复 (2026-01-02) ⭐ v3.5
- **问题**: 聚鑫平台使用 `sora-2` 模型导致 API 调用失败
- **原因**: 聚鑫平台使用 `sora-2-all` 模型名称（而非 `sora-2`）
- **解决**:
  - 后端实现平台自动切换逻辑
  - 前端 UI 更新默认模型和选项
  - 添加 `sora-2-all` 模型支持
- **修改文件**:
  - `src/server/sora2-client.js` - 添加平台自动切换
  - `src/client/src/nodes/input/APISettingsNode.jsx` - 更新默认值
  - `src/client/src/nodes/process/VideoGenerateNode.jsx` - 更新默认值
  - `src/client/src/nodes/process/StoryboardNode.jsx` - 更新默认值
  - `src/renderer/public/index.html` - 添加模型选项

#### 2. 双平台兼容性修复 (2025-12-29)
- **问题**: 贞贞平台视频未保存到历史记录
- **原因**: 贞贞返回 `{task_id}`, 聚鑫返回 `{id}`
- **解决**: 兼容处理 `result.data.id || result.data.task_id`

#### 2. 角色引用语法修正 (2025-12-29)
- **问题**: 之前使用 `@{username}` 格式（错误）
- **修正**: 所有平台统一使用 `@username` 格式（不带花括号）
- **示例**: `@6f2dbf2b3.zenwhisper 在工地上干活`

#### 3. 后台轮询服务 (2025-12-29)
- **功能**: 每30秒自动检查待处理任务状态
- **范围**: 所有 `queued` 和 `processing` 状态的任务
- **更新**: 自动更新历史记录状态

#### 4. 手动查询功能 (2025-12-29)
- **功能**: 为每个任务添加"查询状态"按钮
- **用途**: 用户可主动查询而无需等待轮询

#### 5. 角色库增强 (2025-12-29)
- **别名功能**: 为角色设置易于记忆的别名
- **快速调用**: 在视频创建表单中添加角色选择器
- **复制ID**: 修复复制ID按钮功能

#### 6. 可视化角色选择器 (2025-12-29)
- **网格布局**: 从下拉框改为可视化角色卡片网格
- **头像显示**: 显示角色头像、别名和用户名
- **选中状态**: 支持点击选择/取消选中，有视觉反馈
- **平台通用**: 不显示平台标签（sora2 角色跨平台通用）

#### 7. 光标位置插入 (2025-12-29)
- **文生视频**: 点击角色时在光标位置插入 `@username` 引用
- **故事板**: 记录最后焦点的场景输入框，只在其中插入
- **不替换内容**: 不影响用户已输入的其他内容

#### 8. 备份管理功能 (2025-12-29) ⭐ 新增
- **前端界面**: 新增"备份管理"标签页
- **导出备份**: 将所有历史记录和角色库导出为 JSON 文件
- **导入备份**: 从备份文件恢复数据，跳过已存在的记录
- **数据统计**: 实时显示历史记录和角色数量统计
- **双格式支持**: 导入功能支持 API 包装格式和纯备份格式
- **版本控制**: 备份文件包含版本号和时间戳

#### 9. 参考图片功能 (2025-12-29) ⭐ 新增
- **文生/图生视频自动检测**: 根据是否提供参考图片自动选择模式
- **简单模式**: 支持动态添加/删除多张参考图片
- **故事板模式**: 每个分镜头可独立配置参考图片
- **后端收集**: 自动收集所有镜头的图片并合并到 images 数组
- **角色混合**: 支持角色客串与参考图片搭配使用
- **提示词优化**: 先分析图片内容，再写相关性强的提示词

#### 10. 历史记录管理功能 (2025-12-29) ⭐ 新增
- **单条删除**: 每条历史记录都有删除按钮，支持按任务ID删除
- **清空全部**: 一键清空所有历史记录，有双重确认机制
- **安全保护**: 所有删除操作都需要用户确认，防止误操作
- **自动刷新**: 删除成功后自动刷新历史记录列表
- **错误处理**: 完整的错误处理和用户反馈

#### 11. 角色搜索、筛选和收藏功能 (2025-12-29) ⭐ 新增
- **实时搜索**: 按角色用户名或别名搜索，300ms 防抖延迟
- **筛选类型**: 全部角色 / 我的收藏 / 最近使用
- **收藏功能**: 点击星标图标收藏/取消收藏角色
- **最近使用**: 自动记录最近使用的 20 个角色（localStorage）
- **后端 API**: 新增 `PUT /api/character/:username/favorite` 收藏端点
- **存储增强**: 新增 `updateByUsername` 方法支持按用户名更新

#### 26. 多角色引用实现 (2025-12-30) ⭐ 新增
- **功能**: 工作流编辑器中的多角色选择和手动插入
- **CharacterLibraryNode**: 多选初筛模式（`transfer` / `manage`）
- **VideoGenerateNode**: 候选角色显示，点击插入到光标位置
- **数据流**: `selectedCharacters` Set → `connectedCharacters` 数组 → 点击插入 `@username`
- **测试结果**: ✅ 选择、传递、显示、插入全部验证通过
- **Git 提交**: `9235a80 feat: implement multi-character reference workflow`

#### 27. 角色引用双显示功能 (2025-12-30) ⭐ 新增
- **问题**: 用户输入的别名（如 @阳光小猫）需要转换为真实ID（如 @5562be00d.sunbeamkit）才能被API识别
- **解决方案**: 实现双向转换系统
  - **输入框显示**: 别名格式（@阳光小猫）- 便于用户识别
  - **API 接收**: 真实ID格式（@5562be00d.sunbeamkit）- 用于角色引用
- **技术实现**:
  - `usernameToAlias` 映射: 存储用户名到别名的对应关系
  - `realToDisplay()`: 将真实ID转换为别名用于显示
  - `displayToReal()`: 将别名转换回真实ID用于API
  - **关键修复**: 正则表达式从 `\b` 改为 `(?=\s|$|@)` 以支持中文
- **测试结果**:
  - ✅ @测试小猫 → @ebfb9a758.sunnykitte
  - ✅ @装载机 → @783316a1d.diggyloade
  - ✅ 多角色: @测试小猫 和@装载机 → @ebfb9a758.sunnykitte 和@783316a1d.diggyloade
  - ✅ 视频生成成功: video_399a3462-9eff-4d2a-a11d-910dcc7838e6
- **Git 提交**: `76c7b56 feat: implement dual-display for character references (alias display, real ID for API)`

#### 28. 角色编辑功能优化 (2025-12-30) ⭐ 新增
- **问题**: "批量删除"按钮文字有歧义，功能不限于删除
- **解决**: 将按钮文字改为"✏️ 角色编辑"
- **功能描述**:
  - 编辑角色别名
  - 删除角色（单个或批量）
  - 更准确地反映该模式的实际功能
- **Git 提交**: `913edba refactor: rename "批量删除" to "角色编辑" for clarity`

#### 29. ComfyUI 风格节点增强功能 (2025-12-30) ⭐ 新增
- **功能点1: 节点大小可调整**
  - 节点右下角显示三角形缩放手柄（ComfyUI 风格）
  - 拖动右下角调整节点宽度和高度
  - 限制最小尺寸（260px x 400px）
  - 调整大小时禁用文本选择（userSelect: none）
- **功能点2: 文本选择不触发节点拖动**
  - 使用 `className="nodrag"` 标记所有交互元素
  - 应用于: textarea, select, input, button, 缩放手柄
  - React Flow 官方推荐方案（而非 stopPropagation）
- **功能点3: 无限循环修复**
  - 使用 `useRef` 存储回调函数引用
  - 使用 `useCallback` 在父组件创建稳定回调
  - 移除 `data` 从 useEffect 依赖数组
  - 修复页面崩溃问题（Maximum update depth exceeded）
- **技术实现**:
  - `VideoGenerateNode.jsx`: 节点大小可调整、nodrag 类
  - `App.jsx`: useCallback 创建稳定回调函数
- **测试结果**:
  - ✅ 拖动右下角成功调整节点大小
  - ✅ textarea 中选择文本不拖动节点
  - ✅ 所有交互元素（select、button、input）正常工作
  - ✅ 无无限循环，页面稳定运行
- **影响文件**:
  - `src/client/src/nodes/process/VideoGenerateNode.jsx`
  - `src/client/src/App.jsx`

#### 29. 数据架构深度修复 (2026-01-01) ⭐ 重大修复
- **问题1**: 点击角色导致"页面重新加载"，而不是即时更新
  - **根本原因**:
    - CharacterLibraryNode 和 ReferenceImageNode 有双重 useEffect
    - localStorage 频繁保存（每次点击都保存）
    - App.jsx 只监听 edges，不监听 nodes
  - **解决方案**:
    - 合并双重 useEffect 为单个 useEffect
    - 防抖 localStorage 保存（500ms）
    - 源节点直接更新目标节点（绕过 App.jsx）
  - **效果**: 减少 50% 渲染次数，减少 90% localStorage 写入

- **问题2**: App.jsx 数据传递陷阱
  - **根本原因**: useEffect 只监听 edges 变化，节点内部状态变化不传递到目标节点
  - **解决方案**: 源节点使用 getEdges() 找到连接的节点，一次 setNodes() 直接更新目标节点
  - **关键代码**:
    ```javascript
    // CharacterLibraryNode.jsx - 源节点直接更新
    useEffect(() => {
      const outgoingEdges = edges.filter(e => e.source === nodeId);
      setNodes((nds) =>
        nds.map((node) => {
          // 更新自己
          if (node.id === nodeId) return { ...node, data: { ...node.data, selectedCharacters } };
          // ⭐ 直接更新目标节点
          const isConnected = outgoingEdges.some(e => e.target === node.id);
          if (isConnected) return { ...node, data: { ...node.data, connectedCharacters } };
          return node;
        })
      );
    }, [selectedCharacters, getEdges, setNodes]);
    ```

- **问题3**: 加载历史记录显示错误视频
  - **根本原因**: VideoGenerateNode 调用 getNodes() 时，TaskResultNode 的 useEffect 还没执行
  - **场景**: 连续生成视频时，第二次生成的快照包含第一次的视频结果
  - **解决方案**:
    - **短期**: 加载历史记录时，从历史记录的实际数据覆盖 TaskResultNode
    - **长期**: TaskResultNode 轮询收到结果时立即同步 node.data

- **技术总结**:
  - **React Flow 数据流**: getNodes() 是同步的，useState 是异步的，useEffect 在渲染后执行
  - **关键时刻手动同步**: 在 getNodes() 捕获快照前，手动调用 setNodes() 确保数据同步
  - **防抖重要性**: 500ms 防抖显著提升响应速度

- **测试验证**:
  - ✅ 角色选择即时更新（无卡顿）
  - ✅ 图片选择即时更新（无卡顿）
  - ✅ 提示词自动组装（多角色引用）
  - ✅ localStorage 防抖保存（console.log 验证）

- **文档更新**:
  - SKILL.md: 更新错误16、新增错误34、新增开发提示 15-18
  - code.md: 更新错误16、新增错误34、添加源节点直接更新示例
  - base.md: 新增"节点间数据传递架构"
  - 版本号: v3.3 → v3.4

- **影响文件**:
  - `src/client/src/App.jsx` (防抖 localStorage)
  - `src/client/src/nodes/input/CharacterLibraryNode.jsx` (合并 useEffect)
  - `src/client/src/nodes/input/ReferenceImageNode.jsx` (合并 useEffect)
  - `src/client/src/nodes/process/VideoGenerateNode.jsx` (合并 useEffect)
  - `src/client/src/nodes/output/TaskResultNode.jsx` (工作流快照时机)
  - `.claude/skills/winjin-dev/SKILL.md`
  - `.claude/rules/code.md`
  - `.claude/rules/base.md`

---

### ⚠️ 重大技术纠错：故事板功能理解错误 (2025-12-30) ⭐ 重大纠正

**问题发现**: 在对故事板功能进行深入分析时，发现了一个根本性的理解错误

**错误理解**（之前的实现）:
- ❌ 故事板 = 批量生成多个独立视频
- ❌ 每个镜头调用一次 API
- ❌ 返回 N 个 taskId 数组
- ❌ 显示 "批量生成" 按钮
- ❌ 进度跟踪: total/completed/failed

**正确理解**（API 文档说明）:
- ✅ 故事板 = **单个视频任务**，通过特殊格式描述多个时间段
- ✅ 调用 **一次 API**，返回 **单个 taskId**
- ✅ API 通过特殊提示词格式识别故事板模式

**故事板格式**（贞贞平台文档）:
```
Shot 1:
duration: 7.5sec
Scene: 飞机起飞

Shot 2:
duration: 7.5sec
Scene: 飞机降落
```

**后端实现**（src/server/sora2-client.js 第318-370行）:
- ✅ 已正确实现：拼接故事板格式提示词
- ✅ 已正确实现：收集所有镜头的图片
- ✅ 已正确实现：调用一次统一的视频创建 API

**前端问题**（StoryboardNode.jsx 第55-130行）:
- ❌ 循环调用 N 次 API（每个 shot 一次）
- ❌ 使用不存在的参数: `storyboard_mode`, `shot_index`
- ❌ 未拼接故事板格式的提示词
- ❌ 返回 results 数组而非单个 taskId

**影响范围**:
1. StoryboardNode.jsx（工作流编辑器节点）- 实现错误
2. index.html（网页版故事板功能）- 可能也有问题
3. 所有调用故事板 API 的前端代码 - 需要审查

**修复计划**:
- **Phase 1**: 角色引用集成（仿 VideoGenerateNode）
- **Phase 2**: 修正 API 调用逻辑（移除循环，调用一次）
- **Phase 3**: UI 优化（移除"批量生成"按钮，简化状态）
- **Phase 4**: 测试验证（确认单个 taskId 轮询正常）

**相关文档更新**:
- base.md: 更新故事板模式规范（第161-168行）
- code.md: 添加错误27 - 故事板实现错误（第2736-2853行）
- 开发交接书.md: 添加此纠错记录

**参考文档**:
- `用户输入文件夹/贞贞工坊/Sora2故事板视频.md` - API 格式说明
- `src/server/sora2-client.js` - 后端正确实现

**修复状态**: ✅ 已完成 (2025-12-30)

**修复内容**:
- ✅ Phase 1: 角色引用集成（仿 VideoGenerateNode）
  - 焦点管理: `sceneRefs`, `lastFocusedSceneIndex`
  - 插入功能: `insertCharacterToFocusedScene(username, alias)`
  - 候选角色显示区
- ✅ Phase 2: 修正 API 调用逻辑
  - 移除循环调用，改为单次调用 `/api/video/storyboard`
  - 收集所有图片（全局 + 镜头）
  - 返回单个 taskId，派发事件到 TaskResultNode
- ✅ Phase 3: UI 优化
  - 移除 `progress` 状态
  - 按钮文本: "批量生成" → "生成故事板视频"
  - 移除 1:1 比例选项（Sora2 不支持）
  - duration 改为数字类型（5, 10, 15, 25）
- ✅ Phase 4: 数据流验证
  - 确认 CharacterLibraryNode → StoryboardNode 数据传递正确
  - `connectedCharacters` 数组正常传递

**修复文件**:
- `src/client/src/nodes/process/StoryboardNode.jsx` - 完全重写

**相关文档更新**:
- ✅ base.md: 添加故事板前端实现规范（第170-177行）
- ✅ code.md: 添加前端角色引用代码示例（第2855-2905行）
- ✅ Sora2_Character_Best_Practices.md: 添加第17章故事板节点修复（第2093-2376行）

**Git 提交**: 待提交

---

#### 30. 故事板节点修复完成 (2025-12-30) ⭐ 重大修复
- **功能点1: 角色引用集成**
  - 从 CharacterLibraryNode 获取候选角色列表
  - 点击角色卡片插入到焦点场景的光标位置
  - 焦点管理: 记录最后焦点的场景输入框索引
- **功能点2: API 调用修正**
  - 移除错误的循环调用逻辑（每个 shot 调用一次）
  - 改为调用一次 `/api/video/storyboard` API
  - 返回单个 taskId（而非 N 个 taskId 数组）
- **功能点3: UI 优化**
  - 移除 "批量生成" 按钮文本 → "生成故事板视频"
  - 移除 progress 状态（total/completed/failed）
  - 移除 1:1 比例选项（Sora2 不支持）
  - duration 改为数字类型（5, 10, 15, 25）
- **关键发现**:
  - 故事板本质: 单个视频任务（不是多个视频）
  - 提示词格式: `Shot N:\nduration: Xsec\nScene: Y\n\n`
  - 后端已正确实现（sora2-client.js 第318-370行）

### 已知问题

**⚠️ 重要通知**: 历史记录功能已于 2026-01-01 移除

**移除原因**:
- 用户几乎不使用历史记录功能
- 工作流快照机制导致大量数据同步问题（错误33/34/35）
- 代码复杂度过高（约 2,308 行相关代码）

**简化后的功能**:
- ❌ 移除了复杂的历史记录功能（工作流快照加载）
- ✅ 保留了角色库功能（CharacterLibraryNode）
- ✅ 保留了工作流手动保存功能（WorkflowStorage）
- 🎯 目标：降低代码复杂度，减少维护成本

---

#### 31. 参考图片节点协作功能 (2025-12-30) ⭐ 新增
- **功能点1: ReferenceImageNode 双模式设计**
  - **选择模式**: 多选图片，绿色边框 + ✓ 标识
  - **预览模式**: 点击图片卡片查看大图（模态框）
  - **模式切换**: "选择模式" / "预览模式" 按钮
- **功能点2: 数据传递机制**
  - `selectedImages` Set → `connectedImages` 数组
  - 通过 `useReactFlow.setNodes()` 主动传递数据
  - 自动更新连接节点数据
- **功能点3: VideoGenerateNode 协作**
  - 显示已连接的参考图预览（缩略图网格）
  - API 调用时自动添加到 `images` 参数
  - 状态提示：`🖼️ 已连接参考图 (N 张)`
- **功能点4: StoryboardNode 协作**
  - 显示全局参考图提示：`🖼️ N 张全局参考图`
  - 合并全局图片 + 镜头图片到 API
  - 合并顺序：全局图片在前，镜头图片在后
- **技术设计**:
  - 参考角色库协作模式（多选 + 自动传递）
  - 图片使用方式不同：自动合并到 API（而非手动插入）
  - 支持文生视频/图生视频自动检测
- **相关文档更新**:
  - ✅ base.md: 添加参考图片节点协作规范（第186-202行）
  - ✅ code.md: 添加参考图片节点协作实现示例（第2909-3076行）
  - ✅ 开发交接书.md: 本条目

---

#### 32. 故事板全局图片控制 + 自动时长功能 (2025-12-30) ⭐ 新增
- **功能点1: 全局参考图复选框控制**
  - 添加 `[ ] 启用全局参考图` 复选框
  - 选中时：全局图片应用到所有镜头
  - 未选中时：只使用镜头独立选择的图片
  - 图片合并逻辑：
    - 启用全局: `allImages = [...globalImages, ...shotImages]`
    - 禁用全局: `allImages = [...shotImages]`（只用镜头图片）
- **功能点2: 镜头图片独立选择**
  - 每个镜头添加 📷 按钮
  - 点击打开图片选择器模态框
  - 显示已连接的参考图网格供选择
  - 支持"清除选择"功能
- **功能点3: 总时长自动均分**
  - 添加 `⏱️ 总时长设置` 下拉菜单（5/10/15/25秒）
  - 自动计算：`shotDuration = totalDuration / shots.length`
  - 显示提示：`⏱️ 自动均分 X.X 秒`
  - 超过 25 秒时显示警告：`⚠️ 当前总时长 XX 秒超过 API 限制`
- **后端 API 更新**:
  - sora2-client.js 添加 `duration` 参数支持
  - 传递总时长到 API（如有提供）
- **影响文件**:
  - `src/client/src/nodes/process/StoryboardNode.jsx`
  - `src/server/sora2-client.js`
- **相关文档更新**:
  - ✅ base.md: 添加故事板全局图片控制和自动时长规范（第186-207行）
  - ✅ code.md: 添加完整实现示例（第3036-3324行）
  - ✅ 开发交接书.md: 本条目

---

#### 31. 故事板时长设置改为手动输入 (2025-12-30) ⭐ 重要修复
- **问题**: 自动均分功能与 API 实现冲突，且用户需要更灵活的控制
- **修复**:
  - 移除总时长下拉框（5/10/15/25秒）
  - 移除自动均分逻辑 `shotDuration = totalDuration / shots.length`
  - 为每个镜头添加独立的时长输入框（1-25秒）
  - 实时计算总时长并显示：`⏱️ 总时长: 15 秒`
  - 超过25秒时显示警告
- **⚠️ API 重要修复**:
  - 移除故事板请求中的单独 `duration` 参数
  - 总时长由各镜头时长之和决定
  - 修复了导致 400 错误的参数冲突问题
- **影响文件**:
  - `src/client/src/nodes/process/StoryboardNode.jsx`
  - `src/server/sora2-client.js`
- **相关文档更新**:
  - ✅ base.md: 更新故事板时长规范（第204-209行）
  - ✅ code.md: 添加错误28 - 故事板 duration 参数问题（第2907-2942行）
  - ✅ 开发交接书.md: 本条目

---

#### 33. 表单字段可访问性修复 (2025-12-31) ⭐ Bug 修复
- **问题**: 浏览器控制台显示警告 "A form field element should have an id or name attribute"
- **原因**: 表单字段缺少 `id` 和 `name` 属性
- **修复范围**: 为所有表单字段添加 id 和 name 属性
  - **APISettingsNode.jsx**: 5 个字段（platform, model, aspect, watermark, apiKey）
  - **VideoGenerateNode.jsx**: 1 个字段（duration）
  - **CharacterLibraryNode.jsx**: 3 个字段（searchQuery, filterType, editAlias）
  - **ReferenceImageNode.jsx**: 1 个字段（imageUrl）
  - **CharacterCreateNode.jsx**: 5 个字段（platform, videoUrl, taskId, timestamps, alias）
  - **StoryboardNode.jsx**: 3+ 个字段（useGlobalImages, scene-input-*, duration-*）
- **命名规范**:
  - `id`: 使用 kebab-case，如 `video-url-input`, `platform-select`
  - `name`: 使用 camelCase，如 `videoUrl`, `platform`
- **影响文件**:
  - `src/client/src/nodes/input/APISettingsNode.jsx`
  - `src/client/src/nodes/process/VideoGenerateNode.jsx`
  - `src/client/src/nodes/input/CharacterLibraryNode.jsx`
  - `src/client/src/nodes/input/ReferenceImageNode.jsx`
  - `src/client/src/nodes/process/CharacterCreateNode.jsx`
  - `src/client/src/nodes/process/StoryboardNode.jsx`
- **相关文档更新**:
  - ✅ SKILL.md: 添加开发提示 13
  - ✅ code.md: 添加错误31 - 表单字段缺少 id/name 属性

---

#### 34. 图生视频提示词模式修正 (2025-12-31) ⭐ 重要纠正
- **问题**: 使用参考图片生成视频时，生成结果与参考图片内容无关
- **根本原因**: 提示词未描述参考图片的场景内容
- **错误示例**:
  - ❌ `@装载机 在干活` + 火山场景图 → 生成的视频与火山无关
  - ❌ `火山场景中，一辆黄色装载机在搬运岩石` → 没有使用角色引用
- **正确模式**: 参考图片 = 场景背景，角色引用 = 场景中的演员
  - ✅ `卡通风格的火山场景，火山口有熔岩流动，底部冒白烟，蓝天白云背景。@装载机 在火山附近作业，正在搬运岩石，卡通插画风格` + 火山场景图
- **提示词结构建议**:
  1. **场景描述**: 主体、外观、环境、氛围（来自参考图片）
  2. **角色引用**: `@username` 格式
  3. **活动描述**: 角色在场景中的具体动作
  4. **风格说明**: 卡通/写实等
- **关键点**:
  - 参考图片提供场景基础（如火山、街道、海滩）
  - 提示词必须描述参考图片的内容
  - 角色引用描述角色在场景中的活动
  - 使用 `@username` 格式调用角色，不要硬编码
- **相关文档更新**:
  - ✅ SKILL.md: 添加错误23 - 图生视频提示词未描述参考图内容
  - ✅ SKILL.md: 添加开发提示 12
  - ✅ code.md: 添加错误30 - 图生视频提示词未描述参考图内容

---

#### 35. ComfyUI 风格历史记录管理规划 (2025-12-31) ⭐ 规划
- **功能点1: 历史记录面板**
  - 左侧侧边栏，320px 宽度
  - 显示历史记录卡片列表
  - 搜索和筛选功能
- **功能点2: 历史记录卡片**
  - 缩略图/视频预览
  - 提示词预览（2行截断）
  - 状态、类型、平台标签
  - 相对时间显示
  - 收藏功能
- **功能点3: 工作流恢复**
  - 点击卡片恢复完整工作流
  - 保存 workflowSnapshot 到历史记录
  - 视频生成时自动捕获工作流状态

#### 36. 历史记录卡片视频显示和参数面板修复 (2025-12-31) ⭐ Bug 修复
- **问题**: 历史记录卡片只显示占位符，不显示视频和工作流参数
- **解决**:
  - **视频显示**: 优先级检查 thumbnail → result.output → 占位符
  - **悬停播放**: 鼠标悬停时播放视频，移开时暂停并重置
  - **参数面板**: 显示模型、时长、比例、水印等参数
  - **视频链接**: 可点击的视频 URL（不触发卡片点击）
- **技术实现**:
  ```javascript
  // ✅ 显示视频或缩略图
  {thumbnail ? (
    <img src={thumbnail} alt="视频缩略图" />
  ) : result?.output ? (
    <video
      src={result.output}
      muted
      onMouseEnter={(e) => e.currentTarget.play().catch(() => {})}
      onMouseLeave={(e) => {
        e.currentTarget.pause();
        e.currentTarget.currentTime = 0;
      }}
    />
  ) : (
    <div>🖼️</div>
  )}

  // ✅ 工作流参数面板
  {(model || options) && (
    <div style={{ backgroundColor: '#f8fafc' }}>
      {model && <div><strong>模型:</strong> {model}</div>}
      {options?.duration && <div><strong>时长:</strong> {options.duration}秒</div>}
      {options?.aspect_ratio && <div><strong>比例:</strong> {options.aspect_ratio}</div>}
      {options?.watermark !== undefined && <div><strong>水印:</strong> {options.watermark ? '开启' : '关闭'}</div>}
      {result?.output && <div><strong>视频:</strong> <a href={result.output} target="_blank" onClick={(e) => e.stopPropagation()}>...</a></div>}
    </div>
  )}
  ```
- **影响文件**:
  - `src/client/src/components/HistoryPanel/HistoryCard.jsx`
  - 修复视频显示、参数面板、链接点击行为
- **需求**: 类似 ComfyUI 的历史记录管理界面
- **核心功能**:
  - **历史记录侧边面板**: 显示所有任务历史记录
  - **卡片式布局**: 缩略图、提示词、状态、时间
  - **点击加载工作流**: 点击历史卡片恢复工作流
  - **筛选和搜索**: 按状态、平台、类型、日期筛选
  - **右键菜单**: 删除、复制提示词、复制工作流 JSON
  - **收藏功能**: 标记常用工作流
  - **批量操作**: 批量删除、导出、导入
- **数据结构扩展**:
  - `workflowSnapshot`: 工作流快照（nodes, edges, viewport）
  - `thumbnail`: 缩略图 URL
  - `tags`: 标签数组
  - `favorite`: 是否收藏
  - `viewedCount`: 查看次数
  - `promptLower`: 提示词小写版本（搜索优化）
  - `type`: 任务类型（text-to-video, image-to-video, storyboard）
- **组件架构**:
  ```
  src/client/src/components/HistoryPanel/
  ├── HistoryPanel.jsx          # 主面板容器
  ├── HistoryCard.jsx           # 单个历史卡片
  ├── HistorySearchBar.jsx      # 搜索栏
  ├── HistoryToolbar.jsx        # 工具栏
  ├── HistoryDetailsModal.jsx   # 详情模态框
  └── HistoryContextMenu.jsx    # 右键菜单
  ```
- **开发阶段**:
  - **Phase 1**: 基础显示（侧边面板、卡片、筛选、分页）
  - **Phase 2**: 核心交互（加载工作流、右键菜单、搜索）
  - **Phase 3**: 高级功能（批量操作、标签、统计、缩略图）
- **相关文档**:
  - ✅ `.claude/skills/winjin-dev/references/history-management.md` - 详细规划文档

---

#### 37. 历史记录管理功能和快照持久化修复 (2025-12-31) ⭐ 重要修复
- **功能点1: 后端 API 实现**
  - **收藏 API**: `PUT /api/history/:taskId/favorite` - 设置收藏状态
  - **删除 API**: `DELETE /api/history/:taskId` - 删除单条记录
  - **清空 API**: `DELETE /api/history/all` - 清空所有记录
  - **后端文件**: `src/server/index.js` (第 642-669 行)
- **功能点2: 前端 UI 组件**
  - **HistoryCard**: 添加收藏按钮（可点击切换）和删除按钮（Hover 显示）
  - **HistoryPanel**: 加载确认对话框、删除确认对话框、清空确认对话框
  - **HistoryToolbar**: 添加"我的收藏"筛选选项和"清空全部"按钮
- **功能点3: 工作流快照持久化修复** ⭐ 关键
  - **问题**: 加载的工作流只有节点，缺少参数（manualPrompt, shots 等）
  - **根本原因**:
    - useState 只在组件内部，不会自动同步到 node.data
    - useEffect 在渲染后执行，但 getNodes() 可能在 useEffect 之前调用
  - **解决方案**:
    1. **初始化**: 从 `data` 属性初始化 useState（支持工作流恢复）
    2. **useEffect 同步**: 当 useState 变化时同步到 node.data
    3. **关键修复**: 在 getNodes() 之前手动调用 setNodes() 同步数据
  - **修复文件**:
    - `src/client/src/nodes/process/VideoGenerateNode.jsx`
    - `src/client/src/nodes/process/StoryboardNode.jsx`
  - **修复模式**:
    ```javascript
    // 1. 从 data 初始化 useState
    const [manualPrompt, setManualPrompt] = useState(data.manualPrompt || '');

    // 2. useEffect: 同步到 node.data
    useEffect(() => {
      if (manualPrompt !== data.manualPrompt) {
        setNodes((nds) =>
          nds.map((node) =>
            node.id === nodeId
              ? { ...node, data: { ...node.data, manualPrompt } }
              : node
          )
        );
      }
    }, [manualPrompt, nodeId, setNodes, data.manualPrompt]);

    // 3. 关键修复：在 getNodes() 之前手动同步
    const handleGenerate = async () => {
      setNodes((nds) =>
        nds.map((node) =>
          node.id === nodeId
            ? { ...node, data: { ...node.data, manualPrompt } }
            : node
        )
      );
      const workflowSnapshot = {
        nodes: getNodes(),  // 现在包含最新的 manualPrompt
        edges: getEdges(),
      };
    };
    ```
- **测试结果**:
  - ✅ 收藏功能: 点击星标切换收藏状态
  - ✅ 删除功能: 点击删除按钮删除单条记录
  - ✅ 清空功能: 点击"清空全部"清空所有记录
  - ✅ 工作流恢复: 加载历史记录恢复完整工作流（包含所有参数）
- **相关文档更新**:
  - ✅ code.md: 添加错误33 - 工作流快照持久化时机问题（第 3714-3885 行）
  - ✅ 开发交接书.md: 版本号更新到 v3.3，本条目

---

### 待开发功能

#### 13. 工作流保存/加载功能 (待开发) ⏳
- **功能**: 保存当前工作流配置，支持快速加载
- **格式**: JSON 文件存储节点位置、连接关系、参数配置
- **模板库**: 预设常用工作流模板

---

## 🎉 重大里程碑：可视化节点工作流系统完成！ (2025-12-30)

#### 12. 可视化节点工作流系统 ✅ 已完成

**实现概述**：
成功实现完整的 ComfyUI 风格可视化节点工作流编辑器，包含 9 种节点类型、智能执行引擎、实时数据流传递。

**核心功能**：
1. **React Flow 画布** - 拖拽节点布局、贝塞尔曲线连线
2. **8 种节点类型** - 3 输入 + 3 处理 + 2 输出
3. **执行引擎** - 拓扑排序自动执行、进度实时反馈
4. **工具栏 UI** - 执行/重置按钮、状态显示

**节点清单**：

**输入节点 (3个)** - 蓝色系:
- 📝 文本节点 - 提示词输入 (TextNode.jsx)
- 🖼️ 参考图片节点 - 图片URL管理 (ReferenceImageNode.jsx)
- 📊 角色库节点 - 浏览并选择角色 (CharacterLibraryNode.jsx)

**处理节点 (3个)** - 绿色系:
- 🎭 角色生成节点 - URL/任务ID创建角色 (CharacterCreateNode.jsx)
- 🎬 视频生成节点 - 文生视频 (VideoGenerateNode.jsx)
- 🎞️ 故事板节点 - 单个视频任务，多时间段描述 (StoryboardNode.jsx) ⚠️ 实现有误，待修复

**输出节点 (2个)** - 天蓝系:
- 📺 任务结果节点 - 视频预览/下载 (TaskResultNode.jsx)
- 📋 执行日志节点 - 日志展示 (ExecutionLogNode.jsx)

**技术实现**：
- React 19 + React Flow 11.x
- Vite 7.x 构建工具
- 自定义 useWorkflowExecution Hook
- 拓扑排序算法
- 循环依赖检测

**Git 提交记录**：
```
1bc576f feat: Phase 5 - Implement output nodes
9da8039 feat: Phase 4 - Implement workflow execution engine
042b0ca feat: Phase 3 - Implement all process nodes
8a4d596 feat: Phase 2 - Implement all input nodes
b5b21c8 feat: Phase 1 - React Flow workflow editor foundation
```

**访问地址**：
- 工作流编辑器: http://localhost:5173
- 启动命令: `cd src/client && npm run dev`

**项目结构**：
```
src/client/
├── src/
│   ├── nodes/
│   │   ├── input/    # 4个输入节点
│   │   ├── process/  # 3个处理节点
│   │   └── output/   # 2个输出节点
│   ├── hooks/
│   │   └── useWorkflowExecution.js
│   └── App.jsx
```

**功能验证**：
- ✅ 所有节点正常渲染
- ✅ 节点可拖拽/连接
- ✅ 执行引擎正确排序
- ✅ 数据流自动传递

---

### 重大 Bug 修复 🐛

#### 14. TaskResultNode API 端点路径修复 (2025-12-30) ⭐ 重大修复
- **问题**: TaskResultNode 轮询任务状态时返回 404 错误
- **原因**: API 路径缺少 `/api/` 前缀
  - 错误: `http://localhost:9000/task/{taskId}` → 404
  - 正确: `http://localhost:9000/api/task/{taskId}` → 200
- **影响**: 视频任务完成后无法显示结果
- **修复位置**:
  - `src/client/src/nodes/output/TaskResultNode.jsx` (第66行、第102行)
- **修复内容**:
  - 轮询函数: 添加 `/api/` 前缀
  - 手动刷新函数: 添加 `/api/` 前缀
- **验证结果**:
  - ✅ API 请求成功返回 200 OK
  - ✅ 任务状态正确轮询
  - ✅ 视频URL正确显示
  - ✅ taskId 通过事件系统正确传递

#### 15. 工作流节点数据流修复 (2025-12-30)

**问题描述**：
- 任务结果节点未接收到来自视频生成节点的 taskId
- 执行日志节点未显示工作流执行日志
- 导致输出节点无法正常工作

**修复内容**：

1. **修复无限循环问题**
   - 移除 useEffect 依赖数组中的 `nodes`
   - 使用函数式更新自动获取最新节点数据
   - 文件：App.jsx:206

2. **修复 taskId 传递**
   - VideoGenerateNode 使用 `useNodeId()` 获取节点 ID
   - 通过 `setNodes()` 更新 node.data.taskId
   - 派发自定义事件 'video-task-created' 通知连接的节点
   - 文件：VideoGenerateNode.jsx:7,85-87

3. **修复事件监听**
   - TaskResultNode 监听 'video-task-created' 事件
   - 检查 connectedSourceId 匹配后更新 taskId
   - 支持自动轮询任务状态
   - 文件：TaskResultNode.jsx:26-37

4. **修复执行日志传递**
   - useWorkflowExecution 添加 logs 数组到 executionState
   - 创建 addLog() 辅助函数记录执行步骤
   - App.jsx 传递 logs 到 ExecutionLogNode
   - 文件：useWorkflowExecution.js:9-19,77-81

5. **添加 connectedSourceId 传递**
   - App.jsx 在连接时传递 source node ID
   - TaskResultNode 使用 connectedSourceId 验证事件来源
   - 文件：App.jsx:194-196

**技术要点**：
- React Flow 的 data 不包含节点 id，必须使用 useNodeId()
- setNodes() 是异步批处理，不能依赖 getNodes() 获取最新数据
- 使用自定义事件系统实现节点间实时通信
- useEffect 依赖数组不能包含会导致自身更新的状态

**验证结果**：
- ✅ 文本节点 → 视频生成节点：提示词正确传递
- ✅ 视频生成 → 任务结果节点：taskId 通过事件正确传递
- ✅ 任务结果节点：显示 taskId 并自动轮询状态
- ✅ 执行日志节点：显示完整工作流执行日志

**相关文档更新**：
- code.md：添加 "错误16: React Flow 节点间数据传递错误"

---

#### 16. 视频生成节点时长参数修复 (2025-12-30) ⭐ 新增
- **问题**:
  - Sora2 API 不支持 1:1 比例
  - 时长参数类型错误（字符串而非数字）
- **修复**:
  - 移除 1:1 比例选项，只保留 16:9 和 9:16
  - 添加时长下拉菜单：5秒、10秒、15秒、25秒
  - 时长参数从字符串改为数字类型
- **影响文件**: `src/client/src/nodes/process/VideoGenerateNode.jsx`

#### 17. 任务结果节点增强功能 (2025-12-30) ⭐ 新增
- **新增功能**:
  - 📋 复制 TaskId 按钮（带 2 秒反馈提示）
  - 🔗 复制视频链接按钮
  - 🔄 手动查询状态按钮
  - 支持旧浏览器降级（execCommand 备选方案）
- **技术实现**:
  - 使用 navigator.clipboard API（现代浏览器）
  - 降级方案：document.execCommand('copy')（旧浏览器）
  - 复制成功后显示 2 秒反馈提示
- **影响文件**: `src/client/src/nodes/output/TaskResultNode.jsx`

#### 18. 工作流管理系统 (2025-12-30) ⭐ 新增
- **核心功能**:
  - 💾 **保存工作流** - 保存到当前工作流或另存为新名称
  - 📂 **打开工作流** - 列表查看并加载已保存的工作流
  - ➕ **新建工作流** - 清空当前工作流（带确认对话框）
  - 🗑️ **删除工作流** - 删除指定工作流（带确认对话框）
  - 📤 **导出工作流** - 下载为 JSON 文件
  - 📥 **导入工作流** - 从 JSON 文件导入（自动重命名避免冲突）
  - 📁 **当前工作流显示** - 工具栏显示蓝色标签
- **技术实现**:
  - 创建 `WorkflowStorage` 工具类（`src/client/src/utils/workflowStorage.js`）
  - localStorage 持久化存储（键名：`winjin-workflows`）
  - 自动管理 nextNodeId（加载工作流后自动递增）
  - 完整的 UI 对话框和下拉菜单
  - 数据验证（导入时检查必需字段）
  - 冲突处理（导入时自动添加后缀避免覆盖）
- **影响文件**:
  - `src/client/src/utils/workflowStorage.js` (新增)
  - `src/client/src/App.jsx` (工作流管理 UI)
- **存储结构**:
  ```javascript
  {
    "工作流名称": {
      name: "工作流名称",
      description: "工作流描述",
      nodes: [...],      // React Flow 节点数组
      edges: [...],      // React Flow 连线数组
      createdAt: "2025-12-30T12:00:00.000Z",
      updatedAt: "2025-12-30T12:30:00.000Z"
    }
  }
  ```

#### 19. 节点管理增强功能 (2025-12-30) ⭐ 新增
- **右键菜单功能**:
  - **节点菜单**: 复制节点、删除节点
  - **画布菜单**: 粘贴节点、添加所有节点类型
  - **点击外部**: 自动关闭菜单
- **节点删除修复**:
  - **上下文删除**: 删除右键点击的特定节点（`deleteNode(node)`）
  - **工具栏删除**: 删除所有选中节点（`deleteSelectedNodes()`）
  - **快捷键**: Delete 键删除选中节点
- **节点创建位置修复**:
  - **右键创建**: 使用 `screenToFlowPosition()` 转换坐标
  - **问题**: 之前使用 `project()`（已废弃）或 viewport 坐标，节点位置不正确
  - **解决**: 使用正确的坐标转换 API
- **影响文件**:
  - `src/client/src/App.jsx` (节点管理逻辑)
  - `src/client/src/main.jsx` (添加 ReactFlowProvider)

#### 20. 角色结果节点 (2025-12-30) ⭐ 新增
- **功能描述**:
  - 显示角色创建任务的详细结果
  - 通过事件系统从 CharacterCreateNode 接收角色数据
  - 提供复制到剪贴板功能（角色 ID、用户名）
- **数据格式**:
  ```javascript
  {
    id: "ch_69536e7ce60481919c4e9a2a3cf4c6d5",
    username: "de3602969.sunnykitty",
    permalink: "https://sora.chatgpt.com/profile/...",
    profile_picture_url: "https://...",
    alias: "可选别名"
  }
  ```
- **事件系统**:
  - 事件名: `character-created`
  - 事件数据: `{ sourceNodeId, character }`
  - 验证逻辑: 检查 `data.connectedSourceId === event.detail.sourceNodeId`
- **技术实现**:
  - 输入端口: `character-input` (左侧)
  - 无输出端口（纯展示节点）
  - 剪贴板 API: 优先 `navigator.clipboard`，降级 `execCommand`
  - 复制反馈: 显示 "✓ 已复制" 2 秒
- **影响文件**:
  - `src/client/src/nodes/output/CharacterResultNode.jsx` (新增)
  - `src/client/src/nodes/process/CharacterCreateNode.jsx` (添加事件派发)

#### 21. 编译错误修复 (2025-12-30) ⭐ Bug 修复
- **问题**: Babel 编译错误 - "Identifier 'characterEdge' has already been declared"
- **原因**: App.jsx 中同一作用域内重复声明 `characterEdge` 变量
- **解决**: 合并相关逻辑，只声明一次变量，使用条件分支处理不同场景
- **影响文件**: `src/client/src/App.jsx` (第 207-221 行)

#### 22. 角色库管理功能 (2025-12-30) ⭐ 新增
- **功能点1: 单个角色删除**
  - 悬停显示删除按钮（✕）在角色卡片右上角
  - 点击删除按钮弹出确认对话框
  - 显示 "⚠️ 确认删除" 和 "此操作不可恢复!" 警告
  - 删除成功后重新加载角色列表
- **功能点2: 编辑角色别名**
  - 点击角色卡片打开编辑对话框
  - 显示用户名、角色 ID 和当前别名
  - 输入新别名（最多 50 字符）
  - 保存/取消按钮，成功后显示 "✅ 别名已更新"
- **功能点3: 批量选择模式**
  - "批量操作" 按钮切换批量模式
  - 点击角色卡片进行选择/取消选择
  - 黄色边框和背景表示选中状态
  - 复选框显示选中标记（✓）
- **功能点4: 批量删除功能**
  - "全选" / "取消全选" 按钮
  - "删除 (N)" 按钮显示已选数量
  - 确认对话框显示删除数量
  - 并发调用删除 API（Promise.all）
- **技术实现**:
  - 7 个新状态变量（batchMode, selectedCharacters, editingCharacter 等）
  - 4 个新异步函数（deleteCharacter, updateAlias, deleteBatchCharacters 等）
  - 2 个模态对话框（编辑别名、删除确认）
  - UI 视觉反馈（选中状态、按钮状态）
- **API 集成**:
  - `DELETE /api/character/:characterId` - 删除单个角色
  - `PUT /api/character/:characterId/alias` - 更新别名
- **测试结果**:
  - ✅ 编辑别名: 成功更新 "5562be00d.sunbeamkit" → "阳光小猫"
  - ✅ 批量选择: 全选/取消全选/单个选择正常工作
  - ✅ 单个删除: 确认对话框和删除功能正常
  - ✅ 批量删除: 并发删除多个角色成功
- **影响文件**:
  - `src/client/src/nodes/input/CharacterLibraryNode.jsx` (419 行新增代码)

#### 23. 移除角色选择节点 (2025-12-30) ⭐ 重构
- **问题**: CharacterSelectNode 和 CharacterLibraryNode 功能重复
- **原因**:
  - 两个节点都能选择角色，造成用户困惑
  - CharacterSelectNode 有 API 路径 bug（缺少 /api/ 前缀）
  - CharacterLibraryNode 功能更完善（搜索、筛选、收藏、管理）
  - CharacterSelectNode 没有独特优势
- **解决方案**: 移除 CharacterSelectNode，统一使用 CharacterLibraryNode
- **变更内容**:
  - 从 App.jsx 移除 CharacterSelectNode 导入
  - 从 nodeTypes 对象移除 characterSelectNode
  - 从 nodeTemplates 数组移除 characterSelectNode
  - 删除 CharacterSelectNode.jsx 文件（192 行代码）
  - 节点数量从 9 个减少到 8 个
- **影响范围**:
  - 输入节点从 4 个减少到 3 个
  - 工作流编辑器节点模板更简洁
  - 用户使用 CharacterLibraryNode 选择角色（功能更强大）
- **影响文件**:
  - `src/client/src/App.jsx` (移除导入和注册)
  - `src/client/src/nodes/input/CharacterSelectNode.jsx` (删除文件)

#### 24. 角色引用策略设计 (2025-12-30) ⭐ 架构设计
- **需求**: 在视频生成节点中快速输入多角色引用
  - 示例: `@user_name1 一边吃饭，一边和 @user_name2 聊天`
- **设计方案**: 混合策略（方案三）
  - **Layer 1: 连接的角色**（自动获取）
    - 从 `character` 输入端口自动获取
    - 显示为 `[🔗 已连接]` 标识
    - 作为基础角色，不可手动删除
  - **Layer 2: 收藏夹角色**（快速访问）
    - 显示收藏的角色列表（快速选择）
    - 点击添加到【当前使用角色】
    - 适合：常用角色
  - **Layer 3: 角色库搜索**（按需选择）
    - 搜索框 + 角色列表
    - 点击添加到【当前使用角色】
    - 适合：一次性使用或新创建的角色
- **角色引用格式**:
  - 格式：`@username`（不带花括号）
  - 示例：`@user1 一边吃饭，一边和 @user2 聊天`
  - 位置：自动在提示词开头插入所有角色引用
  - 顺序：按【当前使用角色】列表顺序排列
- **提示词组装逻辑**:
  ```javascript
  function assemblePrompt(userPrompt, allCharacters) {
    const roleRefs = allCharacters
      .map(c => `@${c.username}`)
      .join(' ');
    return `${roleRefs} ${userPrompt}`.trim();
  }
  ```
- **数据流**:
  ```
  CharacterLibraryNode (单选)
    ↓ character (对象)
  VideoGenerateNode
    ↓ 接收并显示到【已连接角色】
    ↓ 用户手动添加更多角色（可选）
    ↓ 【当前使用角色】列表
    ↓ 自动组装到提示词开头
  ```
- **MVP 范围**:
  - 只实现 Layer 1（连接的角色）
  - 自动在提示词开头插入角色引用
  - 显示连接角色卡片（头像、用户名）
- **文档更新**:
  - `base.md`: 添加角色引用策略章节（第 261-308 行）
  - `code.md`: 添加角色引用实现代码示例（第 1431-1655 行）

#### 25. 角色引用 MVP 实现 (2025-12-30) ⭐ 新增
- **功能**: 实现角色库节点到视频生成节点的角色引用传递
- **MVP 范围**:
  - 显示从 CharacterLibraryNode 连接的角色
  - 显示角色卡片（头像、用户名、别名）
  - 自动在提示词开头插入 `@username` 引用
  - 显示最终提示词预览
- **CharacterLibraryNode 实现**:
  - 添加 `selectedCharacter` 状态（单个角色选择）
  - 点击角色卡片选中/取消选中
  - 显示绿色选中标识（✓）在左上角
  - 绿色背景和边框显示选中状态
  - 双击打开编辑别名对话框（保留原有功能）
  - 使用 `useNodeId()` 获取节点 ID
  - 使用 `useReactFlow()` 主动更新连接的目标节点
  - 移除调试日志
- **VideoGenerateNode 实现**:
  - 显示 `[🔗 已连接角色]` 标题
  - 完整角色卡片：32x32 头像（圆形）、别名（粗体）、@username（等宽）
  - 未连接时显示黄色虚线边框提示
  - 最终提示词预览：`📤 最终提示词: @username 提示词`
- **数据流**:
  ```
  CharacterLibraryNode (点击角色)
    ↓ selectedCharacter (状态)
    ↓ setNodes() 更新连接节点
    ↓ connectedCharacter (传递)
  VideoGenerateNode
    ↓ 接收并显示角色卡片
    ↓ 自动组装提示词
  ```
- **技术实现**:
  - `CharacterLibraryNode.jsx`: 新增 120 行代码
  - `VideoGenerateNode.jsx`: 修改 100 行代码
  - 使用 useReactFlow hook 进行节点间数据传递
  - useEffect 监听 selectedCharacter 变化
- **测试结果**:
  - ✅ 角色选择：点击显示绿色 ✓ 标识
  - ✅ 数据传递：CharacterLibraryNode → VideoGenerateNode
  - ✅ 角色显示：`阳光小猫 @5562be00d.sunbeamkit`
  - ✅ 提示词预览：`📤 最终提示词: @5562be00d.sunbeamkit 在花园里玩耍`
  - ✅ 双击编辑：保留原有编辑别名功能
- **Git 提交**: `18762bd`
- **影响文件**:
  - `src/client/src/nodes/input/CharacterLibraryNode.jsx`
  - `src/client/src/nodes/process/VideoGenerateNode.jsx`

#### 26. 视频播放和下载问题修复 (2026-01-01) ⭐ Bug 修复
- **问题描述**:
  - 生成视频后，任务结果节点未自动更新状态
  - 手动查询任务后，显示视频的黑屏图片，点击无法播放
  - 点击下载视频，下载了一个非视频文件
- **根本原因**:
  1. 轮询间隔错误：5秒间隔（违反SKILL.md错误6，导致429 Rate Limit）
  2. 视频URL为相对路径：`/downloads/xxx.mp4`
  3. 浏览器解析错误：`http://localhost:5173/downloads/...`（错误端口）
  4. 视频文件在9000端口服务器，导致404无法播放
- **修复内容**:
  - **轮询间隔修复**: 从5000ms改为30000ms（符合SKILL.md错误6规范）
  - **URL前缀处理**: 检查路径是否以`/downloads/`开头，拼接`API_BASE`前缀
  - **缓存破坏**: 手动刷新添加`&_t=Date.now()`参数
  - **路径处理逻辑**:
    ```javascript
    let finalVideoUrl = taskData.output;
    if (finalVideoUrl.startsWith('/downloads/')) {
      finalVideoUrl = `${API_BASE}${finalVideoUrl}`;
    }
    ```
- **修复文件**: `src/client/src/nodes/output/TaskResultNode.jsx` (第162-278行)
- **验证结果**:
  - ✅ 视频播放正常（时长0:09）
  - ✅ 下载链接指向正确端口（9000）
  - ✅ 任务状态显示"✓ 完成"
  - ✅ 视频URL：`http://localhost:9000/downloads/9c904c7d-f001-4724-aa44-6237d45d7bba.mp4`
- **相关文档更新**:
  - SKILL.md: 添加错误25 - 本地视频URL缺少完整前缀导致无法播放
  - code.md: 添加错误25 - URL前缀处理和缓存破坏
  - 开发交接书.md: 本条目

---

## 已知问题 ⚠️ 待修复

### 问题 1: 故事板每个镜头参考图生效性待验证 ⏳
- **描述**: 故事板每个镜头使用参考图+角色的方式生成视频，需要验证每个分镜头的参考图是否生效
- **验证方法**: 检查 API 请求体中的 images 数组是否包含所有镜头的图片
- **回退方案**: 如果不支持每个分镜头使用参考图，退回到全局只用一张参考图
- **影响文件**:
  - `src/client/src/nodes/process/StoryboardNode.jsx`
  - `src/server/sora2-client.js`
- **优先级**: 中

### 问题 2: ✅ TaskResultNode 响应bug - 已修复 (2025-12-30)
- **描述**: 画布中有多个任务结果节点时，提交任务时所有同类节点都响应，而不是只有连接的节点响应
- **影响**:
  - 同一画布批量运行任务时，所有 TaskResultNode 都会显示相同的结果
  - 无法区分不同视频生成任务的结果
- **原因**: 未连接的节点仍然设置了事件监听器
- **解决方案**: 只有当 `connectedSourceId` 存在时才设置事件监听器
- **影响文件**:
  - `src/client/src/nodes/output/TaskResultNode.jsx`
  - `src/client/src/nodes/output/CharacterResultNode.jsx`
- **Git 提交**: `a384c98 fix: prevent unconnected result nodes from responding to events`

### 问题 3: ✅ 故事板总时长选项未生效 - 已修复 (2025-12-30)
- **描述**: 故事板节点总时长选项（5/10/15/25秒）没有生效
- **原因**:
  1. API 要求 `duration` 参数为字符串类型（`'10'`, `'15'`, `'25'`）
  2. 前端传递的是数字类型（10, 15, 25）
  3. API 不支持 5 秒选项
- **解决方案**:
  1. 将 duration 转换为字符串：`String(totalDuration)`
  2. 移除 5 秒选项，只保留 10/15/25 秒
  3. 添加说明：25 秒仅 sora-2-pro 支持
- **影响文件**:
  - `src/client/src/nodes/process/StoryboardNode.jsx`
- **Git 提交**: `dde03d3 fix: storyboard duration parameter support`

---

## 注意事项

### ⚠️ 禁止事项

1. **禁止使用 child_process 调用 API**
   ```javascript
   // ❌ 错误：会导致进程僵死
   const { spawn } = require('child_process');
   spawn('curl', ['https://api...']);

   // ✅ 正确：使用 axios
   const axios = require('axios');
   await axios.post('https://api...', data);
   ```

2. **禁止硬编码 API Key**
   ```javascript
   // ❌ 错误
   const apiKey = 'sk-1234567890';

   // ✅ 正确
   const apiKey = process.env.SORA2_API_KEY;
   ```

3. **禁止创建角色时传递 model 参数**
   ```javascript
   // ❌ 错误：会导致 404 错误
   await axios.post('/sora/v1/characters', {
     model: 'sora-2',  // ❌ 删除此行
     url: videoUrl,
     timestamps: '1,3'
   });

   // ✅ 正确
   await axios.post('/sora/v1/characters', {
     from_task: taskId,
     timestamps: '1,3'
   });
   ```

4. **禁止使用错误的查询端点**
   ```javascript
   // ❌ 错误：对聚鑫使用贞贞的端点
   await axios.get(`https://api.jxincm.cn/v2/videos/generations/${taskId}`);

   // ✅ 正确：聚鑫使用查询参数
   await axios.get('https://api.jxincm.cn/v1/video/query', {
     params: { id: taskId }
   });
   ```

5. **模型名称差异** ⭐ (2026-01-02 更新)
   - **聚鑫平台**: 必须使用 `sora-2-all`（唯一支持）
   - **贞贞平台**: 使用 `sora-2` 或 `sora-2-pro`
   - **后端自动选择**: 已实现平台自动切换逻辑
   - **前端配置**: APISettingsNode 默认值需同步
   - **角色创建**: 所有平台都不传 `model` 参数

6. **禁止假设任务ID字段名称** ⭐ 新增
   ```javascript
   // ❌ 错误：只检查 id 字段
   if (result.success && result.data?.id) {
     // 贞贞平台的视频不会被保存
   }

   // ✅ 正确：兼容双平台
   const taskId = result.data.id || result.data.task_id;
   if (taskId) {
     historyStorage.addRecord({ taskId, platform, prompt, model, options });
   }
   ```

7. **禁止使用错误的角色引用格式** ⭐ 新增
   ```javascript
   // ❌ 错误：使用花括号
   const prompt = '@{username} 在工地上干活';

   // ✅ 正确：不使用花括号
   const prompt = '@username 在工地上干活';
   ```

8. **禁止混淆测试目标（网页版 vs 工作流画布）** ⭐ 新增
   ```bash
   # ❌ 错误：只启动后端，访问网页版
   npm run server
   # 浏览器打开 localhost:9000  ← 这是网页版，不是工作流画布！

   # ✅ 正确：同时启动后端和前端，访问工作流画布
   # 终端1
   npm run server
   # 终端2
   cd src/client && npm run dev
   # 浏览器打开 localhost:5173  ← 这才是工作流画布！
   ```

   **关键区别**：
   - `localhost:9000` → 网页版（旧版 HTML）
   - `localhost:5173` → **工作流画布（React Flow，当前开发重点）** ⭐

### ✅ 推荐做法

1. **角色创建优先使用 from_task**
   - 更可靠，避免视频 URL 访问问题
   - 从已完成的视频任务创建

2. **轮询间隔要合理**
   - Sora2 视频生成需要 3-5 分钟
   - 推荐轮询间隔：30 秒（已实现）
   - 过短会导致 429 Rate Limit 错误

3. **使用统一的响应格式**
   - 所有 API 返回 `{success, data/error}`
   - 便于前端处理

4. **自动保存到存储**
   - 视频创建成功 → 自动保存到历史记录
   - 角色创建成功 → 自动保存到角色库
   - 任务完成 → 后台轮询自动更新状态

5. **双平台兼容处理** ⭐ 新增
   - 始终使用 `result.data.id || result.data.task_id` 获取任务ID
   - 根据平台选择正确的查询端点

6. **参考图片功能** ⭐ 新增
   - **先分析图片再写提示词**: 使用图片分析工具理解内容，然后写出相关性强的提示词
   - **提示词结构**: 包含主体、外观、动作、环境、氛围五个要素
   - **故事板图片收集**: 后端自动收集所有镜头的 `shot.image` 并合并到 `images` 数组
   - **角色与图片混合**: 参考图片作为场景，角色在场景中活动
   - **自动检测模式**: 有图片自动使用图生视频，无图片使用文生视频

---

## 故障排查 (2026-01-02 更新) ⭐

### 问题 1: 后端代码修改不生效 ⭐ 新增

**现象**: 修改 `sora2-client.js` 后,日志无变化,调试信息未输出

**原因**: Node.js 模块缓存 - 已加载的模块不会重新加载

**解决方案**:
```bash
# 1. 停止服务器
Ctrl+C

# 2. 重新启动
npm run server

# 3. 验证 - 查看调试日志是否出现
```

**预防措施**: 修改后端代码后必须重启服务器

---

### 问题 2: Windows 端口被占用 (EADDRINUSE) ⭐ 新增

**现象**:
- `Error: listen EADDRINUSE: address already in use :::9000`
- Git 提交时报错: `error: short read while indexing nul`

**原因**:
- Windows 保留设备名 `nul` 被意外创建为文件
- Node.js 进程未完全退出

**解决方案**:
```bash
# 1. 删除 nul 文件
del nul

# 2. 强制结束所有 Node 进程
taskkill /F /IM node.exe

# 3. 或结束特定 PID
netstat -ano | findstr :9000
# 找到 PID (例如: 12345)
taskkill /F /PID 12345
```

---

### 问题 3: 贞贞平台视频未保存到历史

**现象**: 使用贞贞平台创建视频后，历史记录中找不到

**原因**: 贞贞返回 `{task_id}`, 聚鑫返回 `{id}`，代码只检查了 `id`

**解决方案**:
```javascript
// ✅ 兼容双平台
const taskId = result.data.id || result.data.task_id;
if (taskId) {
  historyStorage.addRecord({ taskId, platform, prompt, model, options });
}
```

### 问题 2: 角色创建返回 500 错误

**现象**: 使用视频 URL 创建角色失败，返回 "Request failed with status code 500"

**原因**: 视频无法访问（防盗链/过期/需要特殊 headers）

**解决方案**: 使用 `from_task` 参数
```javascript
// 先创建视频任务
const videoResult = await client.createVideo({...});
const taskId = videoResult.data.id || videoResult.data.task_id;

// 等待任务完成
const completed = await client.waitForTask(taskId);

// 从已完成的任务创建角色
const character = await client.createCharacter({
  from_task: taskId,
  timestamps: '1,3'
});
```

### 问题 3: 查询任务返回 HTML

**现象**: 查询任务状态返回 HTML 而不是 JSON

**原因**: 使用了错误的查询端点

**解决方案**:
```javascript
// 聚鑫平台
GET /v1/video/query?id={taskId}

// 贞贞平台
GET /v2/videos/generations/{taskId}
```

### 问题 4: 频繁出现 429 错误

**现象**: 轮询任务状态时频繁返回 429 Rate Limit

**原因**: 轮询间隔太短

**解决方案**: 将轮询间隔增加到 30 秒
```javascript
const POLL_INTERVAL = 30000;  // 30秒
const TIMEOUT = 600000;       // 10分钟
```

### 问题 5: 前端一直显示 "Creating..."

**现象**: 创建视频后前端一直显示加载中

**原因**: 后端使用了 `spawn` 导致阻塞

**解决方案**: 改用 `await fetch()` 或 `await axios()`

### 问题 6: Claude Code 不读取规则文件

**现象**: Claude Code 没有加载 `.claude/rules/` 中的规则

**解决方案**:
1. 确保 Claude Code 在项目根目录启动
2. 检查 `settings.json` 格式是否正确
3. 尝试重启 Claude Code

### 问题 7: 角色引用不生效 ⭐ 新增

**现象**: 使用角色引用后视频没有使用该角色

**原因**: 使用了错误的格式 `@{username}`

**解决方案**: 使用正确格式 `@username`（不带花括号）
```javascript
// ✅ 正确
const prompt = '@6f2dbf2b3.zenwhisper 在工地上干活';

// ❌ 错误
const prompt = '@{6f2dbf2b3.zenwhisper} 在工地上干活';
```

### 问题 8: 备份导入失败 "无效的备份文件格式" ⭐ 新增

**现象**: 导入之前导出的备份文件时，提示"无效的备份文件格式"

**原因**: 导出的备份文件包含 API 响应包装 `{success: true, data: {...}}`，但导入验证期望纯备份格式

**解决方案**: 导入功能已支持双格式兼容
```javascript
// 处理两种格式：
// 1. 导出时的格式：{success: true, data: {version: ..., data: {...}}}
// 2. 纯备份格式：{version: ..., data: {...}}

let backupData = JSON.parse(fileContent);

// 自动提取实际数据
if (backupData.success && backupData.data) {
  backupData = backupData.data;
}
```

**备份文件格式**:
```json
{
  "success": true,
  "data": {
    "version": "1.0",
    "timestamp": "2025-12-29T13:05:30.148Z",
    "data": {
      "history": [...],
      "characters": [...]
    }
  }
}
```

### 问题 9: 生成的视频与参考图片不符 ⭐ 新增

**现象**: 使用参考图片生成的视频内容与图片不匹配

**原因**: 提示词未描述图片内容，使用了通用提示词

**解决方案**: 先分析图片内容，再写相关性强的提示词
```javascript
// ❌ 错误：使用通用提示词
const prompt = '一个可爱的猫咪在花园里玩耍，阳光明媚';
// 问题：图片是卡通垃圾车，但提示词描述的是猫咪

// ✅ 正确：先分析图片，再写相关提示词
// 使用图片分析工具识别：黄色车头、绿色车身、可爱表情、城市街道、卡通风格
const prompt = '一辆卡通风格的垃圾车在城市街道上行驶，黄色车头、绿色车身，' +
               '车头有可爱的表情（大眼睛、微笑、腮红），车斗通过机械臂抬起正在作业，' +
               '晴朗天气，卡通插画风格';
```

**提示词结构建议**:
1. **主体**: 画面中的主要角色/物体
2. **外观**: 颜色、形状、表情、姿态
3. **动作**: 正在做什么
4. **环境**: 背景场景、周围物体
5. **氛围**: 光线、色调、风格

### 问题 10: 故事板镜头图片丢失 ⭐ 新增

**现象**: 故事板模式中配置的镜头图片未生效

**原因**:
- 前端未收集 `shot.image` 字段
- 后端未将镜头图片合并到 `images` 数组

**解决方案**:
```javascript
// 前端：正确收集镜头图片
const shots = [];
document.querySelectorAll('.shot-item').forEach(item => {
  const duration = item.querySelector('.shot-duration').value;
  const scene = item.querySelector('.shot-scene').value.trim();
  const image = item.querySelector('.shot-image').value.trim();

  if (scene) {
    const shotData = {
      duration: parseFloat(duration),
      scene: scene
    };
    // 如果有参考图片，添加到镜头数据中
    if (image) {
      shotData.image = image;
    }
    shots.push(shotData);
  }
});

// 后端：收集所有镜头的图片
async createStoryboardVideo(options) {
  const { shots, images = [] } = options;

  // 收集所有镜头的参考图片
  const allImages = [...images];
  shots.forEach((shot) => {
    if (shot.image) {
      allImages.push(shot.image);
    }
  });

  // 使用合并后的图片数组
  const body = {
    model,
    prompt,
    images: allImages,  // 包含所有镜头的图片
    watermark,
    private: isPrivate,
  };
}
```

#### 27. 节点连接验证修复 (2026-01-01) ⭐ Bug 修复
- **问题描述**: 未连接或连接到错误类型的节点仍然响应事件
  - **具体场景**: 画布上有两个TaskResultNode，一个连接到VideoGenerateNode，另一个未连接任何节点，但未连接的节点在任务提交时也显示执行了任务
  - **影响范围**: 所有结果节点（TaskResultNode, CharacterResultNode等）
- **根本原因**:
  1. **App.jsx**: 在设置 `connectedSourceId` 时没有验证源节点类型
  2. **事件监听器**: 只检查 `connectedSourceId === sourceNodeId`，不检查节点类型
  3. **事件广播机制**: `window.dispatchEvent` 是全局广播，所有监听器都会收到事件
- **修复内容**:
  1. 为所有输入端口添加源节点类型验证
  2. 清除无效连接的数据
  3. 确保事件系统正确隔离
- **修复文件**:
  - `src/client/src/App.jsx` - Lines 218-299（所有输入端口添加源节点类型验证）
  - `src/client/src/nodes/output/TaskResultNode.jsx` - Lines 9, 105-117（导入 getNodes，事件处理器添加源节点类型验证）
- **输入端口节点类型映射**:
  - `task-input`: 只接受 `videoGenerateNode`, `storyboardNode`, `characterCreateNode`
  - `character-input`: 只接受 `characterLibraryNode`
  - `prompt-input`: 只接受 `textNode`
  - `images-input`: 只接受 `referenceImageNode`
  - `api-config`: 只接受 `apiSettingsNode`
- **验证结果**: ✅ 未连接的节点不响应事件，只有正确连接的节点显示任务
- **验证截图**: `用户输入文件夹/开发对话/验证修复-未连接节点不响应.png`
- **相关文档**: SKILL.md 错误26, code.md 错误26

#### 28. 平台参数传递修复和配置更新 (2026-01-01) ⭐ Bug 修复 + 配置更新
- **问题描述1**: 任务在后台显示成功，但前端TaskResultNode一直显示"查询中..."
  - **具体场景**: 用贞贞平台提交的任务，轮询时硬编码 `platform=juxin`，导致查询错误的API端点
  - **后台测试**: `platform=zhenzhen` 查询成功返回结果，`platform=juxin` 返回304 Not Modified
- **问题描述2**: 模型名称显示问题
  - 聚鑫平台通知 sora2 模型更名为 "sora-2-all"
  - 贞贞平台保持原名不变
  - 项目显示名称需要更新
- **根本原因**:
  1. **事件系统缺少 platform 参数**: VideoGenerateNode 派发事件时只传递 `sourceNodeId` 和 `taskId`
  2. **轮询请求硬编码平台**: TaskResultNode 轮询时硬编码 `platform=juxin`
  3. **缺少缓存破坏参数**: 请求没有添加时间戳参数，浏览器返回304 Not Modified
- **修复内容**:
  1. **平台参数传递**:
     - VideoGenerateNode 派发事件时传递 `platform: apiConfig.platform`
     - TaskResultNode 使用 useState 存储 platform，从事件中接收
  2. **动态模型名称显示**: 根据平台显示不同的模型名称
     - 聚鑫平台: 显示 "Sora-2-all"
     - 贞贞平台: 显示 "Sora-2"
  3. **缓存破坏**: 轮询和手动查询请求添加 `&_t=${Date.now()}` 参数
  4. **项目名称更新**: 从 "WinJin 工作流编辑器" 改为 "AI star视频工作台"
- **修复文件**:
  - `src/client/src/nodes/process/VideoGenerateNode.jsx` - Lines 280-283（传递 platform）
  - `src/client/src/nodes/output/TaskResultNode.jsx` - Lines 21, 102, 145, 182, 226, 275（接收和使用 platform）
  - `src/client/src/nodes/input/APISettingsNode.jsx` - Line 136（动态显示模型名称）
  - `src/client/src/App.jsx` - Line 573（更新项目名称）
- **验证结果**:
  - ✅ 贞贞平台任务使用 `platform=zhenzhen` 查询成功
  - ✅ 聚鑫平台任务使用 `platform=juxin` 查询成功
  - ✅ 浏览器不再返回304 Not Modified
  - ✅ 模型名称根据平台正确显示
  - ✅ 项目标题更新为 "AI star视频工作台"
- **测试任务**:
  - 旧任务 `video_bca7cf64` (贞贞) - ✅ 用正确平台查询成功
  - 新任务 `video_f521124e` (贞贞) - ✅ 事件正确传递 `platform: zhenzhen`
- **相关文档**: SKILL.md 错误35

#### 29. 任务进度百分比显示功能 (2026-01-01) ⭐ 功能增强
- **问题描述**: TaskResultNode 只显示 "⏳ 处理中"，无法知道具体进度
- **用户需求**: 显示任务完成的百分比进度（0-100%）
- **实现内容**:
  1. **添加 progress 状态**: `useState(data.progress || 0)` 存储 0-100 进度值
  2. **API 响应提取**: 轮询和手动刷新时从 `result.data.progress` 提取进度
  3. **UI 显示更新**: 修改 `getStatusText()` 函数显示格式为 `⏳ 处理中 45%`
- **修复文件**:
  - `src/client/src/nodes/output/TaskResultNode.jsx`
    - Line 23-24: 添加 progress 状态
    - Lines 188-196: 轮询函数提取 progress 字段
    - Lines 286-294: 手动刷新函数提取 progress 字段
    - Lines 342-351: `getStatusText()` 函数接受 progressValue 参数
    - Line 464: UI 传递 progress 参数到 `getStatusText()`
- **验证结果**:
  - ✅ 后端 API 响应包含 progress 字段：`{progress: 100, status: "SUCCESS"}`
  - ✅ 已完成任务显示 "✓ 完成"（progress = 100）
  - ✅ 代码修改不影响其他节点（仅组件内部显示逻辑）
  - ✅ 工作流菜单功能验证正常
- **Git 提交**: `0eb887b feat: 显示任务进度百分比`
- **相关文档**: SKILL.md 开发提示 19

#### 30. TaskResultNode platform 自动检测修复 (2026-01-01) ⭐ Bug 修复
- **问题描述**: 旧任务查询 API 返回 400 错误，无法获取视频信息
- **根本原因**:
  - localStorage 保存的旧任务没有 `platform` 字段
  - TaskResultNode 初始化使用默认值 `'juxin'`
  - 贞贞平台的任务用聚鑫端点查询导致 400 错误
  - VideoGenerateNode 显示"贞贞"但 TaskResultNode 查询用 `platform=juxin`
- **用户报告**: "9714这个任务，后台显示已经成功，但是节点没有看到新视频"
- **实现内容**:
  1. **添加 useEffect 1.5**: 自动从连接的 VideoGenerateNode 检测 platform
  2. **条件触发**: 只在 platform 为 undefined 或 'juxin' 时执行
  3. **同步更新**: 同时更新内部状态和 node.data
  4. **向后兼容**: 自动修复旧数据，无需手动干预
  5. **持久化修复**: 更新的 node.data 自动保存到 localStorage
- **修复文件**:
  - `src/client/src/nodes/output/TaskResultNode.jsx`
    - Lines 47-52: useEffect 1 总是尝试恢复 platform
    - Lines 118-140: useEffect 1.5 自动检测和修复 platform
- **验证结果**:
  - ✅ 旧任务 `video_f8317d47` 正确查询 API：`platform=zhenzhen`
  - ✅ 成功获取本地视频：`/downloads/4cf0d493-1810-4c3a-9caf-ff851e82deca.mp4`
  - ✅ 控制台日志：`[TaskResultNode] Detected platform from connected VideoGenerateNode: zhenzhen`
  - ✅ 无需手动删除旧任务，自动向后兼容
- **Git 提交**: `18fc091 fix: TaskResultNode auto-detect platform from connected VideoGenerateNode`
- **相关文档**:
  - SKILL.md: 错误模式 38，开发提示 22
  - code.md: 错误模式 38
  - 截图验证: `用户输入文件夹/开发对话/platform-fix-verification.png`

---

## 快速参考

### 环境变量速查

```bash
SORA2_API_KEY=sk-xxxxx      # 聚鑫平台 API Key
ZHENZHEN_API_KEY=sk-xxxxx   # 贞贞平台 API Key
PORT=9000                    # 服务器端口
```

### 关键端口

- HTTP 服务器: `http://localhost:9000`
- 健康检查: `http://localhost:9000/health`

### 数据文件位置

- 历史记录: `data/history.json`
- 角色库: `data/characters.json`
- 视频下载: `downloads/`

### 参考文档

- 开发经验: `reference/用户输入文件夹/开发经验/Sora2_Character_Best_Practices.md`
- 聚鑫 API: `reference/用户输入文件夹/聚鑫sora2/`
- 贞贞 API: `reference/用户输入文件夹/贞贞工坊/`

### 角色引用语法速查 ⭐ 新增

```
@username 提示词内容

示例：
@6f2dbf2b3.zenwhisper 在工地上干活
@783316a1d.diggyloade 在工地上干活
```

**注意**:
- 所有平台统一格式
- 不使用花括号
- 角色引用和提示词之间用空格隔开

### 双平台差异速查 ⭐ 新增

| 项目 | 聚鑫平台 | 贞贞平台 |
|------|----------|----------|
| 查询端点 | `/v1/video/query?id={taskId}` | `/v2/videos/generations/{taskId}` |
| 响应格式 | `{ id: "video_xxx" }` | `{ task_id: "video_xxx" }` |
| 兼容处理 | `result.data.id \|\| result.data.task_id` | 同左 |

---

## 联系方式

- 项目仓库: https://github.com/leon30083/wenjing-aigc.git
- 问题反馈: GitHub Issues

---

**最后更新**: 2026-01-01
**维护者**: WinJin AIGC Team
**版本**: v3.3
