<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WinJin AIGC - è§†é¢‘ç”Ÿæˆ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      background: rgba(255, 255, 255, 0.95);
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      color: #333;
      font-size: 28px;
      margin-bottom: 8px;
    }

    .header p {
      color: #666;
      font-size: 14px;
    }

    .platform-selector {
      margin-top: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .platform-selector label {
      font-weight: 600;
      color: #555;
    }

    .platform-selector select {
      padding: 8px 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
    }

    .tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }

    .tab {
      padding: 12px 24px;
      background: rgba(255, 255, 255, 0.9);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      color: #555;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .tab:hover {
      background: rgba(255, 255, 255, 1);
      transform: translateY(-2px);
    }

    .tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .tab-content {
      display: none;
      background: rgba(255, 255, 255, 0.95);
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .tab-content.active {
      display: block;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-group textarea {
      min-height: 120px;
      resize: vertical;
    }

    .form-row {
      display: flex;
      gap: 16px;
    }

    .form-row .form-group {
      flex: 1;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .result-box {
      margin-top: 20px;
      padding: 16px;
      border-radius: 8px;
      display: none;
    }

    .result-box.success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .result-box.error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .result-box.show {
      display: block;
    }

    .shots-container {
      margin-top: 16px;
    }

    .shot-item {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
      align-items: flex-start;
    }

    .shot-item input {
      flex: 1;
    }

    .shot-item input[type='number'] {
      flex: 0 0 100px;
    }

    .shot-item button {
      padding: 8px 16px;
      background: #f0f0f0;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .shot-item button:hover {
      background: #e0e0e0;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 20px;
    }

    .loading.show {
      display: block;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .video-preview {
      margin-top: 16px;
    }

    .video-preview video {
      max-width: 100%;
      border-radius: 8px;
    }

    /* å†å²è®°å½•æ ·å¼ */
    .history-item {
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.2s;
    }

    .history-item:hover {
      background: #f0f1f3;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .history-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .history-item-title {
      font-weight: 600;
      color: #333;
      flex: 1;
    }

    .history-item-status {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .history-item-status.completed {
      background: #d4edda;
      color: #155724;
    }

    .history-item-status.failed {
      background: #f8d7da;
      color: #721c24;
    }

    .history-item-status.queued,
    .history-item-status.processing {
      background: #fff3cd;
      color: #856404;
    }

    .history-item-prompt {
      color: #555;
      font-size: 14px;
      margin-bottom: 8px;
      line-height: 1.5;
    }

    .history-item-meta {
      display: flex;
      gap: 16px;
      font-size: 12px;
      color: #777;
      flex-wrap: wrap;
    }

    .history-item-meta span {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .history-item-task-id {
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 11px;
      word-break: break-all;
    }

    .history-item-video {
      margin-top: 12px;
    }

    .history-item-video video {
      max-width: 100%;
      border-radius: 8px;
    }

    .history-empty {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 13px;
    }

    /* Character Library Styles */
    .character-library-item {
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.2s;
    }

    .character-library-item:hover {
      background: #f0f1f3;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .character-library-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .character-library-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
    }

    .character-library-id {
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 11px;
      word-break: break-all;
      color: #666;
    }

    .character-library-meta {
      display: flex;
      gap: 16px;
      margin-bottom: 12px;
      font-size: 13px;
      color: #666;
    }

    .character-library-meta span {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .character-library-avatar {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      object-fit: cover;
      margin-bottom: 12px;
    }

    .character-library-actions {
      display: flex;
      gap: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ¬ WinJin AIGC</h1>
      <p>Sora2 è§†é¢‘ç”Ÿæˆå·¥å…· - æ”¯æŒèšé‘«/è´è´åŒå¹³å°</p>
      <div class="platform-selector">
        <label for="platform-select">é€‰æ‹©å¹³å°ï¼š</label>
        <select id="platform-select">
          <option value="juxin">èšé‘« (api.jxincm.cn)</option>
          <option value="zhenzhen">è´è´ (ai.t8star.cn)</option>
        </select>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="video">æ–‡ç”Ÿè§†é¢‘</button>
      <button class="tab" data-tab="storyboard">æ•…äº‹æ¿ï¼ˆæ‰¹é‡ï¼‰</button>
      <button class="tab" data-tab="character">åˆ›å»ºè§’è‰²</button>
      <button class="tab" data-tab="character-library">è§’è‰²åº“</button>
      <button class="tab" data-tab="task">æŸ¥è¯¢ä»»åŠ¡</button>
      <button class="tab" data-tab="history">å†å²è®°å½•</button>
    </div>

    <!-- æ–‡ç”Ÿè§†é¢‘ -->
    <div class="tab-content active" id="video-tab">
      <div class="form-group">
        <label for="video-prompt">æç¤ºè¯</label>
        <textarea id="video-prompt" placeholder="æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„è§†é¢‘å†…å®¹..."></textarea>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="video-model">æ¨¡å‹</label>
          <select id="video-model">
            <option value="sora-2">Sora-2</option>
            <option value="sora-2-pro">Sora-2 Pro</option>
          </select>
        </div>
        <div class="form-group">
          <label for="video-orientation">ç”»é¢æ–¹å‘</label>
          <select id="video-orientation">
            <option value="landscape">æ¨ªå± (16:9)</option>
            <option value="portrait">ç«–å± (9:16)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="video-duration">æ—¶é•¿ï¼ˆç§’ï¼‰</label>
          <select id="video-duration">
            <option value="10">10ç§’</option>
            <option value="15">15ç§’</option>
            <option value="25">25ç§’</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="video-size">åˆ†è¾¨ç‡</label>
          <select id="video-size">
            <option value="small">æ ‡æ¸…</option>
            <option value="large">é«˜æ¸…</option>
          </select>
        </div>
        <div class="form-group">
          <label for="video-watermark">æ°´å°</label>
          <select id="video-watermark">
            <option value="false">æ— æ°´å°</option>
            <option value="true">æœ‰æ°´å°</option>
          </select>
        </div>
      </div>
      <button class="btn btn-primary" id="video-create-btn">åˆ›å»ºè§†é¢‘</button>
      <div class="loading" id="video-loading">
        <div class="spinner"></div>
        <p>æ­£åœ¨åˆ›å»ºè§†é¢‘...</p>
      </div>
      <div class="result-box" id="video-result"></div>
    </div>

    <!-- æ•…äº‹æ¿ -->
    <div class="tab-content" id="storyboard-tab">
      <div class="form-group">
        <label>é•œå¤´åˆ—è¡¨</label>
        <div class="shots-container" id="shots-container">
          <div class="shot-item">
            <input type="number" placeholder="æ—¶é•¿(ç§’)" value="5" class="shot-duration" />
            <input type="text" placeholder="åœºæ™¯æè¿°" class="shot-scene" />
            <button class="btn-remove-shot">åˆ é™¤</button>
          </div>
        </div>
        <button class="btn btn-secondary" id="add-shot-btn" style="margin-top: 12px;">+ æ·»åŠ é•œå¤´</button>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="storyboard-model">æ¨¡å‹</label>
          <select id="storyboard-model">
            <option value="sora-2">Sora-2</option>
            <option value="sora-2-pro">Sora-2 Pro</option>
          </select>
        </div>
        <div class="form-group">
          <label for="storyboard-orientation">ç”»é¢æ–¹å‘</label>
          <select id="storyboard-orientation">
            <option value="landscape">æ¨ªå± (16:9)</option>
            <option value="portrait">ç«–å± (9:16)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="storyboard-size">åˆ†è¾¨ç‡</label>
          <select id="storyboard-size">
            <option value="small">æ ‡æ¸…</option>
            <option value="large">é«˜æ¸…</option>
          </select>
        </div>
      </div>
      <button class="btn btn-primary" id="storyboard-create-btn">åˆ›å»ºæ•…äº‹æ¿è§†é¢‘</button>
      <div class="loading" id="storyboard-loading">
        <div class="spinner"></div>
        <p>æ­£åœ¨åˆ›å»ºæ•…äº‹æ¿è§†é¢‘...</p>
      </div>
      <div class="result-box" id="storyboard-result"></div>
    </div>

    <!-- åˆ›å»ºè§’è‰² -->
    <div class="tab-content" id="character-tab">
      <div class="form-group">
        <label for="character-url">è§†é¢‘é“¾æ¥</label>
        <input type="text" id="character-url" placeholder="è¾“å…¥è§†é¢‘ URL..." />
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="character-start">å¼€å§‹æ—¶é—´ï¼ˆç§’ï¼‰</label>
          <input type="number" id="character-start" value="1" min="0" step="0.1" />
        </div>
        <div class="form-group">
          <label for="character-end">ç»“æŸæ—¶é—´ï¼ˆç§’ï¼‰</label>
          <input type="number" id="character-end" value="3" min="0" step="0.1" />
        </div>
      </div>
      <p style="color: #666; font-size: 13px; margin-bottom: 16px;">
        æ³¨æ„ï¼šæ—¶é—´èŒƒå›´å·®å€¼å¿…é¡»æ˜¯ 1-3 ç§’
      </p>
      <button class="btn btn-primary" id="character-create-btn">åˆ›å»ºè§’è‰²</button>
      <div class="loading" id="character-loading">
        <div class="spinner"></div>
        <p>æ­£åœ¨åˆ›å»ºè§’è‰²...</p>
      </div>
      <div class="result-box" id="character-result"></div>
    </div>

    <!-- è§’è‰²åº“ -->
    <div class="tab-content" id="character-library-tab">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h2 style="font-size: 18px; color: #333;">è§’è‰²åº“</h2>
        <div>
          <input type="text" id="character-search" placeholder="æœç´¢è§’è‰²..." style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 8px; margin-right: 8px; width: 200px;">
          <button class="btn btn-secondary" id="character-refresh-btn" style="padding: 8px 16px;">åˆ·æ–°</button>
          <button class="btn btn-secondary" id="character-stats-btn" style="padding: 8px 16px;">ç»Ÿè®¡</button>
        </div>
      </div>
      <div class="loading" id="character-library-loading">
        <div class="spinner"></div>
        <p>æ­£åœ¨åŠ è½½...</p>
      </div>
      <div id="character-library-list"></div>
      <div class="result-box" id="character-library-stats"></div>
    </div>

    <!-- æŸ¥è¯¢ä»»åŠ¡ -->
    <div class="tab-content" id="task-tab">
      <div class="form-group">
        <label for="task-id">ä»»åŠ¡ ID</label>
        <input type="text" id="task-id" placeholder="è¾“å…¥ä»»åŠ¡ ID..." />
      </div>
      <button class="btn btn-primary" id="task-query-btn">æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€</button>
      <div class="loading" id="task-loading">
        <div class="spinner"></div>
        <p>æ­£åœ¨æŸ¥è¯¢...</p>
      </div>
      <div class="result-box" id="task-result"></div>
      <div class="video-preview" id="video-preview"></div>
    </div>

    <!-- å†å²è®°å½• -->
    <div class="tab-content" id="history-tab">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h2 style="font-size: 18px; color: #333;">å†å²è®°å½•</h2>
        <div>
          <button class="btn btn-secondary" id="history-refresh-btn" style="padding: 8px 16px;">åˆ·æ–°</button>
          <button class="btn btn-secondary" id="history-stats-btn" style="padding: 8px 16px;">ç»Ÿè®¡</button>
        </div>
      </div>
      <div class="loading" id="history-loading">
        <div class="spinner"></div>
        <p>æ­£åœ¨åŠ è½½...</p>
      </div>
      <div id="history-list"></div>
      <div class="result-box" id="history-stats-result"></div>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:9000/api';
    let currentPlatform = 'juxin';

    // å¹³å°åˆ‡æ¢
    document.getElementById('platform-select').addEventListener('change', (e) => {
      currentPlatform = e.target.value;
      console.log('Switched to platform:', currentPlatform);
    });

    // æ ‡ç­¾é¡µåˆ‡æ¢
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
      });
    });

    // é€šç”¨ç»“æœæ˜¾ç¤º
    function showResult(elementId, success, message, data) {
      const resultBox = document.getElementById(elementId);
      resultBox.className = `result-box ${success ? 'success' : 'error'} show`;
      let html = `<strong>${success ? 'æˆåŠŸ' : 'å¤±è´¥'}</strong><br>${message}`;
      if (data && success) {
        html += `<br><pre>${JSON.stringify(data, null, 2)}</pre>`;
      }
      resultBox.innerHTML = html;
    }

    // é€šç”¨åŠ è½½çŠ¶æ€
    function setLoading(loadingId, btnId, loading) {
      const loadingEl = document.getElementById(loadingId);
      const btn = document.getElementById(btnId);
      if (loading) {
        loadingEl.classList.add('show');
        btn.disabled = true;
      } else {
        loadingEl.classList.remove('show');
        btn.disabled = false;
      }
    }

    // åˆ›å»ºè§†é¢‘
    document.getElementById('video-create-btn').addEventListener('click', async () => {
      const prompt = document.getElementById('video-prompt').value.trim();
      if (!prompt) {
        showResult('video-result', false, 'è¯·è¾“å…¥æç¤ºè¯');
        return;
      }

      setLoading('video-loading', 'video-create-btn', true);

      try {
        const response = await fetch(`${API_BASE}/video/create`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            platform: currentPlatform,
            prompt: prompt,
            model: document.getElementById('video-model').value,
            orientation: document.getElementById('video-orientation').value,
            duration: parseInt(document.getElementById('video-duration').value),
            size: document.getElementById('video-size').value,
            watermark: document.getElementById('video-watermark').value === 'true',
            private: true,
            images: [],
          }),
        });

        const result = await response.json();
        showResult('video-result', result.success, result.error || 'ä»»åŠ¡å·²åˆ›å»º', result.data);
      } catch (error) {
        showResult('video-result', false, `ç½‘ç»œé”™è¯¯: ${error.message}`);
      } finally {
        setLoading('video-loading', 'video-create-btn', false);
      }
    });

    // æ•…äº‹æ¿ - æ·»åŠ /åˆ é™¤é•œå¤´
    document.getElementById('add-shot-btn').addEventListener('click', () => {
      const container = document.getElementById('shots-container');
      const shotItem = document.createElement('div');
      shotItem.className = 'shot-item';
      shotItem.innerHTML = `
        <input type="number" placeholder="æ—¶é•¿(ç§’)" value="5" class="shot-duration" />
        <input type="text" placeholder="åœºæ™¯æè¿°" class="shot-scene" />
        <button class="btn-remove-shot">åˆ é™¤</button>
      `;
      container.appendChild(shotItem);
      shotItem.querySelector('.btn-remove-shot').addEventListener('click', () => {
        shotItem.remove();
      });
    });

    document.querySelectorAll('.btn-remove-shot').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.target.closest('.shot-item').remove();
      });
    });

    // åˆ›å»ºæ•…äº‹æ¿è§†é¢‘
    document.getElementById('storyboard-create-btn').addEventListener('click', async () => {
      const shots = [];
      document.querySelectorAll('.shot-item').forEach(item => {
        const duration = item.querySelector('.shot-duration').value;
        const scene = item.querySelector('.shot-scene').value.trim();
        if (scene) {
          shots.push({ duration: parseFloat(duration), scene });
        }
      });

      if (shots.length === 0) {
        showResult('storyboard-result', false, 'è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªé•œå¤´');
        return;
      }

      setLoading('storyboard-loading', 'storyboard-create-btn', true);

      try {
        const response = await fetch(`${API_BASE}/video/storyboard`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            platform: currentPlatform,
            shots: shots,
            model: document.getElementById('storyboard-model').value,
            orientation: document.getElementById('storyboard-orientation').value,
            size: document.getElementById('storyboard-size').value,
            watermark: false,
            private: true,
            images: [],
          }),
        });

        const result = await response.json();
        showResult('storyboard-result', result.success, result.error || 'æ•…äº‹æ¿ä»»åŠ¡å·²åˆ›å»º', result.data);
      } catch (error) {
        showResult('storyboard-result', false, `ç½‘ç»œé”™è¯¯: ${error.message}`);
      } finally {
        setLoading('storyboard-loading', 'storyboard-create-btn', false);
      }
    });

    // åˆ›å»ºè§’è‰²
    document.getElementById('character-create-btn').addEventListener('click', async () => {
      const url = document.getElementById('character-url').value.trim();
      const start = document.getElementById('character-start').value;
      const end = document.getElementById('character-end').value;

      if (!url) {
        showResult('character-result', false, 'è¯·è¾“å…¥è§†é¢‘é“¾æ¥');
        return;
      }

      const timestamps = `${start},${end}`;
      const diff = end - start;
      if (diff < 1 || diff > 3) {
        showResult('character-result', false, 'æ—¶é—´èŒƒå›´å·®å€¼å¿…é¡»æ˜¯ 1-3 ç§’');
        return;
      }

      setLoading('character-loading', 'character-create-btn', true);

      try {
        const response = await fetch(`${API_BASE}/character/create`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            platform: currentPlatform,
            url: url,
            timestamps: timestamps,
          }),
        });

        const result = await response.json();
        showResult('character-result', result.success, result.error || 'è§’è‰²åˆ›å»ºæˆåŠŸ', result.data);
        if (result.success) {
          // åˆ·æ–°è§’è‰²åº“
          loadCharacterLibrary();
        }
      } catch (error) {
        showResult('character-result', false, `ç½‘ç»œé”™è¯¯: ${error.message}`);
      } finally {
        setLoading('character-loading', 'character-create-btn', false);
      }
    });

    // ä»å†å²è®°å½•åˆ›å»ºè§’è‰²ï¼ˆä½¿ç”¨ from_task å‚æ•°ï¼‰
    async function createCharacterFromTask(taskId, platform) {
      const timestamps = '1,3'; // é»˜è®¤ä½¿ç”¨ 1-3 ç§’

      if (!confirm(`è¦ä»ä»»åŠ¡ ${taskId} åˆ›å»ºè§’è‰²å—ï¼Ÿ\n\nä½¿ç”¨æ—¶é—´èŒƒå›´: 1-3ç§’`)) {
        return;
      }

      // æ˜¾ç¤ºåŠ è½½æç¤º
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'result-box show';
      loadingDiv.style.background = '#fff3cd';
      loadingDiv.style.color = '#856404';
      loadingDiv.innerHTML = '<div class="spinner-inline"></div> æ­£åœ¨åˆ›å»ºè§’è‰²...';
      document.body.appendChild(loadingDiv);

      try {
        const response = await fetch(`${API_BASE}/character/create`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            platform: platform,
            from_task: taskId,
            timestamps: timestamps,
          }),
        });

        const result = await response.json();

        // ç§»é™¤åŠ è½½æç¤º
        document.body.removeChild(loadingDiv);

        if (result.success) {
          alert(`âœ… è§’è‰²åˆ›å»ºæˆåŠŸï¼\n\nè§’è‰²ID: ${result.data.id}\nç”¨æˆ·å: ${result.data.username}\n\nå·²è‡ªåŠ¨ä¿å­˜åˆ°è§’è‰²åº“ã€‚`);
          // åˆ·æ–°è§’è‰²åº“
          loadCharacterLibrary();
        } else {
          alert(`âŒ è§’è‰²åˆ›å»ºå¤±è´¥\n\n${result.error}`);
        }
      } catch (error) {
        document.body.removeChild(loadingDiv);
        alert(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
      }
    }

    // æŸ¥è¯¢ä»»åŠ¡
    document.getElementById('task-query-btn').addEventListener('click', async () => {
      const taskId = document.getElementById('task-id').value.trim();
      if (!taskId) {
        showResult('task-result', false, 'è¯·è¾“å…¥ä»»åŠ¡ ID');
        return;
      }

      setLoading('task-loading', 'task-query-btn', true);
      document.getElementById('video-preview').innerHTML = '';

      try {
        const response = await fetch(`${API_BASE}/task/${taskId}?platform=${currentPlatform}`);
        const result = await response.json();

        if (result.success && result.data) {
          const data = result.data;
          let message = `çŠ¶æ€: ${data.status}`;
          if (data.status === 'SUCCESS' && data.data?.output) {
            message += '<br>è§†é¢‘å·²ç”Ÿæˆå®Œæˆï¼';
            document.getElementById('video-preview').innerHTML = `
              <video controls src="${data.data.output}"></video>
            `;
          } else if (data.status === 'FAILURE') {
            message += `<br>å¤±è´¥åŸå› : ${data.fail_reason || 'æœªçŸ¥é”™è¯¯'}`;
          }
          showResult('task-result', true, message, data);
        } else {
          showResult('task-result', false, result.error || 'æŸ¥è¯¢å¤±è´¥');
        }
      } catch (error) {
        showResult('task-result', false, `ç½‘ç»œé”™è¯¯: ${error.message}`);
      } finally {
        setLoading('task-loading', 'task-query-btn', false);
      }
    });

    // ==================== å†å²è®°å½• ====================

    // çŠ¶æ€æ–‡æœ¬æ˜ å°„
    const statusTextMap = {
      'queued': 'ç­‰å¾…ä¸­',
      'processing': 'å¤„ç†ä¸­',
      'completed': 'å·²å®Œæˆ',
      'failed': 'å¤±è´¥',
    };

    // åŠ è½½å†å²è®°å½•
    async function loadHistory() {
      document.getElementById('history-loading').classList.add('show');
      document.getElementById('history-list').innerHTML = '';
      document.getElementById('history-stats-result').classList.remove('show');

      try {
        const response = await fetch(`${API_BASE}/history/list`);
        const result = await response.json();

        if (result.success && result.data) {
          const records = result.data;
          if (records.length === 0) {
            document.getElementById('history-list').innerHTML = `
              <div class="history-empty">
                <p>æš‚æ— å†å²è®°å½•</p>
              </div>
            `;
          } else {
            displayHistoryRecords(records);
          }
        } else {
          document.getElementById('history-list').innerHTML = `
            <div class="history-empty">
              <p style="color: #721c24;">åŠ è½½å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}</p>
            </div>
          `;
        }
      } catch (error) {
        document.getElementById('history-list').innerHTML = `
          <div class="history-empty">
            <p style="color: #721c24;">ç½‘ç»œé”™è¯¯: ${error.message}</p>
          </div>
        `;
      } finally {
        document.getElementById('history-loading').classList.remove('show');
      }
    }

    // æ˜¾ç¤ºå†å²è®°å½•åˆ—è¡¨
    function displayHistoryRecords(records) {
      const container = document.getElementById('history-list');
      let html = '';

      records.forEach(record => {
        const statusText = statusTextMap[record.status] || record.status;
        const statusClass = record.status;
        const createdAt = new Date(record.createdAt).toLocaleString('zh-CN');
        const platformName = record.platform === 'juxin' ? 'èšé‘«' : 'è´è´';
        const isCompleted = record.status === 'completed' || record.status === 'SUCCESS';

        html += `
          <div class="history-item">
            <div class="history-item-header">
              <div class="history-item-title">
                <span style="color: #667eea;">[${platformName}]</span>
                ${record.model}
              </div>
              <span class="history-item-status ${statusClass}">${statusText}</span>
            </div>
            <div class="history-item-prompt">${record.prompt}</div>
            <div class="history-item-meta">
              <span>ğŸ“… ${createdAt}</span>
              <span class="history-item-task-id">ğŸ†” ${record.taskId}</span>
            </div>
            ${record.result?.output ? `
              <div class="history-item-video">
                <video controls src="${record.result.output}" style="max-height: 300px;"></video>
              </div>
            ` : ''}
            ${isCompleted ? `
              <div style="margin-top: 12px; display: flex; gap: 8px;">
                <button class="btn btn-sm btn-secondary" onclick="createCharacterFromTask('${record.taskId}', '${record.platform}')">ğŸ‘¤ åˆ›å»ºè§’è‰²</button>
                <button class="btn btn-sm btn-secondary" onclick="copyToClipboard('${record.taskId}')">å¤åˆ¶ID</button>
              </div>
            ` : ''}
            ${record.error ? `<div style="color: #721c24; font-size: 13px; margin-top: 8px;">âŒ ${record.error}</div>` : ''}
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // åˆ·æ–°æŒ‰é’®
    document.getElementById('history-refresh-btn').addEventListener('click', loadHistory);

    // ç»Ÿè®¡æŒ‰é’®
    document.getElementById('history-stats-btn').addEventListener('click', async () => {
      try {
        const response = await fetch(`${API_BASE}/history/stats`);
        const result = await response.json();

        if (result.success && result.data) {
          const stats = result.data;
          showResult('history-stats-result', true, `
            <strong>ç»Ÿè®¡ä¿¡æ¯</strong><br>
            æ€»è®°å½•æ•°: ${stats.total}<br>
            å·²å®Œæˆ: ${stats.byStatus.completed || 0}<br>
            å¤±è´¥: ${stats.byStatus.failed || 0}<br>
            ç­‰å¾…ä¸­: ${stats.byStatus.queued || 0}<br>
            å·²ä¸‹è½½: ${stats.downloaded || 0}
          `);
        } else {
          showResult('history-stats-result', false, result.error || 'è·å–ç»Ÿè®¡å¤±è´¥');
        }
      } catch (error) {
        showResult('history-stats-result', false, `ç½‘ç»œé”™è¯¯: ${error.message}`);
      }
    });

    // åˆ‡æ¢åˆ°å†å²è®°å½•æ ‡ç­¾æ—¶è‡ªåŠ¨åŠ è½½
    document.querySelector('[data-tab="history"]').addEventListener('click', () => {
      loadHistory();
    });

    // ==================== è§’è‰²åº“ ====================

    /**
     * åŠ è½½è§’è‰²åº“åˆ—è¡¨
     */
    async function loadCharacterLibrary() {
      document.getElementById('character-library-loading').classList.add('show');
      document.getElementById('character-library-list').innerHTML = '';
      document.getElementById('character-library-stats').innerHTML = '';

      try {
        const response = await fetch(`${API_BASE}/character/list`);
        const result = await response.json();
        document.getElementById('character-library-loading').classList.remove('show');

        if (result.success && result.data) {
          displayCharacterLibrary(result.data);
        } else {
          showResult('character-library-stats', false, result.error || 'åŠ è½½å¤±è´¥');
        }
      } catch (error) {
        document.getElementById('character-library-loading').classList.remove('show');
        showResult('character-library-stats', false, `ç½‘ç»œé”™è¯¯: ${error.message}`);
      }
    }

    /**
     * æ˜¾ç¤ºè§’è‰²åº“åˆ—è¡¨
     */
    function displayCharacterLibrary(characters) {
      const container = document.getElementById('character-library-list');

      if (!characters || characters.length === 0) {
        container.innerHTML = '<div class="history-empty">æš‚æ— è§’è‰²</div>';
        return;
      }

      let html = '';
      characters.forEach(character => {
        const createdAt = new Date(character.createdAt).toLocaleString('zh-CN');
        const platformName = character.platform === 'juxin' ? 'èšé‘«' : 'è´è´';

        html += `
          <div class="character-library-item">
            <div class="character-library-header">
              <div>
                <div class="character-library-title">${character.username || 'æœªçŸ¥ç”¨æˆ·'}</div>
                <div class="character-library-id">ğŸ†” ${character.id}</div>
              </div>
              <div class="character-library-actions">
                <button class="btn btn-sm btn-secondary" onclick="copyToClipboard('${character.id}')">å¤åˆ¶ID</button>
                <button class="btn btn-sm btn-danger" onclick="deleteCharacter('${character.id}')">åˆ é™¤</button>
              </div>
            </div>
            ${character.profilePictureUrl ? `
              <img src="${character.profilePictureUrl}" alt="${character.username}" class="character-library-avatar">
            ` : ''}
            <div class="character-library-meta">
              <span>ğŸŒ ${platformName}</span>
              <span>ğŸ• ${character.timestamps || '1,3'}</span>
              <span>ğŸ“… ${createdAt}</span>
            </div>
            ${character.permalink ? `
              <div style="font-size: 13px; color: #666; word-break: break-all;">
                ğŸ”— <a href="${character.permalink}" target="_blank" style="color: #667eea;">${character.permalink}</a>
              </div>
            ` : ''}
            ${character.sourceVideoUrl ? `
              <div style="font-size: 13px; color: #666; word-break: break-all; margin-top: 4px;">
                ğŸ¬ æ¥æº: ${character.sourceVideoUrl}
              </div>
            ` : ''}
          </div>
        `;
      });

      container.innerHTML = html;
    }

    /**
     * åˆ é™¤è§’è‰²
     */
    async function deleteCharacter(characterId) {
      if (!confirm(`ç¡®å®šè¦åˆ é™¤è§’è‰² ${characterId} å—ï¼Ÿ`)) {
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/character/${characterId}`, {
          method: 'DELETE'
        });
        const result = await response.json();

        if (result.success) {
          showResult('character-library-stats', true, 'åˆ é™¤æˆåŠŸ');
          loadCharacterLibrary(); // é‡æ–°åŠ è½½åˆ—è¡¨
        } else {
          showResult('character-library-stats', false, result.error || 'åˆ é™¤å¤±è´¥');
        }
      } catch (error) {
        showResult('character-library-stats', false, `ç½‘ç»œé”™è¯¯: ${error.message}`);
      }
    }

    /**
     * æœç´¢è§’è‰²
     */
    async function searchCharacter(query) {
      if (!query.trim()) {
        loadCharacterLibrary();
        return;
      }

      document.getElementById('character-library-loading').classList.add('show');
      document.getElementById('character-library-list').innerHTML = '';

      try {
        const response = await fetch(`${API_BASE}/character/search/${encodeURIComponent(query)}`);
        const result = await response.json();
        document.getElementById('character-library-loading').classList.remove('show');

        if (result.success && result.data) {
          displayCharacterLibrary(result.data);
        } else {
          showResult('character-library-stats', false, result.error || 'æœç´¢å¤±è´¥');
        }
      } catch (error) {
        document.getElementById('character-library-loading').classList.remove('show');
        showResult('character-library-stats', false, `ç½‘ç»œé”™è¯¯: ${error.message}`);
      }
    }

    /**
     * æ˜¾ç¤ºè§’è‰²åº“ç»Ÿè®¡ä¿¡æ¯
     */
    async function showCharacterStats() {
      try {
        const response = await fetch(`${API_BASE}/character/stats`);
        const result = await response.json();

        if (result.success && result.data) {
          const stats = result.data;
          let message = `æ€»è§’è‰²æ•°: ${stats.total}<br><br>æŒ‰å¹³å°åˆ†å¸ƒ:<br>`;
          for (const [platform, count] of Object.entries(stats.byPlatform || {})) {
            const platformName = platform === 'juxin' ? 'èšé‘«' : 'è´è´';
            message += `  - ${platformName}: ${count}<br>`;
          }
          showResult('character-library-stats', true, message);
        } else {
          showResult('character-library-stats', false, result.error || 'è·å–ç»Ÿè®¡å¤±è´¥');
        }
      } catch (error) {
        showResult('character-library-stats', false, `ç½‘ç»œé”™è¯¯: ${error.message}`);
      }
    }

    // è§’è‰²åº“åˆ·æ–°æŒ‰é’®
    document.getElementById('character-refresh-btn').addEventListener('click', loadCharacterLibrary);

    // è§’è‰²åº“ç»Ÿè®¡æŒ‰é’®
    document.getElementById('character-stats-btn').addEventListener('click', showCharacterStats);

    // è§’è‰²åº“æœç´¢è¾“å…¥æ¡†ï¼ˆé˜²æŠ–ï¼‰
    let searchTimeout;
    document.getElementById('character-search').addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        searchCharacter(e.target.value);
      }, 500);
    });

    // åˆ‡æ¢åˆ°è§’è‰²åº“æ ‡ç­¾æ—¶è‡ªåŠ¨åŠ è½½
    document.querySelector('[data-tab="character-library"]').addEventListener('click', () => {
      loadCharacterLibrary();
    });
  </script>
</body>
</html>
