<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WinJin AIGC - è§†é¢‘ç”Ÿæˆ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      background: rgba(255, 255, 255, 0.95);
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      color: #333;
      font-size: 28px;
      margin-bottom: 8px;
    }

    .header p {
      color: #666;
      font-size: 14px;
    }

    .platform-selector {
      margin-top: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .platform-selector label {
      font-weight: 600;
      color: #555;
    }

    .platform-selector select {
      padding: 8px 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
    }

    .tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }

    .tab {
      padding: 12px 24px;
      background: rgba(255, 255, 255, 0.9);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      color: #555;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .tab:hover {
      background: rgba(255, 255, 255, 1);
      transform: translateY(-2px);
    }

    .tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .tab-content {
      display: none;
      background: rgba(255, 255, 255, 0.95);
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .tab-content.active {
      display: block;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-group textarea {
      min-height: 120px;
      resize: vertical;
    }

    .form-row {
      display: flex;
      gap: 16px;
    }

    .form-row .form-group {
      flex: 1;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .result-box {
      margin-top: 20px;
      padding: 16px;
      border-radius: 8px;
      display: none;
    }

    .result-box.success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .result-box.error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .result-box.show {
      display: block;
    }

    .shots-container {
      margin-top: 16px;
    }

    .shot-item {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
      align-items: flex-start;
    }

    .shot-item input {
      flex: 1;
    }

    .shot-item input[type='number'] {
      flex: 0 0 100px;
    }

    .shot-item button {
      padding: 8px 16px;
      background: #f0f0f0;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .shot-item button:hover {
      background: #e0e0e0;
    }

    /* å›¾ç‰‡è¾“å…¥è¡Œæ ·å¼ */
    .images-container {
      margin-top: 8px;
    }

    .image-item {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
      align-items: flex-start;
    }

    .image-item input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
    }

    .image-item input:focus {
      outline: none;
      border-color: #667eea;
    }

    .image-item button {
      padding: 8px 16px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
    }

    .image-item button:hover {
      background: #c82333;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 20px;
    }

    .loading.show {
      display: block;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .video-preview {
      margin-top: 16px;
    }

    .video-preview video {
      max-width: 100%;
      border-radius: 8px;
    }

    /* å†å²è®°å½•æ ·å¼ */
    .history-item {
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.2s;
    }

    .history-item:hover {
      background: #f0f1f3;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .history-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .history-item-title {
      font-weight: 600;
      color: #333;
      flex: 1;
    }

    .history-item-status {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .history-item-status.completed {
      background: #d4edda;
      color: #155724;
    }

    .history-item-status.failed {
      background: #f8d7da;
      color: #721c24;
    }

    .history-item-status.queued,
    .history-item-status.processing {
      background: #fff3cd;
      color: #856404;
    }

    .history-item-prompt {
      color: #555;
      font-size: 14px;
      margin-bottom: 8px;
      line-height: 1.5;
    }

    .history-item-meta {
      display: flex;
      gap: 16px;
      font-size: 12px;
      color: #777;
      flex-wrap: wrap;
    }

    .history-item-meta span {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .history-item-task-id {
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 11px;
      word-break: break-all;
    }

    .history-item-video {
      margin-top: 12px;
    }

    .history-item-video video {
      max-width: 100%;
      border-radius: 8px;
    }

    .history-empty {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 13px;
    }

    /* Character Selection Grid Styles */
    .character-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .no-character-hint {
      grid-column: 1 / -1;
      text-align: center;
      padding: 40px;
      color: #999;
      background: #f8f9fa;
      border-radius: 8px;
      border: 2px dashed #e0e0e0;
    }

    .character-card {
      background: #f8f9fa;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .character-card:hover {
      border-color: #667eea;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
      transform: translateY(-2px);
    }

    .character-card.selected {
      border-color: #667eea;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
    }

    .character-card-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 12px;
      border: 3px solid #e0e0e0;
      background: #f0f0f0;
    }

    .character-card.selected .character-card-avatar {
      border-color: #667eea;
    }

    .character-card-name {
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
      font-size: 14px;
    }

    .character-card-username {
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
      word-break: break-all;
    }

    .character-card-platform {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      background: #e0e0e0;
      color: #666;
    }

    .character-card-platform.juxin {
      background: #e3f2fd;
      color: #1976d2;
    }

    .character-card-platform.zhenzhen {
      background: #fce4ec;
      color: #c2185b;
    }

    /* Character Library Styles */
    .character-library-item {
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.2s;
    }

    .character-library-item:hover {
      background: #f0f1f3;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .character-library-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .character-library-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
    }

    .character-library-id {
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 11px;
      word-break: break-all;
      color: #666;
    }

    .character-library-meta {
      display: flex;
      gap: 16px;
      margin-bottom: 12px;
      font-size: 13px;
      color: #666;
    }

    .character-library-meta span {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .character-library-avatar {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      object-fit: cover;
      margin-bottom: 12px;
    }

    .character-library-actions {
      display: flex;
      gap: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ¬ WinJin AIGC</h1>
      <p>Sora2 è§†é¢‘ç”Ÿæˆå·¥å…· - æ”¯æŒèšé‘«/è´è´åŒå¹³å°</p>
      <div class="platform-selector">
        <label for="platform-select">é€‰æ‹©å¹³å°ï¼š</label>
        <select id="platform-select">
          <option value="juxin">èšé‘« (api.jxincm.cn)</option>
          <option value="zhenzhen">è´è´ (ai.t8star.cn)</option>
        </select>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="video">æ–‡ç”Ÿè§†é¢‘</button>
      <button class="tab" data-tab="storyboard">æ•…äº‹æ¿ï¼ˆæ‰¹é‡ï¼‰</button>
      <button class="tab" data-tab="character">åˆ›å»ºè§’è‰²</button>
      <button class="tab" data-tab="character-library">è§’è‰²åº“</button>
      <button class="tab" data-tab="task">æŸ¥è¯¢ä»»åŠ¡</button>
      <button class="tab" data-tab="history">å†å²è®°å½•</button>
      <button class="tab" data-tab="backup">å¤‡ä»½ç®¡ç†</button>
    </div>

    <!-- æ–‡ç”Ÿè§†é¢‘ -->
    <div class="tab-content active" id="video-tab">
      <div class="form-group">
        <label for="video-prompt">æç¤ºè¯</label>
        <textarea id="video-prompt" placeholder="æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„è§†é¢‘å†…å®¹..."></textarea>
      </div>
      <div class="form-group">
        <label>å‚è€ƒå›¾ç‰‡ï¼ˆå¯é€‰ï¼‰</label>
        <div class="images-container" id="video-images-container">
          <!-- å›¾ç‰‡è¾“å…¥è¡Œä¼šåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
        </div>
        <button class="btn btn-secondary" id="add-image-btn" style="margin-top: 8px; padding: 8px 16px;">+ æ·»åŠ å›¾ç‰‡</button>
        <p style="color: #666; font-size: 13px; margin-top: 8px;">
          å¦‚æœæœ‰å‚è€ƒå›¾ç‰‡ï¼Œå°†è‡ªåŠ¨ä½¿ç”¨å›¾ç”Ÿè§†é¢‘ï¼›å¦åˆ™ä½¿ç”¨æ–‡ç”Ÿè§†é¢‘
        </p>
      </div>
      <div class="form-group">
        <label>é€‰æ‹©è§’è‰²ï¼ˆå¯é€‰ï¼‰</label>
        <button class="btn btn-secondary" id="video-refresh-characters" style="margin-bottom: 12px; padding: 8px 16px;">åˆ·æ–°è§’è‰²åˆ—è¡¨</button>
        <div id="video-character-grid" class="character-grid">
          <div class="no-character-hint">æš‚æ— è§’è‰²ï¼Œè¯·å…ˆåˆ›å»ºè§’è‰²æˆ–ç‚¹å‡»åˆ·æ–°</div>
        </div>
        <p style="color: #666; font-size: 13px; margin-top: 8px;">
          é€‰æ‹©è§’è‰²åï¼Œä¼šåœ¨æç¤ºè¯ä¸­è‡ªåŠ¨æ’å…¥ @username å¼•ç”¨ï¼ˆä¸å¸¦èŠ±æ‹¬å·ï¼‰
        </p>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="video-model">æ¨¡å‹</label>
          <select id="video-model">
            <option value="sora-2">Sora-2</option>
            <option value="sora-2-pro">Sora-2 Pro</option>
          </select>
        </div>
        <div class="form-group">
          <label for="video-orientation">ç”»é¢æ–¹å‘</label>
          <select id="video-orientation">
            <option value="landscape">æ¨ªå± (16:9)</option>
            <option value="portrait">ç«–å± (9:16)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="video-duration">æ—¶é•¿ï¼ˆç§’ï¼‰</label>
          <select id="video-duration">
            <option value="10">10ç§’</option>
            <option value="15">15ç§’</option>
            <option value="25">25ç§’</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="video-size">åˆ†è¾¨ç‡</label>
          <select id="video-size">
            <option value="small">æ ‡æ¸…</option>
            <option value="large">é«˜æ¸…</option>
          </select>
        </div>
        <div class="form-group">
          <label for="video-watermark">æ°´å°</label>
          <select id="video-watermark">
            <option value="false">æ— æ°´å°</option>
            <option value="true">æœ‰æ°´å°</option>
          </select>
        </div>
      </div>
      <button class="btn btn-primary" id="video-create-btn">åˆ›å»ºè§†é¢‘</button>
      <div class="loading" id="video-loading">
        <div class="spinner"></div>
        <p>æ­£åœ¨åˆ›å»ºè§†é¢‘...</p>
      </div>
      <div class="result-box" id="video-result"></div>
    </div>

    <!-- æ•…äº‹æ¿ -->
    <div class="tab-content" id="storyboard-tab">
      <div class="form-group">
        <label>é€‰æ‹©è§’è‰²ï¼ˆå¯é€‰ï¼‰</label>
        <button class="btn btn-secondary" id="storyboard-refresh-characters" style="margin-bottom: 12px; padding: 8px 16px;">åˆ·æ–°è§’è‰²åˆ—è¡¨</button>
        <div id="storyboard-character-grid" class="character-grid">
          <div class="no-character-hint">æš‚æ— è§’è‰²ï¼Œè¯·å…ˆåˆ›å»ºè§’è‰²æˆ–ç‚¹å‡»åˆ·æ–°</div>
        </div>
        <p style="color: #666; font-size: 13px; margin-top: 8px;">
          é€‰æ‹©è§’è‰²åï¼Œä¼šåœ¨æ‰€æœ‰åœºæ™¯æè¿°ä¸­è‡ªåŠ¨æ’å…¥ @username å¼•ç”¨ï¼ˆä¸å¸¦èŠ±æ‹¬å·ï¼‰
        </p>
      </div>
      <div class="form-group">
        <label>é•œå¤´åˆ—è¡¨</label>
        <div class="shots-container" id="shots-container">
          <div class="shot-item">
            <input type="number" placeholder="æ—¶é•¿(ç§’)" value="5" class="shot-duration" />
            <input type="text" placeholder="åœºæ™¯æè¿°" class="shot-scene" />
            <input type="text" placeholder="å‚è€ƒå›¾ç‰‡URLï¼ˆå¯é€‰ï¼‰" class="shot-image" />
            <button class="btn-remove-shot">åˆ é™¤</button>
          </div>
        </div>
        <button class="btn btn-secondary" id="add-shot-btn" style="margin-top: 12px;">+ æ·»åŠ é•œå¤´</button>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="storyboard-model">æ¨¡å‹</label>
          <select id="storyboard-model">
            <option value="sora-2">Sora-2</option>
            <option value="sora-2-pro">Sora-2 Pro</option>
          </select>
        </div>
        <div class="form-group">
          <label for="storyboard-orientation">ç”»é¢æ–¹å‘</label>
          <select id="storyboard-orientation">
            <option value="landscape">æ¨ªå± (16:9)</option>
            <option value="portrait">ç«–å± (9:16)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="storyboard-size">åˆ†è¾¨ç‡</label>
          <select id="storyboard-size">
            <option value="small">æ ‡æ¸…</option>
            <option value="large">é«˜æ¸…</option>
          </select>
        </div>
      </div>
      <button class="btn btn-primary" id="storyboard-create-btn">åˆ›å»ºæ•…äº‹æ¿è§†é¢‘</button>
      <div class="loading" id="storyboard-loading">
        <div class="spinner"></div>
        <p>æ­£åœ¨åˆ›å»ºæ•…äº‹æ¿è§†é¢‘...</p>
      </div>
      <div class="result-box" id="storyboard-result"></div>
    </div>

    <!-- åˆ›å»ºè§’è‰² -->
    <div class="tab-content" id="character-tab">
      <div class="form-group">
        <label for="character-url">è§†é¢‘é“¾æ¥</label>
        <input type="text" id="character-url" placeholder="è¾“å…¥è§†é¢‘ URL..." />
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="character-start">å¼€å§‹æ—¶é—´ï¼ˆç§’ï¼‰</label>
          <input type="number" id="character-start" value="1" min="0" step="0.1" />
        </div>
        <div class="form-group">
          <label for="character-end">ç»“æŸæ—¶é—´ï¼ˆç§’ï¼‰</label>
          <input type="number" id="character-end" value="3" min="0" step="0.1" />
        </div>
      </div>
      <p style="color: #666; font-size: 13px; margin-bottom: 16px;">
        æ³¨æ„ï¼šæ—¶é—´èŒƒå›´å·®å€¼å¿…é¡»æ˜¯ 1-3 ç§’
      </p>
      <button class="btn btn-primary" id="character-create-btn">åˆ›å»ºè§’è‰²</button>
      <div class="loading" id="character-loading">
        <div class="spinner"></div>
        <p>æ­£åœ¨åˆ›å»ºè§’è‰²...</p>
      </div>
      <div class="result-box" id="character-result"></div>
    </div>

    <!-- è§’è‰²åº“ -->
    <div class="tab-content" id="character-library-tab">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h2 style="font-size: 18px; color: #333;">è§’è‰²åº“</h2>
        <div>
          <input type="text" id="character-search" placeholder="æœç´¢è§’è‰²..." style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 8px; margin-right: 8px; width: 200px;">
          <button class="btn btn-secondary" id="character-refresh-btn" style="padding: 8px 16px;">åˆ·æ–°</button>
          <button class="btn btn-secondary" id="character-stats-btn" style="padding: 8px 16px;">ç»Ÿè®¡</button>
        </div>
      </div>
      <div class="loading" id="character-library-loading">
        <div class="spinner"></div>
        <p>æ­£åœ¨åŠ è½½...</p>
      </div>
      <div id="character-library-list"></div>
      <div class="result-box" id="character-library-stats"></div>
    </div>

    <!-- æŸ¥è¯¢ä»»åŠ¡ -->
    <div class="tab-content" id="task-tab">
      <div class="form-group">
        <label for="task-id">ä»»åŠ¡ ID</label>
        <input type="text" id="task-id" placeholder="è¾“å…¥ä»»åŠ¡ ID..." />
      </div>
      <button class="btn btn-primary" id="task-query-btn">æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€</button>
      <div class="loading" id="task-loading">
        <div class="spinner"></div>
        <p>æ­£åœ¨æŸ¥è¯¢...</p>
      </div>
      <div class="result-box" id="task-result"></div>
      <div class="video-preview" id="video-preview"></div>
    </div>

    <!-- å†å²è®°å½• -->
    <div class="tab-content" id="history-tab">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h2 style="font-size: 18px; color: #333;">å†å²è®°å½•</h2>
        <div style="display: flex; gap: 8px;">
          <button class="btn btn-secondary" id="history-refresh-btn" style="padding: 8px 16px;">åˆ·æ–°</button>
          <button class="btn btn-secondary" id="history-stats-btn" style="padding: 8px 16px;">ç»Ÿè®¡</button>
          <button class="btn btn-danger" id="history-clear-btn" style="padding: 8px 16px;">æ¸…ç©ºå…¨éƒ¨</button>
        </div>
      </div>
      <div class="loading" id="history-loading">
        <div class="spinner"></div>
        <p>æ­£åœ¨åŠ è½½...</p>
      </div>
      <div id="history-list"></div>
      <div class="result-box" id="history-stats-result"></div>
    </div>

    <!-- å¤‡ä»½ç®¡ç† -->
    <div class="tab-content" id="backup-tab">
      <h2 style="font-size: 20px; color: #333; margin-bottom: 20px;">å¤‡ä»½ä¸æ¢å¤</h2>

      <!-- æ•°æ®ç»Ÿè®¡ -->
      <div class="form-group">
        <label>å½“å‰æ•°æ®ç»Ÿè®¡</label>
        <div id="backup-stats" style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-top: 8px;">
          <p style="color: #999;">æ­£åœ¨åŠ è½½...</p>
        </div>
      </div>

      <!-- å¯¼å‡ºå¤‡ä»½ -->
      <div class="form-group">
        <label>å¯¼å‡ºå¤‡ä»½</label>
        <p style="color: #666; font-size: 13px; margin-bottom: 12px;">
          å°†æ‰€æœ‰å†å²è®°å½•å’Œè§’è‰²åº“å¯¼å‡ºä¸º JSON æ–‡ä»¶ï¼Œå¯ä»¥ä¿å­˜åˆ°ä»»æ„ä½ç½®ã€‚
        </p>
        <button class="btn btn-primary" id="backup-export-btn">å¯¼å‡ºå¤‡ä»½æ–‡ä»¶</button>
      </div>

      <!-- å¯¼å…¥å¤‡ä»½ -->
      <div class="form-group">
        <label>å¯¼å…¥å¤‡ä»½</label>
        <p style="color: #666; font-size: 13px; margin-bottom: 12px;">
          ä»ä¹‹å‰å¯¼å‡ºçš„ JSON æ–‡ä»¶æ¢å¤æ•°æ®ã€‚ä¸ä¼šè¦†ç›–å·²å­˜åœ¨çš„è®°å½•ã€‚
        </p>
        <input type="file" id="backup-import-file" accept=".json" style="display: none;" />
        <button class="btn btn-secondary" id="backup-import-btn">é€‰æ‹©å¤‡ä»½æ–‡ä»¶å¹¶å¯¼å…¥</button>
        <button class="btn btn-secondary" id="backup-stats-refresh-btn" style="margin-left: 8px;">åˆ·æ–°ç»Ÿè®¡</button>
      </div>

      <!-- å¯¼å…¥ç»“æœ -->
      <div class="result-box" id="backup-result"></div>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:9000/api';
    let currentPlatform = 'juxin';

    // å¹³å°åˆ‡æ¢
    document.getElementById('platform-select').addEventListener('change', (e) => {
      currentPlatform = e.target.value;
      console.log('Switched to platform:', currentPlatform);
    });

    // æ ‡ç­¾é¡µåˆ‡æ¢
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
      });
    });

    // é€šç”¨ç»“æœæ˜¾ç¤º
    function showResult(elementId, success, message, data) {
      const resultBox = document.getElementById(elementId);
      resultBox.className = `result-box ${success ? 'success' : 'error'} show`;
      let html = `<strong>${success ? 'æˆåŠŸ' : 'å¤±è´¥'}</strong><br>${message}`;
      if (data && success) {
        html += `<br><pre>${JSON.stringify(data, null, 2)}</pre>`;
      }
      resultBox.innerHTML = html;
    }

    // é€šç”¨åŠ è½½çŠ¶æ€
    function setLoading(loadingId, btnId, loading) {
      const loadingEl = document.getElementById(loadingId);
      const btn = document.getElementById(btnId);
      if (loading) {
        loadingEl.classList.add('show');
        btn.disabled = true;
      } else {
        loadingEl.classList.remove('show');
        btn.disabled = false;
      }
    }

    // ==================== è§’è‰²å¿«é€Ÿè°ƒç”¨ ====================

    // å­˜å‚¨è§’è‰²åˆ—è¡¨å’Œé€‰ä¸­çŠ¶æ€
    let charactersList = {};
    let selectedCharacters = {
      video: null,
      storyboard: null
    };
    let lastFocusedSceneInput = null; // è®°å½•æœ€åç„¦ç‚¹çš„åœºæ™¯è¾“å…¥æ¡†

    // åŠ è½½è§’è‰²åˆ°ç½‘æ ¼
    async function loadCharactersToGrid(gridId, type) {
      try {
        const response = await fetch(`${API_BASE}/character/list`);
        const result = await response.json();

        if (result.success && result.data) {
          charactersList[type] = result.data;
          const gridElement = document.getElementById(gridId);
          if (!gridElement) return;

          // æ¸…ç©ºå¹¶é‡æ–°å¡«å……
          gridElement.innerHTML = '';

          if (result.data.length === 0) {
            gridElement.innerHTML = '<div class="no-character-hint">æš‚æ— è§’è‰²ï¼Œè¯·å…ˆåˆ›å»ºè§’è‰²æˆ–ç‚¹å‡»åˆ·æ–°</div>';
            return;
          }

          result.data.forEach(char => {
            const card = document.createElement('div');
            card.className = 'character-card';
            card.dataset.username = char.username;
            card.dataset.type = type;

            // é»˜è®¤å¤´åƒæˆ–ä½¿ç”¨è§’è‰²å¤´åƒ
            const avatarUrl = char.profilePictureUrl || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 80 80"><rect fill="%23e0e0e0" width="80" height="80"/><text x="50%" y="50%" text-anchor="middle" dy=".3em" fill="%23999" font-size="30">?</text></svg>';
            const displayName = char.alias || char.username;

            card.innerHTML = `
              <img src="${avatarUrl}" alt="${displayName}" class="character-card-avatar" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 80 80%22><rect fill=%22%23e0e0e0%22 width=%2280%22 height=%2280%22/><text x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22 font-size=%2230%22>?</text></svg>'">
              <div class="character-card-name">${displayName}</div>
              ${char.alias ? `<div class="character-card-username">@${char.username}</div>` : ''}
            `;

            // æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰é€‰ä¸­çš„è§’è‰²
            if (selectedCharacters[type] === char.username) {
              card.classList.add('selected');
            }

            // ç‚¹å‡»äº‹ä»¶
            card.addEventListener('click', () => {
              selectCharacter(type, char.username, gridId);
            });

            gridElement.appendChild(card);
          });
        }
      } catch (error) {
        console.error('åŠ è½½è§’è‰²åˆ—è¡¨å¤±è´¥:', error);
        const gridElement = document.getElementById(gridId);
        if (gridElement) {
          gridElement.innerHTML = '<div class="no-character-hint">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
        }
      }
    }

    // é€‰æ‹©è§’è‰²
    function selectCharacter(type, username, gridId) {
      // å¦‚æœç‚¹å‡»å·²é€‰ä¸­çš„è§’è‰²ï¼Œåˆ™å–æ¶ˆé€‰ä¸­
      if (selectedCharacters[type] === username) {
        selectedCharacters[type] = null;
        updateCharacterGridSelection(gridId);
        updatePromptWithCharacter(type, null);
        return;
      }

      // é€‰ä¸­æ–°è§’è‰²
      selectedCharacters[type] = username;
      updateCharacterGridSelection(gridId);
      updatePromptWithCharacter(type, username);
    }

    // æ›´æ–°è§’è‰²ç½‘æ ¼çš„é€‰ä¸­çŠ¶æ€
    function updateCharacterGridSelection(gridId) {
      const gridElement = document.getElementById(gridId);
      if (!gridElement) return;

      const cards = gridElement.querySelectorAll('.character-card');
      cards.forEach(card => {
        const cardUsername = card.dataset.username;
        if (selectedCharacters[card.dataset.type] === cardUsername) {
          card.classList.add('selected');
        } else {
          card.classList.remove('selected');
        }
      });
    }

    // æ›´æ–°æç¤ºè¯æˆ–åœºæ™¯æè¿°ä¸­çš„è§’è‰²å¼•ç”¨
    function updatePromptWithCharacter(type, username) {
      if (type === 'video') {
        const promptElement = document.getElementById('video-prompt');
        if (!promptElement) return;

        if (username) {
          // åœ¨å…‰æ ‡ä½ç½®æ’å…¥è§’è‰²å¼•ç”¨
          const start = promptElement.selectionStart;
          const end = promptElement.selectionEnd;
          const text = promptElement.value;
          const refText = `@${username} `;

          // åœ¨å…‰æ ‡ä½ç½®æ’å…¥
          promptElement.value = text.substring(0, start) + refText + text.substring(end);
          // ç§»åŠ¨å…‰æ ‡åˆ°æ’å…¥å†…å®¹ä¹‹å
          promptElement.setSelectionRange(start + refText.length, start + refText.length);
          // é‡æ–°èšç„¦
          promptElement.focus();
        }
      } else if (type === 'storyboard') {
        // ä½¿ç”¨æœ€åç„¦ç‚¹çš„åœºæ™¯è¾“å…¥æ¡†ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨å½“å‰ç„¦ç‚¹çš„
        let targetInput = lastFocusedSceneInput;
        if (!targetInput || !document.body.contains(targetInput)) {
          // å¦‚æœæ²¡æœ‰è®°å½•çš„ç„¦ç‚¹æˆ–å…ƒç´ å·²ä¸å­˜åœ¨ï¼Œå°è¯•ä½¿ç”¨å½“å‰ç„¦ç‚¹
          const activeElement = document.activeElement;
          if (activeElement && activeElement.classList.contains('shot-scene')) {
            targetInput = activeElement;
          }
        }

        if (targetInput && username) {
          const start = targetInput.selectionStart;
          const end = targetInput.selectionEnd;
          const text = targetInput.value;
          const refText = `@${username} `;

          // åœ¨å…‰æ ‡ä½ç½®æ’å…¥
          targetInput.value = text.substring(0, start) + refText + text.substring(end);
          // ç§»åŠ¨å…‰æ ‡åˆ°æ’å…¥å†…å®¹ä¹‹å
          targetInput.setSelectionRange(start + refText.length, start + refText.length);
          // é‡æ–°èšç„¦
          targetInput.focus();
        }
      }
    }

    // ä¸ºåœºæ™¯è¾“å…¥æ¡†æ·»åŠ ç„¦ç‚¹ç›‘å¬
    function setupSceneInputListeners() {
      document.querySelectorAll('.shot-scene').forEach(input => {
        // ç§»é™¤æ—§çš„ç›‘å¬å™¨ï¼ˆå¦‚æœæœ‰ï¼‰
        input.removeEventListener('focus', handleSceneFocus);
        // æ·»åŠ æ–°çš„ç›‘å¬å™¨
        input.addEventListener('focus', handleSceneFocus);
      });
    }

    // å¤„ç†åœºæ™¯è¾“å…¥æ¡†ç„¦ç‚¹äº‹ä»¶
    function handleSceneFocus(e) {
      lastFocusedSceneInput = e.target;
    }

    // æ–‡ç”Ÿè§†é¢‘ - è§’è‰²åˆ·æ–°æŒ‰é’®
    document.getElementById('video-refresh-characters').addEventListener('click', () => {
      loadCharactersToGrid('video-character-grid', 'video');
    });

    // æ•…äº‹æ¿ - è§’è‰²åˆ·æ–°æŒ‰é’®
    document.getElementById('storyboard-refresh-characters').addEventListener('click', () => {
      loadCharactersToGrid('storyboard-character-grid', 'storyboard');
    });

    // æ–‡ç”Ÿè§†é¢‘ - æ·»åŠ å›¾ç‰‡æŒ‰é’®
    document.getElementById('add-image-btn').addEventListener('click', () => {
      const container = document.getElementById('video-images-container');
      const imageItem = document.createElement('div');
      imageItem.className = 'image-item';
      imageItem.innerHTML = `
        <input type="text" placeholder="è¾“å…¥å›¾ç‰‡ URL..." />
        <button>åˆ é™¤</button>
      `;
      container.appendChild(imageItem);

      imageItem.querySelector('button').addEventListener('click', () => {
        imageItem.remove();
      });
    });

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½è§’è‰²åˆ—è¡¨
    loadCharactersToGrid('video-character-grid', 'video');
    loadCharactersToGrid('storyboard-character-grid', 'storyboard');

    // ä¸ºåˆå§‹çš„åœºæ™¯è¾“å…¥æ¡†æ·»åŠ ç„¦ç‚¹ç›‘å¬
    setupSceneInputListeners();

    // åˆ›å»ºè§†é¢‘
    document.getElementById('video-create-btn').addEventListener('click', async () => {
      const prompt = document.getElementById('video-prompt').value.trim();
      if (!prompt) {
        showResult('video-result', false, 'è¯·è¾“å…¥æç¤ºè¯');
        return;
      }

      // æ”¶é›†å›¾ç‰‡è¾“å…¥æ¡†çš„æ•°æ®
      const images = [];
      document.querySelectorAll('.image-item input').forEach(input => {
        const url = input.value.trim();
        if (url) {
          images.push(url);
        }
      });

      setLoading('video-loading', 'video-create-btn', true);

      try {
        const response = await fetch(`${API_BASE}/video/create`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            platform: currentPlatform,
            prompt: prompt,
            model: document.getElementById('video-model').value,
            orientation: document.getElementById('video-orientation').value,
            duration: parseInt(document.getElementById('video-duration').value),
            size: document.getElementById('video-size').value,
            watermark: document.getElementById('video-watermark').value === 'true',
            private: true,
            images: images,
          }),
        });

        const result = await response.json();
        const message = images.length > 0
          ? `å›¾ç”Ÿè§†é¢‘ä»»åŠ¡å·²åˆ›å»ºï¼ˆ${images.length} å¼ å‚è€ƒå›¾ç‰‡ï¼‰`
          : 'æ–‡ç”Ÿè§†é¢‘ä»»åŠ¡å·²åˆ›å»º';
        showResult('video-result', result.success, result.error || message, result.data);
      } catch (error) {
        showResult('video-result', false, `ç½‘ç»œé”™è¯¯: ${error.message}`);
      } finally {
        setLoading('video-loading', 'video-create-btn', false);
      }
    });

    // æ•…äº‹æ¿ - æ·»åŠ /åˆ é™¤é•œå¤´
    document.getElementById('add-shot-btn').addEventListener('click', () => {
      const container = document.getElementById('shots-container');
      const shotItem = document.createElement('div');
      shotItem.className = 'shot-item';
      shotItem.innerHTML = `
        <input type="number" placeholder="æ—¶é•¿(ç§’)" value="5" class="shot-duration" />
        <input type="text" placeholder="åœºæ™¯æè¿°" class="shot-scene" />
        <input type="text" placeholder="å‚è€ƒå›¾ç‰‡URLï¼ˆå¯é€‰ï¼‰" class="shot-image" />
        <button class="btn-remove-shot">åˆ é™¤</button>
      `;
      container.appendChild(shotItem);

      // ä¸ºæ–°åœºæ™¯è¾“å…¥æ¡†æ·»åŠ ç„¦ç‚¹ç›‘å¬
      const sceneInput = shotItem.querySelector('.shot-scene');
      sceneInput.addEventListener('focus', handleSceneFocus);

      shotItem.querySelector('.btn-remove-shot').addEventListener('click', () => {
        shotItem.remove();
      });
    });

    document.querySelectorAll('.btn-remove-shot').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.target.closest('.shot-item').remove();
      });
    });

    // åˆ›å»ºæ•…äº‹æ¿è§†é¢‘
    document.getElementById('storyboard-create-btn').addEventListener('click', async () => {
      const shots = [];
      document.querySelectorAll('.shot-item').forEach(item => {
        const duration = item.querySelector('.shot-duration').value;
        const scene = item.querySelector('.shot-scene').value.trim();
        const image = item.querySelector('.shot-image').value.trim();
        if (scene) {
          const shotData = {
            duration: parseFloat(duration),
            scene: scene
          };
          // å¦‚æœæœ‰å‚è€ƒå›¾ç‰‡ï¼Œæ·»åŠ åˆ°é•œå¤´æ•°æ®ä¸­
          if (image) {
            shotData.image = image;
          }
          shots.push(shotData);
        }
      });

      if (shots.length === 0) {
        showResult('storyboard-result', false, 'è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªé•œå¤´');
        return;
      }

      setLoading('storyboard-loading', 'storyboard-create-btn', true);

      try {
        const response = await fetch(`${API_BASE}/video/storyboard`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            platform: currentPlatform,
            shots: shots,
            model: document.getElementById('storyboard-model').value,
            orientation: document.getElementById('storyboard-orientation').value,
            size: document.getElementById('storyboard-size').value,
            watermark: false,
            private: true,
            images: [],
          }),
        });

        const result = await response.json();
        const shotsWithImages = shots.filter(s => s.image).length;
        const message = shotsWithImages > 0
          ? `æ•…äº‹æ¿ä»»åŠ¡å·²åˆ›å»ºï¼ˆ${shots.length} ä¸ªé•œå¤´ï¼Œ${shotsWithImages} ä¸ªå¸¦å‚è€ƒå›¾ç‰‡ï¼‰`
          : `æ•…äº‹æ¿ä»»åŠ¡å·²åˆ›å»ºï¼ˆ${shots.length} ä¸ªé•œå¤´ï¼‰`;
        showResult('storyboard-result', result.success, result.error || message, result.data);
      } catch (error) {
        showResult('storyboard-result', false, `ç½‘ç»œé”™è¯¯: ${error.message}`);
      } finally {
        setLoading('storyboard-loading', 'storyboard-create-btn', false);
      }
    });

    // åˆ›å»ºè§’è‰²
    document.getElementById('character-create-btn').addEventListener('click', async () => {
      const url = document.getElementById('character-url').value.trim();
      const start = document.getElementById('character-start').value;
      const end = document.getElementById('character-end').value;

      if (!url) {
        showResult('character-result', false, 'è¯·è¾“å…¥è§†é¢‘é“¾æ¥');
        return;
      }

      const timestamps = `${start},${end}`;
      const diff = end - start;
      if (diff < 1 || diff > 3) {
        showResult('character-result', false, 'æ—¶é—´èŒƒå›´å·®å€¼å¿…é¡»æ˜¯ 1-3 ç§’');
        return;
      }

      setLoading('character-loading', 'character-create-btn', true);

      try {
        const response = await fetch(`${API_BASE}/character/create`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            platform: currentPlatform,
            url: url,
            timestamps: timestamps,
          }),
        });

        const result = await response.json();
        showResult('character-result', result.success, result.error || 'è§’è‰²åˆ›å»ºæˆåŠŸ', result.data);
        if (result.success) {
          // åˆ·æ–°è§’è‰²åº“
          loadCharacterLibrary();
        }
      } catch (error) {
        showResult('character-result', false, `ç½‘ç»œé”™è¯¯: ${error.message}`);
      } finally {
        setLoading('character-loading', 'character-create-btn', false);
      }
    });

    // ä»å†å²è®°å½•åˆ›å»ºè§’è‰²ï¼ˆä½¿ç”¨ from_task å‚æ•°ï¼‰
    async function createCharacterFromTask(taskId, platform) {
      const timestamps = '1,3'; // é»˜è®¤ä½¿ç”¨ 1-3 ç§’

      if (!confirm(`è¦ä»ä»»åŠ¡ ${taskId} åˆ›å»ºè§’è‰²å—ï¼Ÿ\n\nä½¿ç”¨æ—¶é—´èŒƒå›´: 1-3ç§’`)) {
        return;
      }

      // æ˜¾ç¤ºåŠ è½½æç¤º
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'result-box show';
      loadingDiv.style.background = '#fff3cd';
      loadingDiv.style.color = '#856404';
      loadingDiv.innerHTML = '<div class="spinner-inline"></div> æ­£åœ¨åˆ›å»ºè§’è‰²...';
      document.body.appendChild(loadingDiv);

      try {
        const response = await fetch(`${API_BASE}/character/create`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            platform: platform,
            from_task: taskId,
            timestamps: timestamps,
          }),
        });

        const result = await response.json();

        // ç§»é™¤åŠ è½½æç¤º
        document.body.removeChild(loadingDiv);

        if (result.success) {
          alert(`âœ… è§’è‰²åˆ›å»ºæˆåŠŸï¼\n\nè§’è‰²ID: ${result.data.id}\nç”¨æˆ·å: ${result.data.username}\n\nå·²è‡ªåŠ¨ä¿å­˜åˆ°è§’è‰²åº“ã€‚`);
          // åˆ·æ–°è§’è‰²åº“
          loadCharacterLibrary();
        } else {
          alert(`âŒ è§’è‰²åˆ›å»ºå¤±è´¥\n\n${result.error}`);
        }
      } catch (error) {
        document.body.removeChild(loadingDiv);
        alert(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
      }
    }

    // æŸ¥è¯¢ä»»åŠ¡
    document.getElementById('task-query-btn').addEventListener('click', async () => {
      const taskId = document.getElementById('task-id').value.trim();
      if (!taskId) {
        showResult('task-result', false, 'è¯·è¾“å…¥ä»»åŠ¡ ID');
        return;
      }

      setLoading('task-loading', 'task-query-btn', true);
      document.getElementById('video-preview').innerHTML = '';

      try {
        const response = await fetch(`${API_BASE}/task/${taskId}?platform=${currentPlatform}`);
        const result = await response.json();

        if (result.success && result.data) {
          const data = result.data;
          let message = `çŠ¶æ€: ${data.status}`;
          if (data.status === 'SUCCESS' && data.data?.output) {
            message += '<br>è§†é¢‘å·²ç”Ÿæˆå®Œæˆï¼';
            document.getElementById('video-preview').innerHTML = `
              <video controls src="${data.data.output}"></video>
            `;
          } else if (data.status === 'FAILURE') {
            message += `<br>å¤±è´¥åŸå› : ${data.fail_reason || 'æœªçŸ¥é”™è¯¯'}`;
          }
          showResult('task-result', true, message, data);
        } else {
          showResult('task-result', false, result.error || 'æŸ¥è¯¢å¤±è´¥');
        }
      } catch (error) {
        showResult('task-result', false, `ç½‘ç»œé”™è¯¯: ${error.message}`);
      } finally {
        setLoading('task-loading', 'task-query-btn', false);
      }
    });

    // ==================== å†å²è®°å½• ====================

    // çŠ¶æ€æ–‡æœ¬æ˜ å°„
    const statusTextMap = {
      'queued': 'ç­‰å¾…ä¸­',
      'processing': 'å¤„ç†ä¸­',
      'completed': 'å·²å®Œæˆ',
      'failed': 'å¤±è´¥',
    };

    // åŠ è½½å†å²è®°å½•
    async function loadHistory() {
      document.getElementById('history-loading').classList.add('show');
      document.getElementById('history-list').innerHTML = '';
      document.getElementById('history-stats-result').classList.remove('show');

      try {
        const response = await fetch(`${API_BASE}/history/list`);
        const result = await response.json();

        if (result.success && result.data) {
          const records = result.data;
          if (records.length === 0) {
            document.getElementById('history-list').innerHTML = `
              <div class="history-empty">
                <p>æš‚æ— å†å²è®°å½•</p>
              </div>
            `;
          } else {
            displayHistoryRecords(records);
          }
        } else {
          document.getElementById('history-list').innerHTML = `
            <div class="history-empty">
              <p style="color: #721c24;">åŠ è½½å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}</p>
            </div>
          `;
        }
      } catch (error) {
        document.getElementById('history-list').innerHTML = `
          <div class="history-empty">
            <p style="color: #721c24;">ç½‘ç»œé”™è¯¯: ${error.message}</p>
          </div>
        `;
      } finally {
        document.getElementById('history-loading').classList.remove('show');
      }
    }

    // æ˜¾ç¤ºå†å²è®°å½•åˆ—è¡¨
    function displayHistoryRecords(records) {
      const container = document.getElementById('history-list');
      let html = '';

      records.forEach(record => {
        const statusText = statusTextMap[record.status] || record.status;
        const statusClass = record.status;
        const createdAt = new Date(record.createdAt).toLocaleString('zh-CN');
        const platformName = record.platform === 'juxin' ? 'èšé‘«' : 'è´è´';
        const isCompleted = record.status === 'completed' || record.status === 'SUCCESS';

        html += `
          <div class="history-item">
            <div class="history-item-header">
              <div class="history-item-title">
                <span style="color: #667eea;">[${platformName}]</span>
                ${record.model}
              </div>
              <span class="history-item-status ${statusClass}">${statusText}</span>
            </div>
            <div class="history-item-prompt">${record.prompt}</div>
            <div class="history-item-meta">
              <span>ğŸ“… ${createdAt}</span>
              <span class="history-item-task-id">ğŸ†” ${record.taskId}</span>
            </div>
            ${record.result?.output ? `
              <div class="history-item-video">
                <video controls src="${record.result.output}" style="max-height: 300px;"></video>
              </div>
            ` : ''}
            <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
              ${isCompleted ? `
                <button class="btn btn-sm btn-secondary" onclick="createCharacterFromTask('${record.taskId}', '${record.platform}')">ğŸ‘¤ åˆ›å»ºè§’è‰²</button>
                <button class="btn btn-sm btn-secondary" onclick="copyToClipboard('${record.taskId}')">å¤åˆ¶ID</button>
              ` : `
                <button class="btn btn-sm btn-primary" onclick="queryTaskStatus('${record.taskId}', '${record.platform}', this)">ğŸ”„ æŸ¥è¯¢çŠ¶æ€</button>
                <button class="btn btn-sm btn-secondary" onclick="copyToClipboard('${record.taskId}')">å¤åˆ¶ID</button>
              `}
              <button class="btn btn-sm btn-danger" onclick="deleteHistoryRecord('${record.taskId}')">ğŸ—‘ï¸ åˆ é™¤</button>
            </div>
            ${record.error ? `<div style="color: #721c24; font-size: 13px; margin-top: 8px;">âŒ ${record.error}</div>` : ''}
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // åˆ·æ–°æŒ‰é’®
    document.getElementById('history-refresh-btn').addEventListener('click', loadHistory);

    // ç»Ÿè®¡æŒ‰é’®
    document.getElementById('history-stats-btn').addEventListener('click', async () => {
      try {
        const response = await fetch(`${API_BASE}/history/stats`);
        const result = await response.json();

        if (result.success && result.data) {
          const stats = result.data;
          showResult('history-stats-result', true, `
            <strong>ç»Ÿè®¡ä¿¡æ¯</strong><br>
            æ€»è®°å½•æ•°: ${stats.total}<br>
            å·²å®Œæˆ: ${stats.byStatus.completed || 0}<br>
            å¤±è´¥: ${stats.byStatus.failed || 0}<br>
            ç­‰å¾…ä¸­: ${stats.byStatus.queued || 0}<br>
            å·²ä¸‹è½½: ${stats.downloaded || 0}
          `);
        } else {
          showResult('history-stats-result', false, result.error || 'è·å–ç»Ÿè®¡å¤±è´¥');
        }
      } catch (error) {
        showResult('history-stats-result', false, `ç½‘ç»œé”™è¯¯: ${error.message}`);
      }
    });

    // åˆ‡æ¢åˆ°å†å²è®°å½•æ ‡ç­¾æ—¶è‡ªåŠ¨åŠ è½½
    document.querySelector('[data-tab="history"]').addEventListener('click', () => {
      loadHistory();
    });

    /**
     * æ‰‹åŠ¨æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¹¶æ›´æ–°å†å²è®°å½•
     */
    async function queryTaskStatus(taskId, platform, buttonElement) {
      const originalText = buttonElement.innerHTML;
      buttonElement.disabled = true;
      buttonElement.innerHTML = 'ğŸ”„ æŸ¥è¯¢ä¸­...';

      try {
        const response = await fetch(`${API_BASE}/task/${taskId}?platform=${platform}`);
        const result = await response.json();

        if (result.success && result.data) {
          const { status, data } = result.data;

          if (status === 'SUCCESS') {
            alert(`âœ… ä»»åŠ¡å·²å®Œæˆï¼\n\nè§†é¢‘åœ°å€ï¼š${data?.output || ''}`);
            // é‡æ–°åŠ è½½å†å²è®°å½•
            loadHistory();
          } else if (status === 'FAILURE') {
            alert(`âŒ ä»»åŠ¡å¤±è´¥\n\n${data?.fail_reason || 'æœªçŸ¥é”™è¯¯'}`);
            loadHistory();
          } else {
            alert(`â³ ä»»åŠ¡å¤„ç†ä¸­\n\nå½“å‰çŠ¶æ€ï¼š${status}`);
          }
        } else {
          alert(`âŒ æŸ¥è¯¢å¤±è´¥\n\n${result.error || 'æœªçŸ¥é”™è¯¯'}`);
        }
      } catch (error) {
        alert(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
      } finally {
        buttonElement.disabled = false;
        buttonElement.innerHTML = originalText;
      }
    }

    /**
     * åˆ é™¤å•æ¡å†å²è®°å½•
     */
    async function deleteHistoryRecord(taskId) {
      // ç¡®è®¤åˆ é™¤
      if (!confirm(`ç¡®å®šè¦åˆ é™¤è¿™æ¡å†å²è®°å½•å—ï¼Ÿ\n\nä»»åŠ¡ID: ${taskId}`)) {
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/history/${taskId}`, {
          method: 'DELETE'
        });
        const result = await response.json();

        if (result.success) {
          alert('âœ… åˆ é™¤æˆåŠŸ');
          // é‡æ–°åŠ è½½å†å²è®°å½•
          loadHistory();
        } else {
          alert(`âŒ åˆ é™¤å¤±è´¥\n\n${result.error || 'æœªçŸ¥é”™è¯¯'}`);
        }
      } catch (error) {
        alert(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
      }
    }

    /**
     * æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•
     */
    async function clearAllHistory() {
      // ç¡®è®¤æ¸…ç©º
      if (!confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
        return;
      }

      // äºŒæ¬¡ç¡®è®¤
      if (!confirm('âš ï¸ å†æ¬¡ç¡®è®¤ï¼šçœŸçš„è¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ')) {
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/history/all`, {
          method: 'DELETE'
        });
        const result = await response.json();

        if (result.success) {
          alert('âœ… å·²æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•');
          // é‡æ–°åŠ è½½å†å²è®°å½•
          loadHistory();
        } else {
          alert(`âŒ æ¸…ç©ºå¤±è´¥\n\n${result.error || 'æœªçŸ¥é”™è¯¯'}`);
        }
      } catch (error) {
        alert(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
      }
    }

    // ç»‘å®šæ¸…ç©ºå…¨éƒ¨æŒ‰é’®äº‹ä»¶
    document.getElementById('history-clear-btn').addEventListener('click', clearAllHistory);

    // ==================== è§’è‰²åº“ ====================

    /**
     * åŠ è½½è§’è‰²åº“åˆ—è¡¨
     */
    async function loadCharacterLibrary() {
      document.getElementById('character-library-loading').classList.add('show');
      document.getElementById('character-library-list').innerHTML = '';
      document.getElementById('character-library-stats').innerHTML = '';

      try {
        const response = await fetch(`${API_BASE}/character/list`);
        const result = await response.json();
        document.getElementById('character-library-loading').classList.remove('show');

        if (result.success && result.data) {
          displayCharacterLibrary(result.data);
        } else {
          showResult('character-library-stats', false, result.error || 'åŠ è½½å¤±è´¥');
        }
      } catch (error) {
        document.getElementById('character-library-loading').classList.remove('show');
        showResult('character-library-stats', false, `ç½‘ç»œé”™è¯¯: ${error.message}`);
      }
    }

    /**
     * æ˜¾ç¤ºè§’è‰²åº“åˆ—è¡¨
     */
    function displayCharacterLibrary(characters) {
      const container = document.getElementById('character-library-list');

      if (!characters || characters.length === 0) {
        container.innerHTML = '<div class="history-empty">æš‚æ— è§’è‰²</div>';
        return;
      }

      let html = '';
      characters.forEach(character => {
        const createdAt = new Date(character.createdAt).toLocaleString('zh-CN');
        const platformName = character.platform === 'juxin' ? 'èšé‘«' : 'è´è´';
        const displayName = character.alias ? `${character.alias} (${character.username})` : character.username;

        html += `
          <div class="character-library-item">
            <div class="character-library-header">
              <div>
                <div class="character-library-title">${displayName || 'æœªçŸ¥ç”¨æˆ·'}</div>
                <div class="character-library-id">ğŸ†” ${character.id}</div>
              </div>
              <div class="character-library-actions">
                <button class="btn btn-sm btn-secondary" onclick="copyToClipboard('${character.id}')">å¤åˆ¶ID</button>
                <button class="btn btn-sm btn-secondary" onclick="setCharacterAlias('${character.id}', '${character.username.replace(/'/g, "\\'")}', '${character.alias || ''}')">è®¾ç½®åˆ«å</button>
                <button class="btn btn-sm btn-danger" onclick="deleteCharacter('${character.id}')">åˆ é™¤</button>
              </div>
            </div>
            ${character.profilePictureUrl ? `
              <img src="${character.profilePictureUrl}" alt="${character.username}" class="character-library-avatar">
            ` : ''}
            <div class="character-library-meta">
              <span>ğŸŒ ${platformName}</span>
              <span>ğŸ• ${character.timestamps || '1,3'}</span>
              <span>ğŸ“… ${createdAt}</span>
            </div>
            ${character.permalink ? `
              <div style="font-size: 13px; color: #666; word-break: break-all;">
                ğŸ”— <a href="${character.permalink}" target="_blank" style="color: #667eea;">${character.permalink}</a>
              </div>
            ` : ''}
            ${character.sourceVideoUrl ? `
              <div style="font-size: 13px; color: #666; word-break: break-all; margin-top: 4px;">
                ğŸ¬ æ¥æº: ${character.sourceVideoUrl}
              </div>
            ` : ''}
          </div>
        `;
      });

      container.innerHTML = html;
    }

    /**
     * åˆ é™¤è§’è‰²
     */
    async function deleteCharacter(characterId) {
      if (!confirm(`ç¡®å®šè¦åˆ é™¤è§’è‰² ${characterId} å—ï¼Ÿ`)) {
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/character/${characterId}`, {
          method: 'DELETE'
        });
        const result = await response.json();

        if (result.success) {
          showResult('character-library-stats', true, 'åˆ é™¤æˆåŠŸ');
          loadCharacterLibrary(); // é‡æ–°åŠ è½½åˆ—è¡¨
        } else {
          showResult('character-library-stats', false, result.error || 'åˆ é™¤å¤±è´¥');
        }
      } catch (error) {
        showResult('character-library-stats', false, `ç½‘ç»œé”™è¯¯: ${error.message}`);
      }
    }

    /**
     * è®¾ç½®è§’è‰²åˆ«å
     */
    async function setCharacterAlias(characterId, username, currentAlias) {
      const newAlias = prompt(
        `è®¾ç½®è§’è‰²åˆ«å\n\nç”¨æˆ·å: ${username}\n${currentAlias ? `å½“å‰åˆ«å: ${currentAlias}` : 'å½“å‰åˆ«å: æ— '}`,
        currentAlias || ''
      );

      // ç”¨æˆ·å–æ¶ˆæ“ä½œ
      if (newAlias === null) {
        return;
      }

      // å¦‚æœåˆ«åä¸ºç©ºï¼Œç¡®è®¤æ˜¯å¦æ¸…é™¤
      const aliasValue = newAlias.trim();
      if (aliasValue === '') {
        if (!confirm('ç¡®å®šè¦æ¸…é™¤åˆ«åå—ï¼Ÿ')) {
          return;
        }
      }

      try {
        const response = await fetch(`${API_BASE}/character/${characterId}/alias`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ alias: aliasValue }),
        });

        const result = await response.json();

        if (result.success) {
          showResult('character-library-stats', true, `åˆ«åå·²${aliasValue ? 'è®¾ç½®' : 'æ¸…é™¤'}æˆåŠŸ`);
          loadCharacterLibrary(); // é‡æ–°åŠ è½½åˆ—è¡¨
        } else {
          showResult('character-library-stats', false, result.error || 'è®¾ç½®åˆ«åå¤±è´¥');
        }
      } catch (error) {
        showResult('character-library-stats', false, `ç½‘ç»œé”™è¯¯: ${error.message}`);
      }
    }

    /**
     * æœç´¢è§’è‰²
     */
    async function searchCharacter(query) {
      if (!query.trim()) {
        loadCharacterLibrary();
        return;
      }

      document.getElementById('character-library-loading').classList.add('show');
      document.getElementById('character-library-list').innerHTML = '';

      try {
        const response = await fetch(`${API_BASE}/character/search/${encodeURIComponent(query)}`);
        const result = await response.json();
        document.getElementById('character-library-loading').classList.remove('show');

        if (result.success && result.data) {
          displayCharacterLibrary(result.data);
        } else {
          showResult('character-library-stats', false, result.error || 'æœç´¢å¤±è´¥');
        }
      } catch (error) {
        document.getElementById('character-library-loading').classList.remove('show');
        showResult('character-library-stats', false, `ç½‘ç»œé”™è¯¯: ${error.message}`);
      }
    }

    /**
     * æ˜¾ç¤ºè§’è‰²åº“ç»Ÿè®¡ä¿¡æ¯
     */
    async function showCharacterStats() {
      try {
        const response = await fetch(`${API_BASE}/character/stats`);
        const result = await response.json();

        if (result.success && result.data) {
          const stats = result.data;
          let message = `æ€»è§’è‰²æ•°: ${stats.total}<br><br>æŒ‰å¹³å°åˆ†å¸ƒ:<br>`;
          for (const [platform, count] of Object.entries(stats.byPlatform || {})) {
            const platformName = platform === 'juxin' ? 'èšé‘«' : 'è´è´';
            message += `  - ${platformName}: ${count}<br>`;
          }
          showResult('character-library-stats', true, message);
        } else {
          showResult('character-library-stats', false, result.error || 'è·å–ç»Ÿè®¡å¤±è´¥');
        }
      } catch (error) {
        showResult('character-library-stats', false, `ç½‘ç»œé”™è¯¯: ${error.message}`);
      }
    }

    /**
     * å¤åˆ¶æ–‡æœ¬åˆ°å‰ªè´´æ¿
     */
    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        // ç®€å•æç¤º
        const toast = document.createElement('div');
        toast.textContent = 'âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿';
        toast.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: #4caf50; color: white; padding: 12px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 10000; animation: fadeIn 0.3s;';
        document.body.appendChild(toast);
        setTimeout(() => {
          toast.style.animation = 'fadeOut 0.3s';
          setTimeout(() => document.body.removeChild(toast), 300);
        }, 2000);
      } catch (error) {
        // é™çº§æ–¹æ¡ˆ
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        try {
          document.execCommand('copy');
          alert('âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        } catch (err) {
          alert('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
        }
        document.body.removeChild(textarea);
      }
    }

    // è§’è‰²åº“åˆ·æ–°æŒ‰é’®
    document.getElementById('character-refresh-btn').addEventListener('click', loadCharacterLibrary);

    // è§’è‰²åº“ç»Ÿè®¡æŒ‰é’®
    document.getElementById('character-stats-btn').addEventListener('click', showCharacterStats);

    // è§’è‰²åº“æœç´¢è¾“å…¥æ¡†ï¼ˆé˜²æŠ–ï¼‰
    let searchTimeout;
    document.getElementById('character-search').addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        searchCharacter(e.target.value);
      }, 500);
    });

    // åˆ‡æ¢åˆ°è§’è‰²åº“æ ‡ç­¾æ—¶è‡ªåŠ¨åŠ è½½
    document.querySelector('[data-tab="character-library"]').addEventListener('click', () => {
      loadCharacterLibrary();
    });

    // ==================== å¤‡ä»½ç®¡ç† ====================

    // åŠ è½½å¤‡ä»½ç»Ÿè®¡ä¿¡æ¯
    async function loadBackupStats() {
      try {
        const response = await fetch(`${API_BASE}/backup/info`);
        const result = await response.json();

        if (result.success && result.data) {
          const stats = result.data;
          document.getElementById('backup-stats').innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
              <div style="background: white; padding: 12px; border-radius: 6px;">
                <div style="font-size: 24px; font-weight: 600; color: #667eea;">${stats.history.total}</div>
                <div style="color: #666; font-size: 13px;">å†å²è®°å½•æ€»æ•°</div>
              </div>
              <div style="background: white; padding: 12px; border-radius: 6px;">
                <div style="font-size: 24px; font-weight: 600; color: #667eea;">${stats.characters.total}</div>
                <div style="color: #666; font-size: 13px;">è§’è‰²æ€»æ•°</div>
              </div>
              <div style="background: white; padding: 12px; border-radius: 6px;">
                <div style="font-size: 24px; font-weight: 600; color: #4caf50;">${stats.history.completed}</div>
                <div style="color: #666; font-size: 13px;">å·²å®Œæˆè§†é¢‘</div>
              </div>
              <div style="background: white; padding: 12px; border-radius: 6px;">
                <div style="font-size: 24px; font-weight: 600; color: #ff9800;">${stats.history.queued + stats.history.processing}</div>
                <div style="color: #666; font-size: 13px;">å¾…å¤„ç†/å¤„ç†ä¸­</div>
              </div>
            </div>
            <div style="margin-top: 12px; color: #999; font-size: 12px;">
              æœ€åæ›´æ–°: ${new Date(stats.timestamp).toLocaleString('zh-CN')}
            </div>
          `;
        } else {
          document.getElementById('backup-stats').innerHTML = `<p style="color: #f44336;">åŠ è½½å¤±è´¥: ${result.error}</p>`;
        }
      } catch (error) {
        document.getElementById('backup-stats').innerHTML = `<p style="color: #f44336;">ç½‘ç»œé”™è¯¯: ${error.message}</p>`;
      }
    }

    // å¯¼å‡ºå¤‡ä»½
    async function exportBackup() {
      try {
        const response = await fetch(`${API_BASE}/backup/export`);
        const result = await response.json();

        if (result.success && result.data) {
          // åˆ›å»º JSON æ–‡ä»¶å¹¶è§¦å‘ä¸‹è½½
          const dataStr = JSON.stringify(result, null, 2);
          const dataBlob = new Blob([dataStr], { type: 'application/json' });
          const url = URL.createObjectURL(dataBlob);
          const link = document.createElement('a');
          const filename = `winjin-backup-${new Date().toISOString().split('T')[0]}.json`;

          link.href = url;
          link.download = filename;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);

          showResult('backup-result', true, `å¤‡ä»½å·²å¯¼å‡º: ${filename}`);
        } else {
          showResult('backup-result', false, result.error || 'å¯¼å‡ºå¤±è´¥');
        }
      } catch (error) {
        showResult('backup-result', false, `ç½‘ç»œé”™è¯¯: ${error.message}`);
      }
    }

    // å¯¼å…¥å¤‡ä»½
    async function importBackup(file) {
      if (!file) return;

      try {
        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            let backupData = JSON.parse(e.target.result);

            // å¤„ç†ä¸¤ç§æ ¼å¼ï¼š
            // 1. å¯¼å‡ºæ—¶çš„æ ¼å¼ï¼š{success: true, data: {version: ..., data: {...}}}
            // 2. çº¯å¤‡ä»½æ ¼å¼ï¼š{version: ..., data: {...}}
            if (backupData.success && backupData.data) {
              // å¯¼å‡ºæ ¼å¼ï¼Œæå–å®é™…æ•°æ®
              backupData = backupData.data;
            }

            // éªŒè¯å¤‡ä»½æ•°æ®æ ¼å¼
            if (!backupData.data || !backupData.version) {
              showResult('backup-result', false, 'æ— æ•ˆçš„å¤‡ä»½æ–‡ä»¶æ ¼å¼');
              return;
            }

            const response = await fetch(`${API_BASE}/backup/import`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(backupData.data),
            });

            const result = await response.json();

            if (result.success) {
              const { data } = result;
              let message = result.message;

              if (data.history.errors.length > 0 || data.characters.errors.length > 0) {
                message += '\\n\\néƒ¨åˆ†æ•°æ®å¯¼å…¥å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°è¯¦æƒ…';
                console.warn('å¯¼å…¥é”™è¯¯:', data.history.errors, data.characters.errors);
              }

              showResult('backup-result', true, message);
              loadBackupStats(); // åˆ·æ–°ç»Ÿè®¡
            } else {
              showResult('backup-result', false, result.error || 'å¯¼å…¥å¤±è´¥');
            }
          } catch (error) {
            showResult('backup-result', false, `è§£æå¤‡ä»½æ–‡ä»¶å¤±è´¥: ${error.message}`);
          }
        };

        reader.readAsText(file);
      } catch (error) {
        showResult('backup-result', false, `è¯»å–æ–‡ä»¶å¤±è´¥: ${error.message}`);
      }
    }

    // å¤‡ä»½äº‹ä»¶ç»‘å®š
    document.getElementById('backup-export-btn').addEventListener('click', exportBackup);

    document.getElementById('backup-import-btn').addEventListener('click', () => {
      document.getElementById('backup-import-file').click();
    });

    document.getElementById('backup-import-file').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        if (confirm(`ç¡®å®šè¦å¯¼å…¥å¤‡ä»½æ–‡ä»¶ "${file.name}" å—ï¼Ÿ\\n\\næ³¨æ„ï¼šåªä¼šå¯¼å…¥ä¸å­˜åœ¨çš„è®°å½•ï¼Œä¸ä¼šè¦†ç›–å·²æœ‰æ•°æ®ã€‚`)) {
          importBackup(file);
        }
      }
      // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©ï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
      e.target.value = '';
    });

    document.getElementById('backup-stats-refresh-btn').addEventListener('click', loadBackupStats);

    // åˆ‡æ¢åˆ°å¤‡ä»½æ ‡ç­¾æ—¶è‡ªåŠ¨åŠ è½½ç»Ÿè®¡
    document.querySelector('[data-tab="backup"]').addEventListener('click', () => {
      loadBackupStats();
    });
  </script>
</body>
</html>
