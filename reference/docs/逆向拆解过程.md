# 文镜AIGC 逆向拆解过程

## 环境检查
- 系统：Microsoft Windows 11 专业版 10.0.26200
- GPU：NVIDIA GeForce RTX 5070 Ti（Driver 32.0.15.8157）
- 兼容性提示：RTX 5070 Ti 的 sm_120 架构与标准 PyTorch 不兼容，ComfyUI 动态验证优先走 CPU/代理或远程兼容 GPU。

## 资产清单与关键文件
- 可执行体：`文镜AIGC.exe`（长度 57.6 MB，未签名，非 .NET）
- 媒体工具：`ffmpeg.exe`（长度 78.6 MB）
- 数据库：`aigc.sqlite`（SQLite 3）
- 扩展：`doubao/manifest.json`、`doubao/background.js`、`doubao/comm.js`、`doubao/script.js`
- 本地 HTTP 记录与节点词典：`http/*`
- 日志：`log/2025-11-21/log.txt`
- 素材：`video/*`、`audio/*`、`base/*`、`role/*`

## 浏览器扩展契约
- 注入范围与权限：`doubao/manifest.json:15-20`
- 关闭最新标签页消息：`doubao/background.js:21-26`
- 存储初始化：`doubao/background.js:27-30`
- 与本地服务交互：`doubao/comm.js:91-139`（`GET http://localhost:9000/{param}`，`POST http://localhost:9000`，`type` 为 `kimi/doubao`）

## ComfyUI 协议与节点
- Prompt 结构样例：`http/127.0.0.1_8188_prompt.txt:3`
- 关键节点：
  - KSampler：`http/127.0.0.1_8188_object_info_KSampler.txt:5`
  - VAEDecode：`http/127.0.0.1_8188_object_info_VAEDecode.txt:5`
  - UNETLoader：`http/127.0.0.1_8188_object_info_UNETLoader.txt:5`
  - DualCLIPLoader：`http/127.0.0.1_8188_object_info_DualCLIPLoader.txt:5`

## 数据库结构（节选）
- `APIs(ID, APIChannel, APIClass, APIUse, Key, Model, Name, Url)`
- `APITasks(ID, APIClass, IDApp, IDCustom, IDTask, ImageUrl, Prompt, Status, TimeStart, APIChannel, APIUse, Key, Model, Name, Url)`
- 其他：`Audios`、`Effects`、`Humans`、`Infos`、`Layers`、`Servers` 等（来源 `aigc.sqlite`）
- 敏感字段处理：所有 Key/Url 在报告中脱敏。

## 日志线索
- 模块事件：`log/2025-11-21/log.txt:2-9` 显示 `CModularSettingUpdateComfy` 成功事件（编码异常待二次解码）。

## 初步架构与数据流
- 主程序（任务编排/入库）⇄ 本地服务（9000）⇄ 扩展（注入自动化）⇄ ComfyUI（8188 prompt）⇄ ffmpeg 合成 ⇄ 媒体产物（video/audio）
- 外部 AI API：如 `api.siliconflow.cn`，用于文案/角色分析（密钥与路由脱敏）。

## 已完成步骤与结果摘要
- 环境与二进制初步检测：确认系统与 GPU；`文镜AIGC.exe` 非 .NET、未签名，获取基本文件信息。
- 可执行体字符串采样：对文件头/尾各 4MB 进行关键词（`http/asar/electron/node.dll` 等）扫描，未检出显著字符串痕迹，后续考虑更深入的资源/导入表分析。
- 扩展与 ComfyUI：梳理注入点、消息行为与节点词典，形成协议说明。
- 数据库：确认 SQLite 结构与关键表，标注敏感字段脱敏。

## 端口与动态依赖现状
- 本地端口扫描（9000/8188）：当前未见监听进程，说明扩展本地服务与 ComfyUI 未在运行。
- 计划：先完成协议与工作流结构还原，动态验证改用最小无状态模拟；当服务可用时再进行联调取证。

## ComfyUI 接口连通性
- 尝试 `POST http://127.0.0.1:8188/object_info/KSampler`：当前不可达或超时。
- 结论：ComfyUI 服务未运行；将通过已有 `http/*` 记录进行协议与节点词典重建，后续在服务可用时执行联调。

### 协议样例（ComfyUI prompt）
```json
{
  "client_id": "...",
  "prompt": {
    "3": {"_meta": {"title": "加载图像"}, "class_type": "LoadImage", "inputs": {"image": "31.png"}},
    "86": {"_meta": {"title": "Remove Background (RMBG)"}, "class_type": "RMBG", "inputs": {"background": "white", "image": ["3",0], "invert_output": false, "mask_blur": 0, "mask_offset": 0, "model": "RMBG-2.0", "optimize": "default", "process_res": 1024, "refine_foreground": false, "sensitivity": 1}},
    "90": {"_meta": {"title": "Get Image Size"}, "class_type": "GetImageSize", "inputs": {"image": ["3",0]}},
    "85": {"_meta": {"title": "预览图像"}, "class_type": "PreviewImage", "inputs": {"images": ["86",0]}}
  }
}
```

### 协议样例（扩展本地服务）
```http
GET http://localhost:9000/<param>
POST http://localhost:9000
Content-Type: application/json
Body: {"type": "doubao" | "kimi", ...}
```

### 外部 API（脱敏示例，仅结构）
```http
POST https://api.siliconflow.cn/v1/chat/completions
Authorization: Bearer <TOKEN>
Content-Type: application/json
Body: {"model": "...", "messages": [{"role": "system", "content": "..."}, {"role": "user", "content": "..."}]}
```
> 说明：实际 `TOKEN` 与模型配置保存在数据库表 `APIs/APITasks` 中，报告中全部脱敏。

## 动态试运行与进程模块
- 启动主程序 2.5s 后采集：PID 显示为 `11656`，未观察到直接子进程。
- 已加载系统模块显示具备 GPU/网络/媒体能力（如 `nvml.dll`、`WINHTTP.dll`、`MFReadWrite.dll`、`d3d11.dll` 等）。
- 已安全终止主进程，避免残留占用。

### 初步技术栈推断
- 非 Electron：运行期未见 `chrome_elf.dll`、`libGLESv2.dll`、`d3dcompiler_47.dll` 等 Electron 常见模块。
- 非 .NET：`AssemblyName` 解析失败；未见常见 CLR 模块加载。
- 倾向原生 C/C++ Win32 应用，结合 Media Foundation（MF*）、D3D11 与 NVML（NVIDIA 管理库）。

## 待执行与注意
- 二进制深入类型判定与资源提取（Electron/.NET/原生进一步确认）。
- 扩展 `script.js` 解混淆与事件选择器映射。
- ComfyUI 最小工作流（CPU/代理）验证与产物路径记录。
- ffmpeg 参数复原与最小合成脚本演示。

## MVP 计划与最小复现步骤（无状态）
1. 协议复原：基于 `http/*` 的 `prompt` 与 `object_info_*` 形成 ComfyUI 节点规范与典型负载。
2. 扩展契约：参照 `doubao/comm.js` 的 `GET/POST` 约定，定义最小本地服务路由（模拟返回值，不依赖真实服务）。
3. 媒体管线：用 `ffmpeg.exe` 构造最小合成命令（图片→视频或音频合成），验证素材生命周期与输出路径。
4. 文档固化：记录每一步的命令、协议与产物位置；待 9000/8188 服务可用时执行端到端联调。

### ffmpeg 最小合成验证

### ComfyUI 最小工作流执行取证
- 提交工作流：`LoadImage(1.jpg) → RMBG → SaveImage(filename_prefix=API)`
- 接口调用：`POST /prompt` 返回 `prompt_id`，随后 `GET /history/<prompt_id>`
- 本次结果：
  - `prompt_id`: `7b11970b-0ea7-48fa-a855-b12e6376856a`
  - `status`: `success`
  - `outputs`: `API_00001_.png`，`type: output`，`subfolder: ''`
- 结论：输出文件已保存至 ComfyUI `output` 目录，接口契约与最小工作流验证通过。

### ComfyUI 批量工作流执行取证（1.jpg-8.jpg）
- 工作流：`LoadImage → RMBG → SaveImage(filename_prefix=API_BATCH)`
- 结果映射：
  - 1.jpg → `prompt_id=acb530b5-f092-4c2a-ae3b-894b6e4414ef` → `API_BATCH_00009_.png`
  - 2.jpg → `prompt_id=1c659e3a-6195-4167-b086-cc13ede694fe` → `API_BATCH_00010_.png`
  - 3.jpg → `prompt_id=1cd16e55-bc03-4b5b-9c7b-2b7c00252f30` → `API_BATCH_00011_.png`
  - 4.jpg → `prompt_id=c847810a-11c7-4aab-a076-bfd86fddfc50` → `API_BATCH_00012_.png`
  - 5.jpg → `prompt_id=99a9c1e2-4f0d-4936-86c2-827021ddd5c9` → `API_BATCH_00013_.png`
  - 6.jpg → `prompt_id=fb216c5c-aac4-4511-91f5-2893f7791bf4` → `API_BATCH_00014_.png`
  - 7.jpg → `prompt_id=6ab2d24a-8a5b-4283-83d3-ffaad2a137c3` → `API_BATCH_00015_.png`
  - 8.jpg → `prompt_id=1987ed67-706d-44e6-afd7-3e8cb841c79a` → `API_BATCH_00016_.png`
- 命令示例：
  - `ffmpeg -y -loop 1 -framerate 30 -i <image> -i <audio> -t 5 -vf scale=1280:-2,format=yuv420p -c:v libx264 -r 30 -c:a aac -b:a 128k -shortest <out>`
- 本次验证：
  - 输入：`2025-11-17_22_24_36_15/base/246.png`、`2025-11-17_22_24_36_15/audio/66.wav`
  - 输出：`temp/demo.mp4`
  - 结果：成功，验证媒体管线可独立运行。