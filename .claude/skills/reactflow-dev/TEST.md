# React Flow 流式画布自动化测试

> **用途**: 自动化测试 React Flow 工作流编辑器
> **使用工具**: MCP Chrome DevTools
> **测试环境**: http://localhost:5173

---

## 测试准备

### 1. 启动服务

```bash
# 终端 1：启动后端服务器
npm run server

# 终端 2：启动流式画布
cd src/client
npm run dev
```

### 2. 验证服务启动

```bash
# 检查后端健康状态
curl http://localhost:9000/health

# 检查前端服务
curl http://localhost:5173
```

---

## 测试用例

### 测试 1: 页面加载测试

**目的**: 验证流式画布页面正常加载

**步骤**:
1. 打开浏览器访问 `http://localhost:5173`
2. 等待页面完全加载
3. 检查 console 是否有错误
4. 验证页面标题正确

**预期结果**:
- ✅ 页面正常显示
- ✅ 无 console 错误
- ✅ 页面标题显示 "⚡ AI star视频工作台"

---

### 测试 2: 节点显示测试

**目的**: 验证所有默认节点正常显示

**步骤**:
1. 加载页面后查看画布
2. 检查初始节点是否显示
3. 验证节点数量正确（9个节点）

**预期结果**:
- ✅ 文本节点显示
- ✅ 参考图片节点显示
- ✅ 角色库节点显示
- ✅ API 设置节点显示
- ✅ 视频生成节点显示
- ✅ 角色创建节点显示
- ✅ 故事板节点显示
- ✅ 任务结果节点显示
- ✅ 角色结果节点显示

---

### 测试 3: 节点连接测试

**目的**: 验证节点之间的连线正常显示

**步骤**:
1. 查看画布上的连线
2. 验证初始连接存在
3. 检查连接方向正确

**预期结果**:
- ✅ 文本节点 → 视频生成节点（text-output → prompt-input）
- ✅ 视频生成节点 → 任务结果节点（video-output → task-input）

---

### 测试 4: 添加节点测试

**目的**: 验证可以通过菜单添加新节点

**步骤**:
1. 点击 "添加节点" 按钮
2. 选择 "📝 文本节点"
3. 验证新节点添加到画布

**预期结果**:
- ✅ 下拉菜单正常显示
- ✅ 点击菜单项后添加节点
- ✅ 新节点出现在画布上
- ✅ 节点 ID 递增

---

### 测试 5: 删除节点测试

**目的**: 验证可以删除选中的节点

**步骤**:
1. 点击选择一个节点
2. 点击 "删除选中" 按钮
3. 验证节点被删除

**预期结果**:
- ✅ 节点被选中（高亮显示）
- ✅ 点击删除按钮后节点消失
- ✅ 相关连线也被删除

---

### 测试 6: 工作流保存测试

**目的**: 验证工作流可以保存到 localStorage

**步骤**:
1. 添加或删除一些节点
2. 点击 "工作流" → "另存为..."
3. 输入工作流名称
4. 点击保存

**预期结果**:
- ✅ 对话框正常显示
- ✅ 输入名称后可以保存
- ✅ 保存成功提示显示
- ✅ localStorage 中有数据

---

### 测试 7: 工作流加载测试

**目的**: 验证可以加载已保存的工作流

**步骤**:
1. 点击 "工作流" → "打开工作流..."
2. 选择一个已保存的工作流
3. 点击 "打开"

**预期结果**:
- ✅ 工作流列表对话框显示
- ✅ 可以选择工作流
- ✅ 点击打开后加载工作流
- ✅ 画布显示正确的节点和连线

---

### 测试 8: 角色库节点测试

**目的**: 验证角色库节点可以加载和选择角色

**步骤**:
1. 点击角色库节点
2. 等待角色列表加载
3. 选择一个角色
4. 验证选中状态

**预期结果**:
- ✅ 节点正常显示
- ✅ 角色列表加载
- ✅ 可以选择角色
- ✅ 选中状态有视觉反馈

---

### 测试 9: 文本节点测试

**目的**: 验证文本节点可以输入和显示文本

**步骤**:
1. 点击文本节点
2. 在输入框中输入文本
3. 验证文本显示

**预期结果**:
- ✅ 输入框正常显示
- ✅ 可以输入文本
- ✅ 文本正确显示

---

### 测试 10: API 设置节点测试

**目的**: 验证 API 设置节点可以配置 API

**步骤**:
1. 点击 API 设置节点
2. 检查配置选项
3. 修改配置

**预期结果**:
- ✅ 节点正常显示
- ✅ 平台选择下拉框工作
- ✅ 模型选择下拉框工作
- ✅ 配置可以保存

---

## 自动化测试脚本

### MCP Chrome DevTools 测试

```javascript
// 测试 1: 页面加载
await page.goto('http://localhost:5173');
await page.waitForSelector('.react-flow');
const title = await page.title();
console.assert(title.includes('AI star'), '页面标题不正确');

// 测试 2: 检查 console 错误
const logs = await page.evaluate(() => {
  return window.performance.getEntriesByType('navigation')
    .map(nav => nav.name)
    .filter(name => name === 'error');
});
console.assert(logs.length === 0, '发现 console 错误');

// 测试 3: 检查节点数量
const nodeCount = await page.evaluate(() => {
  return document.querySelectorAll('.react-flow__node').length;
});
console.assert(nodeCount === 9, `节点数量不正确，期望 9，实际 ${nodeCount}`);

// 测试 4: 检查连线数量
const edgeCount = await page.evaluate(() => {
  return document.querySelectorAll('.react-flow__edge').length;
});
console.assert(edgeCount === 2, `连线数量不正确，期望 2，实际 ${edgeCount}`);
```

---

## 测试报告

### 测试结果模板

```markdown
# React Flow 流式画布测试报告

**测试日期**: 2026-01-08
**测试环境**: http://localhost:5173
**测试人员**: Claude Code Automation

## 测试结果汇总

| 测试用例 | 状态 | 备注 |
|---------|------|------|
| 页面加载测试 | ✅ 通过 | - |
| 节点显示测试 | ✅ 通过 | - |
| 节点连接测试 | ✅ 通过 | - |
| 添加节点测试 | ✅ 通过 | - |
| 删除节点测试 | ✅ 通过 | - |
| 工作流保存测试 | ✅ 通过 | - |
| 工作流加载测试 | ✅ 通过 | - |
| 角色库节点测试 | ⚠️ 部分通过 | 角色列表加载慢 |
| 文本节点测试 | ✅ 通过 | - |
| API 设置节点测试 | ✅ 通过 | - |

**通过率**: 90% (9/10)

## 发现的问题

### 问题 1: 角色列表加载慢
- **严重程度**: 低
- **影响**: 用户体验
- **建议**: 添加加载状态提示

## 测试截图

- [ ] 页面加载完成
- [ ] 节点显示
- [ ] 节点连接
- [ ] 工作流列表
```

---

## 持续集成

### 自动化测试命令

```bash
# 运行所有测试
npm run test:workflow

# 生成测试报告
npm run test:report

# 运行并生成覆盖率报告
npm run test:coverage
```

---

**最后更新**: 2026-01-08
**维护者**: WinJin AIGC Team
**版本**: v1.0.0
